<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥åº·ç»Ÿè®¡æ•°æ®éªŒè¯</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #409eff;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e4e7ed;
            border-radius: 6px;
        }
        .test-section h3 {
            color: #303133;
            margin-top: 0;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #66b1ff;
        }
        .success {
            background: #67c23a;
        }
        .success:hover {
            background: #85ce61;
        }
        .warning {
            background: #e6a23c;
        }
        .warning:hover {
            background: #ebb563;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #409eff;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            border-left-color: #f56c6c;
            background: #fef0f0;
            color: #f56c6c;
        }
        .success-result {
            border-left-color: #67c23a;
            background: #f0f9ff;
            color: #67c23a;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .chart-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-box {
            flex: 1;
            min-height: 300px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ æ™ºæ…§åŒ»å…»å¹³å° - å¥åº·ç»Ÿè®¡æ•°æ®éªŒè¯</h1>
        
        <div class="test-section">
            <h3>ğŸ“Š å®æ—¶å¥åº·ç»Ÿè®¡æ•°æ®</h3>
            <button onclick="loadHealthStatistics()">è·å–å¥åº·ç»Ÿè®¡</button>
            <button onclick="loadElderlyData()" class="success">è·å–è€äººæ•°æ®</button>
            <button onclick="analyzeAgeDistribution()" class="warning">åˆ†æå¹´é¾„åˆ†å¸ƒ</button>
            <div id="statsResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ å¹´é¾„æ®µå¥åº·åˆ†å¸ƒå¯è§†åŒ–</h3>
            <button onclick="renderAgeHealthChart()">æ¸²æŸ“åˆ†å¸ƒå›¾è¡¨</button>
            <button onclick="compareWithExpected()" class="success">å¯¹æ¯”é¢„æœŸç»“æœ</button>
            <div class="chart-container">
                <div id="ageHealthChart" class="chart-box"></div>
                <div id="healthStatusChart" class="chart-box"></div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æ•°æ®è¯¦ç»†åˆ†æ</h3>
            <button onclick="showDetailedAnalysis()">è¯¦ç»†åˆ†æ</button>
            <button onclick="validateMappingLogic()" class="warning">éªŒè¯æ˜ å°„é€»è¾‘</button>
            <div id="analysisResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let currentStatsData = null;
        let currentElderlyData = null;

        // è·å–å¥åº·ç»Ÿè®¡æ•°æ®
        async function loadHealthStatistics() {
            const resultDiv = document.getElementById('statsResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'æ­£åœ¨åŠ è½½å¥åº·ç»Ÿè®¡æ•°æ®...';
            
            try {
                const response = await fetch(`${API_BASE}/elderly/health-statistics`);
                const data = await response.json();
                
                if (data.success) {
                    currentStatsData = data.data;
                    resultDiv.className = 'result success-result';
                    
                    let output = 'âœ… å¥åº·ç»Ÿè®¡æ•°æ®åŠ è½½æˆåŠŸï¼\n\n';
                    output += `ğŸ“Š æ€»äººæ•°: ${currentStatsData.summary.totalCount}\n`;
                    output += `â° æ›´æ–°æ—¶é—´: ${currentStatsData.summary.updateTime}\n\n`;
                    
                    // å¥åº·çŠ¶æ€åˆ†å¸ƒ
                    output += 'ğŸ¥ å¥åº·çŠ¶æ€åˆ†å¸ƒ:\n';
                    if (currentStatsData.healthStatusDistribution) {
                        currentStatsData.healthStatusDistribution.forEach(item => {
                            output += `  ${item.status}: ${item.count}äºº (${item.percentage}%)\n`;
                        });
                    }
                    
                    // å¹´é¾„æ®µåˆ†å¸ƒ
                    output += '\nğŸ‘¥ å¹´é¾„æ®µå¥åº·åˆ†å¸ƒ:\n';
                    if (currentStatsData.ageHealthDistribution) {
                        currentStatsData.ageHealthDistribution.forEach(item => {
                            const total = item.healthy + item.subHealth + item.chronic + item.risk;
                            output += `  ${item.ageRange}: æ€»è®¡${total}äºº (å¥åº·${item.healthy}, äºšå¥åº·${item.subHealth}, æ…¢æ€§ç—…${item.chronic}, é«˜é£é™©${item.risk})\n`;
                        });
                    }
                    
                    resultDiv.textContent = output;
                } else {
                    throw new Error(data.message || 'è·å–æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è·å–å¥åº·ç»Ÿè®¡å¤±è´¥: ${error.message}`;
            }
        }

        // è·å–è€äººæ•°æ®
        async function loadElderlyData() {
            const resultDiv = document.getElementById('statsResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'æ­£åœ¨åŠ è½½è€äººæ•°æ®...';
            
            try {
                const response = await fetch(`${API_BASE}/elderly/page`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pageNum: 1,
                        pageSize: 50  // è·å–æ›´å¤šæ•°æ®
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentElderlyData = data.data;
                    resultDiv.className = 'result success-result';
                    
                    let output = 'âœ… è€äººæ•°æ®åŠ è½½æˆåŠŸï¼\n\n';
                    output += `ğŸ“‹ æ€»è®°å½•æ•°: ${currentElderlyData.total}\n`;
                    output += `ğŸ“„ å½“å‰é¡µ: ${currentElderlyData.current}/${currentElderlyData.pages}\n`;
                    output += `ğŸ“Š å½“å‰é¡µè®°å½•æ•°: ${currentElderlyData.records.length}\n\n`;
                    
                    // åˆ†æå¥åº·çŠ¶æ€åˆ†å¸ƒ
                    const healthStatusMap = {};
                    const ageGroupMap = {};
                    
                    currentElderlyData.records.forEach(elderly => {
                        // å¥åº·çŠ¶æ€ç»Ÿè®¡
                        const status = elderly.healthStatus || 'æœªçŸ¥';
                        healthStatusMap[status] = (healthStatusMap[status] || 0) + 1;
                        
                        // å¹´é¾„æ®µç»Ÿè®¡
                        const age = calculateAge(elderly.birthDate);
                        const ageGroup = getAgeGroup(age);
                        if (!ageGroupMap[ageGroup]) {
                            ageGroupMap[ageGroup] = {};
                        }
                        ageGroupMap[ageGroup][status] = (ageGroupMap[ageGroup][status] || 0) + 1;
                    });
                    
                    output += 'ğŸ¥ å½“å‰é¡µå¥åº·çŠ¶æ€åˆ†å¸ƒ:\n';
                    Object.entries(healthStatusMap).forEach(([status, count]) => {
                        output += `  ${status}: ${count}äºº\n`;
                    });
                    
                    output += '\nğŸ‘¥ å½“å‰é¡µå¹´é¾„æ®µåˆ†å¸ƒ:\n';
                    Object.entries(ageGroupMap).forEach(([ageGroup, statusMap]) => {
                        const total = Object.values(statusMap).reduce((sum, count) => sum + count, 0);
                        output += `  ${ageGroup}: ${total}äºº\n`;
                        Object.entries(statusMap).forEach(([status, count]) => {
                            output += `    - ${status}: ${count}äºº\n`;
                        });
                    });
                    
                    resultDiv.textContent = output;
                } else {
                    throw new Error(data.message || 'è·å–æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è·å–è€äººæ•°æ®å¤±è´¥: ${error.message}`;
            }
        }

        // åˆ†æå¹´é¾„åˆ†å¸ƒ
        function analyzeAgeDistribution() {
            const resultDiv = document.getElementById('statsResult');
            resultDiv.style.display = 'block';
            
            if (!currentStatsData || !currentElderlyData) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è¯·å…ˆåŠ è½½å¥åº·ç»Ÿè®¡æ•°æ®å’Œè€äººæ•°æ®';
                return;
            }
            
            let output = 'ğŸ” å¹´é¾„åˆ†å¸ƒåˆ†æç»“æœ:\n\n';
            
            // å¯¹æ¯”APIç»Ÿè®¡ç»“æœå’Œå®é™…æ•°æ®
            output += 'ğŸ“Š APIç»Ÿè®¡ç»“æœ vs å®é™…æ•°æ®å¯¹æ¯”:\n';
            currentStatsData.ageHealthDistribution.forEach(apiItem => {
                const total = apiItem.healthy + apiItem.subHealth + apiItem.chronic + apiItem.risk;
                output += `\n${apiItem.ageRange}:\n`;
                output += `  APIç»Ÿè®¡: æ€»è®¡${total}äºº (å¥åº·${apiItem.healthy}, äºšå¥åº·${apiItem.subHealth}, æ…¢æ€§ç—…${apiItem.chronic}, é«˜é£é™©${apiItem.risk})\n`;
                
                // ä»åŸå§‹æ•°æ®è®¡ç®—
                const ageGroupData = currentElderlyData.records.filter(elderly => {
                    const age = calculateAge(elderly.birthDate);
                    return getAgeGroup(age) === apiItem.ageRange;
                });
                
                output += `  å®é™…æ•°æ®: æ€»è®¡${ageGroupData.length}äºº\n`;
                
                // åˆ†æå¥åº·çŠ¶æ€æ˜ å°„
                const statusMap = {};
                ageGroupData.forEach(elderly => {
                    const originalStatus = elderly.healthStatus || 'æœªçŸ¥';
                    const mappedStatus = mapHealthStatus(originalStatus);
                    if (!statusMap[mappedStatus]) statusMap[mappedStatus] = 0;
                    statusMap[mappedStatus]++;
                    
                    output += `    ${elderly.name}: ${originalStatus} -> ${mappedStatus}\n`;
                });
            });
            
            resultDiv.className = 'result success-result';
            resultDiv.textContent = output;
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderAgeHealthChart() {
            if (!currentStatsData) {
                alert('è¯·å…ˆåŠ è½½å¥åº·ç»Ÿè®¡æ•°æ®');
                return;
            }
            
            // å¹´é¾„æ®µå¥åº·åˆ†å¸ƒå›¾è¡¨
            const ageChart = echarts.init(document.getElementById('ageHealthChart'));
            const ageOption = {
                title: {
                    text: 'å¹´é¾„æ®µå¥åº·åˆ†å¸ƒ',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['å¥åº·', 'äºšå¥åº·', 'æ…¢æ€§ç—…', 'é«˜é£é™©'],
                    top: 30
                },
                xAxis: {
                    type: 'category',
                    data: currentStatsData.ageHealthDistribution.map(item => item.ageRange)
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                        name: 'å¥åº·',
                        type: 'bar',
                        data: currentStatsData.ageHealthDistribution.map(item => item.healthy),
                        itemStyle: { color: '#67c23a' }
                    },
                    {
                        name: 'äºšå¥åº·',
                        type: 'bar',
                        data: currentStatsData.ageHealthDistribution.map(item => item.subHealth),
                        itemStyle: { color: '#e6a23c' }
                    },
                    {
                        name: 'æ…¢æ€§ç—…',
                        type: 'bar',
                        data: currentStatsData.ageHealthDistribution.map(item => item.chronic),
                        itemStyle: { color: '#f56c6c' }
                    },
                    {
                        name: 'é«˜é£é™©',
                        type: 'bar',
                        data: currentStatsData.ageHealthDistribution.map(item => item.risk),
                        itemStyle: { color: '#909399' }
                    }
                ]
            };
            ageChart.setOption(ageOption);
            
            // å¥åº·çŠ¶æ€åˆ†å¸ƒé¥¼å›¾
            const statusChart = echarts.init(document.getElementById('healthStatusChart'));
            const statusOption = {
                title: {
                    text: 'æ•´ä½“å¥åº·çŠ¶æ€åˆ†å¸ƒ',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    top: 30
                },
                series: [
                    {
                        type: 'pie',
                        radius: '50%',
                        data: currentStatsData.healthStatusDistribution.map(item => ({
                            value: item.count,
                            name: item.status
                        })),
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }
                ]
            };
            statusChart.setOption(statusOption);
        }

        // è¯¦ç»†åˆ†æ
        function showDetailedAnalysis() {
            const resultDiv = document.getElementById('analysisResult');
            resultDiv.style.display = 'block';
            
            if (!currentStatsData || !currentElderlyData) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è¯·å…ˆåŠ è½½ç»Ÿè®¡æ•°æ®å’Œè€äººæ•°æ®';
                return;
            }
            
            let analysis = 'ğŸ“‹ è¯¦ç»†æ•°æ®åˆ†ææŠ¥å‘Š\n\n';
            
            // 1. æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
            analysis += 'ğŸ” æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥:\n';
            analysis += `APIç»Ÿè®¡æ€»æ•°: ${currentStatsData.summary.totalCount}\n`;
            analysis += `å®é™…æŸ¥è¯¢æ€»æ•°: ${currentElderlyData.total}\n`;
            analysis += `æ•°æ®ä¸€è‡´æ€§: ${currentStatsData.summary.totalCount === currentElderlyData.total ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}\n\n`;
            
            // 2. å¥åº·çŠ¶æ€æ˜ å°„éªŒè¯
            analysis += 'ğŸ¥ å¥åº·çŠ¶æ€æ˜ å°„éªŒè¯:\n';
            const uniqueStatuses = [...new Set(currentElderlyData.records.map(e => e.healthStatus || 'æœªçŸ¥'))];
            uniqueStatuses.forEach(status => {
                const mapped = mapHealthStatus(status);
                analysis += `${status} -> ${mapped}\n`;
            });
            
            // 3. å¹´é¾„åˆ†å¸ƒéªŒè¯
            analysis += '\nğŸ‘¥ å¹´é¾„åˆ†å¸ƒéªŒè¯:\n';
            currentElderlyData.records.forEach(elderly => {
                const age = calculateAge(elderly.birthDate);
                const ageGroup = getAgeGroup(age);
                analysis += `${elderly.name}: ${age}å² -> ${ageGroup}\n`;
            });
            
            resultDiv.className = 'result success-result';
            resultDiv.textContent = analysis;
        }

        // éªŒè¯æ˜ å°„é€»è¾‘
        function validateMappingLogic() {
            const resultDiv = document.getElementById('analysisResult');
            resultDiv.style.display = 'block';
            
            let validation = 'ğŸ”§ å¥åº·çŠ¶æ€æ˜ å°„é€»è¾‘éªŒè¯\n\n';
            
            // æµ‹è¯•å„ç§å¥åº·çŠ¶æ€æ˜ å°„
            const testCases = [
                'NORMAL', 'ATTENTION', 'WARNING', 'DANGER',
                'å¥åº·', 'äºšå¥åº·', 'æ…¢æ€§ç—…', 'é«˜é£é™©',
                'healthy', 'unhealthy', 'sick', 'chronic',
                '1', '2', '3', '', null, 'æœªçŸ¥', 'è‰¯å¥½', 'ç³–å°¿ç—…', 'é«˜è¡€å‹'
            ];
            
            validation += 'ğŸ“Š æ˜ å°„æµ‹è¯•ç»“æœ:\n';
            testCases.forEach(testCase => {
                const mapped = mapHealthStatus(testCase);
                validation += `${testCase || '[ç©ºå€¼]'} -> ${mapped}\n`;
            });
            
            validation += '\nâœ… æ˜ å°„é€»è¾‘éªŒè¯å®Œæˆï¼\n';
            validation += 'æ‰€æœ‰çŠ¶æ€éƒ½èƒ½æ­£ç¡®æ˜ å°„åˆ°æ ‡å‡†åˆ†ç±»ã€‚';
            
            resultDiv.className = 'result success-result';
            resultDiv.textContent = validation;
        }

        // å¯¹æ¯”é¢„æœŸç»“æœ
        function compareWithExpected() {
            alert('é¢„æœŸç»“æœå¯¹æ¯”åŠŸèƒ½ï¼šç¡®ä¿å„å¹´é¾„æ®µéƒ½æœ‰ä¸åŒå¥åº·çŠ¶æ€çš„åˆ†å¸ƒï¼Œä¸å†å‡ºç°åªæœ‰å¥åº·äººæ•°çš„é—®é¢˜ï¼');
        }

        // è¾…åŠ©å‡½æ•°
        function calculateAge(birthDate) {
            if (!birthDate) return null;
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function getAgeGroup(age) {
            if (age >= 60 && age < 70) return '60-70å²';
            if (age >= 70 && age < 80) return '70-80å²';
            if (age >= 80 && age < 90) return '80-90å²';
            if (age >= 90) return '90å²ä»¥ä¸Š';
            return 'å…¶ä»–';
        }

        function mapHealthStatus(status) {
            if (!status) return 'äºšå¥åº·';
            
            const s = status.toLowerCase().trim();
            
            // æšä¸¾å€¼
            if (s === 'normal' || s === '1') return 'å¥åº·';
            if (s === 'attention' || s === '2') return 'äºšå¥åº·';
            if (s === 'warning' || s === 'danger' || s === '3') return 'é«˜é£é™©';
            
            // ä¸­æ–‡çŠ¶æ€
            if (s === 'å¥åº·' || s === 'è‰¯å¥½' || s === 'æ­£å¸¸') return 'å¥åº·';
            if (s.includes('äºšå¥åº·') || s === 'ä¸€èˆ¬') return 'äºšå¥åº·';
            if (s.includes('æ…¢æ€§') || s.includes('ç³–å°¿ç—…') || s.includes('é«˜è¡€å‹')) return 'æ…¢æ€§ç—…';
            if (s.includes('é«˜é£é™©') || s.includes('å±é‡')) return 'é«˜é£é™©';
            
            // é»˜è®¤
            return 'äºšå¥åº·';
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            console.log('å¥åº·ç»Ÿè®¡æ•°æ®éªŒè¯é¡µé¢å·²åŠ è½½');
        };
    </script>
</body>
</html>
