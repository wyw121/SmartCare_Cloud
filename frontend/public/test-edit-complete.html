<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>老人档案编辑功能完整测试</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #409eff;
        }
        .result { 
            background: #f5f5f5; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            max-height: 300px;
            overflow-y: auto;
        }
        button { 
            background: #409eff; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { 
            background: #66b1ff; 
        }
        .success { 
            color: green; 
            font-weight: bold;
        }
        .error { 
            color: red; 
            font-weight: bold;
        }
        .info { 
            color: #409eff; 
            font-weight: bold;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-left: 4px solid #409eff;
        }
    </style>
</head>
<body>
    <h1>老人档案编辑功能完整测试</h1>
    <p>此页面用于测试老人档案的完整编辑流程：获取数据 → 显示数据 → 编辑数据 → 保存数据</p>

    <div class="test-section">
        <h3>步骤1: 获取老人档案数据</h3>
        <button onclick="testGetElderly()">获取老人档案 (ID: 1)</button>
        <div id="getResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>步骤2: 模拟编辑并更新数据</h3>
        <button onclick="testUpdateElderly()">模拟编辑并保存</button>
        <div id="updateResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>步骤3: 验证更新后的数据</h3>
        <button onclick="testVerifyUpdate()">重新获取数据验证更新</button>
        <div id="verifyResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>步骤4: 完整测试流程</h3>
        <button onclick="runFullTest()">运行完整测试流程</button>
        <div id="fullTestResult" class="result"></div>
    </div>

    <script>
        const API_BASE = '/api';
        let originalData = null;
        
        async function request(url, options = {}) {
            try {
                const response = await fetch(API_BASE + url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('API调用失败:', error);
                throw error;
            }
        }
        
        function logStep(elementId, message, type = 'info') {
            const resultDiv = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            resultDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }
        
        function clearResult(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        async function testGetElderly() {
            const elementId = 'getResult';
            clearResult(elementId);
            logStep(elementId, '开始获取老人档案数据...');
            
            try {
                const result = await request('/elderly/1');
                if (result.success) {
                    originalData = result.data;
                    logStep(elementId, '✓ 获取数据成功', 'success');
                    logStep(elementId, `姓名: ${result.data.name}`);
                    logStep(elementId, `电话: ${result.data.phone}`);
                    logStep(elementId, `地址: ${result.data.address}`);
                    logStep(elementId, `健康状态: ${result.data.healthStatus}`);
                    logStep(elementId, `创建时间: ${result.data.createTime}`);
                    logStep(elementId, `更新时间: ${result.data.updateTime}`);
                    logStep(elementId, '完整数据:');
                    logStep(elementId, `<pre>${JSON.stringify(result.data, null, 2)}</pre>`);
                } else {
                    logStep(elementId, `✗ 获取失败: ${result.message}`, 'error');
                }
            } catch (error) {
                logStep(elementId, `✗ 网络错误: ${error.message}`, 'error');
            }
        }
        
        async function testUpdateElderly() {
            const elementId = 'updateResult';
            clearResult(elementId);
            
            if (!originalData) {
                logStep(elementId, '请先获取老人档案数据', 'error');
                return;
            }
            
            logStep(elementId, '开始模拟编辑并更新数据...');
            
            try {
                // 创建编辑后的数据
                const editedData = {
                    ...originalData,
                    phone: '13999999999', // 修改电话
                    address: '测试编辑地址 - ' + new Date().toLocaleTimeString(), // 修改地址
                    emergencyContactName: '测试紧急联系人', // 添加紧急联系人
                    emergencyContactPhone: '13888888888', // 添加紧急联系人电话
                    medicalHistory: '测试既往病史', // 添加既往病史
                    allergyHistory: '无过敏史', // 添加过敏史
                    guardianName: '测试监护人', // 添加监护人
                    guardianPhone: '13777777777', // 添加监护人电话
                    guardianRelation: '子女', // 添加监护人关系
                    roomNumber: 'A101', // 添加房间号
                    remarks: '这是通过编辑功能测试页面更新的数据 - ' + new Date().toLocaleString()
                };
                
                logStep(elementId, '准备更新的数据:');
                logStep(elementId, `新电话: ${editedData.phone}`);
                logStep(elementId, `新地址: ${editedData.address}`);
                logStep(elementId, `紧急联系人: ${editedData.emergencyContactName} (${editedData.emergencyContactPhone})`);
                logStep(elementId, `监护人: ${editedData.guardianName} (${editedData.guardianPhone})`);
                
                const updateResult = await request('/elderly', {
                    method: 'PUT',
                    body: JSON.stringify(editedData)
                });
                
                if (updateResult.success) {
                    logStep(elementId, '✓ 更新成功！', 'success');
                    logStep(elementId, '完整更新数据:');
                    logStep(elementId, `<pre>${JSON.stringify(editedData, null, 2)}</pre>`);
                } else {
                    logStep(elementId, `✗ 更新失败: ${updateResult.message}`, 'error');
                }
            } catch (error) {
                logStep(elementId, `✗ 更新错误: ${error.message}`, 'error');
            }
        }
        
        async function testVerifyUpdate() {
            const elementId = 'verifyResult';
            clearResult(elementId);
            logStep(elementId, '开始验证更新后的数据...');
            
            try {
                const result = await request('/elderly/1');
                if (result.success) {
                    logStep(elementId, '✓ 重新获取数据成功', 'success');
                    
                    // 检查更新是否生效
                    if (result.data.phone === '13999999999') {
                        logStep(elementId, '✓ 电话更新验证成功', 'success');
                    } else {
                        logStep(elementId, `✗ 电话更新验证失败: ${result.data.phone}`, 'error');
                    }
                    
                    if (result.data.address && result.data.address.includes('测试编辑地址')) {
                        logStep(elementId, '✓ 地址更新验证成功', 'success');
                    } else {
                        logStep(elementId, `✗ 地址更新验证失败: ${result.data.address}`, 'error');
                    }
                    
                    if (result.data.emergencyContactName === '测试紧急联系人') {
                        logStep(elementId, '✓ 紧急联系人更新验证成功', 'success');
                    } else {
                        logStep(elementId, `✗ 紧急联系人更新验证失败: ${result.data.emergencyContactName}`, 'error');
                    }
                    
                    logStep(elementId, '验证完成的数据:');
                    logStep(elementId, `<pre>${JSON.stringify(result.data, null, 2)}</pre>`);
                } else {
                    logStep(elementId, `✗ 验证失败: ${result.message}`, 'error');
                }
            } catch (error) {
                logStep(elementId, `✗ 验证错误: ${error.message}`, 'error');
            }
        }
        
        async function runFullTest() {
            const elementId = 'fullTestResult';
            clearResult(elementId);
            logStep(elementId, '开始运行完整测试流程...', 'info');
            
            // 步骤1: 获取原始数据
            logStep(elementId, '=== 步骤1: 获取原始数据 ===', 'info');
            try {
                const getResult = await request('/elderly/1');
                if (getResult.success) {
                    originalData = getResult.data;
                    logStep(elementId, '✓ 获取原始数据成功', 'success');
                } else {
                    logStep(elementId, '✗ 获取原始数据失败', 'error');
                    return;
                }
            } catch (error) {
                logStep(elementId, '✗ 获取原始数据异常', 'error');
                return;
            }
            
            // 步骤2: 模拟编辑
            logStep(elementId, '=== 步骤2: 模拟编辑 ===', 'info');
            const testData = {
                ...originalData,
                phone: '13000000000',
                address: '完整测试地址 - ' + new Date().toLocaleTimeString(),
                emergencyContactName: '完整测试联系人',
                emergencyContactPhone: '13111111111',
                guardianName: '完整测试监护人',
                guardianPhone: '13222222222',
                guardianRelation: '测试关系',
                roomNumber: 'TEST-' + Math.floor(Math.random() * 1000),
                remarks: '完整测试备注 - ' + new Date().toLocaleString()
            };
            
            // 步骤3: 保存编辑
            logStep(elementId, '=== 步骤3: 保存编辑 ===', 'info');
            try {
                const updateResult = await request('/elderly', {
                    method: 'PUT',
                    body: JSON.stringify(testData)
                });
                
                if (updateResult.success) {
                    logStep(elementId, '✓ 保存编辑成功', 'success');
                } else {
                    logStep(elementId, '✗ 保存编辑失败', 'error');
                    return;
                }
            } catch (error) {
                logStep(elementId, '✗ 保存编辑异常', 'error');
                return;
            }
            
            // 步骤4: 验证保存结果
            logStep(elementId, '=== 步骤4: 验证保存结果 ===', 'info');
            try {
                const verifyResult = await request('/elderly/1');
                if (verifyResult.success) {
                    const data = verifyResult.data;
                    let successCount = 0;
                    let totalCount = 0;
                    
                    // 验证各个字段
                    const checks = [
                        { field: 'phone', expected: testData.phone, actual: data.phone },
                        { field: 'address', expected: testData.address, actual: data.address },
                        { field: 'emergencyContactName', expected: testData.emergencyContactName, actual: data.emergencyContactName },
                        { field: 'emergencyContactPhone', expected: testData.emergencyContactPhone, actual: data.emergencyContactPhone },
                        { field: 'guardianName', expected: testData.guardianName, actual: data.guardianName },
                        { field: 'guardianPhone', expected: testData.guardianPhone, actual: data.guardianPhone },
                        { field: 'guardianRelation', expected: testData.guardianRelation, actual: data.guardianRelation },
                        { field: 'roomNumber', expected: testData.roomNumber, actual: data.roomNumber },
                        { field: 'remarks', expected: testData.remarks, actual: data.remarks }
                    ];
                    
                    checks.forEach(check => {
                        totalCount++;
                        if (check.actual === check.expected) {
                            successCount++;
                            logStep(elementId, `✓ ${check.field} 验证成功`, 'success');
                        } else {
                            logStep(elementId, `✗ ${check.field} 验证失败: 期望 "${check.expected}", 实际 "${check.actual}"`, 'error');
                        }
                    });
                    
                    logStep(elementId, `=== 测试结果: ${successCount}/${totalCount} 项验证通过 ===`, 
                           successCount === totalCount ? 'success' : 'error');
                    
                    if (successCount === totalCount) {
                        logStep(elementId, '🎉 完整编辑功能测试通过！', 'success');
                    } else {
                        logStep(elementId, '❌ 编辑功能存在问题，需要检查', 'error');
                    }
                } else {
                    logStep(elementId, '✗ 验证数据获取失败', 'error');
                }
            } catch (error) {
                logStep(elementId, '✗ 验证过程异常', 'error');
            }
        }
    </script>
</body>
</html>
