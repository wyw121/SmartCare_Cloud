<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€äººæ¡£æ¡ˆç¼–è¾‘åŠŸèƒ½å®Œæ•´æµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #409eff;
        }
        .result { 
            background: #f5f5f5; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            max-height: 300px;
            overflow-y: auto;
        }
        button { 
            background: #409eff; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { 
            background: #66b1ff; 
        }
        .success { 
            color: green; 
            font-weight: bold;
        }
        .error { 
            color: red; 
            font-weight: bold;
        }
        .info { 
            color: #409eff; 
            font-weight: bold;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-left: 4px solid #409eff;
        }
    </style>
</head>
<body>
    <h1>è€äººæ¡£æ¡ˆç¼–è¾‘åŠŸèƒ½å®Œæ•´æµ‹è¯•</h1>
    <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•è€äººæ¡£æ¡ˆçš„å®Œæ•´ç¼–è¾‘æµç¨‹ï¼šè·å–æ•°æ® â†’ æ˜¾ç¤ºæ•°æ® â†’ ç¼–è¾‘æ•°æ® â†’ ä¿å­˜æ•°æ®</p>

    <div class="test-section">
        <h3>æ­¥éª¤1: è·å–è€äººæ¡£æ¡ˆæ•°æ®</h3>
        <button onclick="testGetElderly()">è·å–è€äººæ¡£æ¡ˆ (ID: 1)</button>
        <div id="getResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>æ­¥éª¤2: æ¨¡æ‹Ÿç¼–è¾‘å¹¶æ›´æ–°æ•°æ®</h3>
        <button onclick="testUpdateElderly()">æ¨¡æ‹Ÿç¼–è¾‘å¹¶ä¿å­˜</button>
        <div id="updateResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>æ­¥éª¤3: éªŒè¯æ›´æ–°åçš„æ•°æ®</h3>
        <button onclick="testVerifyUpdate()">é‡æ–°è·å–æ•°æ®éªŒè¯æ›´æ–°</button>
        <div id="verifyResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>æ­¥éª¤4: å®Œæ•´æµ‹è¯•æµç¨‹</h3>
        <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹</button>
        <div id="fullTestResult" class="result"></div>
    </div>

    <script>
        const API_BASE = '/api';
        let originalData = null;
        
        async function request(url, options = {}) {
            try {
                const response = await fetch(API_BASE + url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }
        
        function logStep(elementId, message, type = 'info') {
            const resultDiv = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            resultDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }
        
        function clearResult(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        async function testGetElderly() {
            const elementId = 'getResult';
            clearResult(elementId);
            logStep(elementId, 'å¼€å§‹è·å–è€äººæ¡£æ¡ˆæ•°æ®...');
            
            try {
                const result = await request('/elderly/1');
                if (result.success) {
                    originalData = result.data;
                    logStep(elementId, 'âœ“ è·å–æ•°æ®æˆåŠŸ', 'success');
                    logStep(elementId, `å§“å: ${result.data.name}`);
                    logStep(elementId, `ç”µè¯: ${result.data.phone}`);
                    logStep(elementId, `åœ°å€: ${result.data.address}`);
                    logStep(elementId, `å¥åº·çŠ¶æ€: ${result.data.healthStatus}`);
                    logStep(elementId, `åˆ›å»ºæ—¶é—´: ${result.data.createTime}`);
                    logStep(elementId, `æ›´æ–°æ—¶é—´: ${result.data.updateTime}`);
                    logStep(elementId, 'å®Œæ•´æ•°æ®:');
                    logStep(elementId, `<pre>${JSON.stringify(result.data, null, 2)}</pre>`);
                } else {
                    logStep(elementId, `âœ— è·å–å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                logStep(elementId, `âœ— ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        async function testUpdateElderly() {
            const elementId = 'updateResult';
            clearResult(elementId);
            
            if (!originalData) {
                logStep(elementId, 'è¯·å…ˆè·å–è€äººæ¡£æ¡ˆæ•°æ®', 'error');
                return;
            }
            
            logStep(elementId, 'å¼€å§‹æ¨¡æ‹Ÿç¼–è¾‘å¹¶æ›´æ–°æ•°æ®...');
            
            try {
                // åˆ›å»ºç¼–è¾‘åçš„æ•°æ®
                const editedData = {
                    ...originalData,
                    phone: '13999999999', // ä¿®æ”¹ç”µè¯
                    address: 'æµ‹è¯•ç¼–è¾‘åœ°å€ - ' + new Date().toLocaleTimeString(), // ä¿®æ”¹åœ°å€
                    emergencyContactName: 'æµ‹è¯•ç´§æ€¥è”ç³»äºº', // æ·»åŠ ç´§æ€¥è”ç³»äºº
                    emergencyContactPhone: '13888888888', // æ·»åŠ ç´§æ€¥è”ç³»äººç”µè¯
                    medicalHistory: 'æµ‹è¯•æ—¢å¾€ç—…å²', // æ·»åŠ æ—¢å¾€ç—…å²
                    allergyHistory: 'æ— è¿‡æ•å²', // æ·»åŠ è¿‡æ•å²
                    guardianName: 'æµ‹è¯•ç›‘æŠ¤äºº', // æ·»åŠ ç›‘æŠ¤äºº
                    guardianPhone: '13777777777', // æ·»åŠ ç›‘æŠ¤äººç”µè¯
                    guardianRelation: 'å­å¥³', // æ·»åŠ ç›‘æŠ¤äººå…³ç³»
                    roomNumber: 'A101', // æ·»åŠ æˆ¿é—´å·
                    remarks: 'è¿™æ˜¯é€šè¿‡ç¼–è¾‘åŠŸèƒ½æµ‹è¯•é¡µé¢æ›´æ–°çš„æ•°æ® - ' + new Date().toLocaleString()
                };
                
                logStep(elementId, 'å‡†å¤‡æ›´æ–°çš„æ•°æ®:');
                logStep(elementId, `æ–°ç”µè¯: ${editedData.phone}`);
                logStep(elementId, `æ–°åœ°å€: ${editedData.address}`);
                logStep(elementId, `ç´§æ€¥è”ç³»äºº: ${editedData.emergencyContactName} (${editedData.emergencyContactPhone})`);
                logStep(elementId, `ç›‘æŠ¤äºº: ${editedData.guardianName} (${editedData.guardianPhone})`);
                
                const updateResult = await request('/elderly', {
                    method: 'PUT',
                    body: JSON.stringify(editedData)
                });
                
                if (updateResult.success) {
                    logStep(elementId, 'âœ“ æ›´æ–°æˆåŠŸï¼', 'success');
                    logStep(elementId, 'å®Œæ•´æ›´æ–°æ•°æ®:');
                    logStep(elementId, `<pre>${JSON.stringify(editedData, null, 2)}</pre>`);
                } else {
                    logStep(elementId, `âœ— æ›´æ–°å¤±è´¥: ${updateResult.message}`, 'error');
                }
            } catch (error) {
                logStep(elementId, `âœ— æ›´æ–°é”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        async function testVerifyUpdate() {
            const elementId = 'verifyResult';
            clearResult(elementId);
            logStep(elementId, 'å¼€å§‹éªŒè¯æ›´æ–°åçš„æ•°æ®...');
            
            try {
                const result = await request('/elderly/1');
                if (result.success) {
                    logStep(elementId, 'âœ“ é‡æ–°è·å–æ•°æ®æˆåŠŸ', 'success');
                    
                    // æ£€æŸ¥æ›´æ–°æ˜¯å¦ç”Ÿæ•ˆ
                    if (result.data.phone === '13999999999') {
                        logStep(elementId, 'âœ“ ç”µè¯æ›´æ–°éªŒè¯æˆåŠŸ', 'success');
                    } else {
                        logStep(elementId, `âœ— ç”µè¯æ›´æ–°éªŒè¯å¤±è´¥: ${result.data.phone}`, 'error');
                    }
                    
                    if (result.data.address && result.data.address.includes('æµ‹è¯•ç¼–è¾‘åœ°å€')) {
                        logStep(elementId, 'âœ“ åœ°å€æ›´æ–°éªŒè¯æˆåŠŸ', 'success');
                    } else {
                        logStep(elementId, `âœ— åœ°å€æ›´æ–°éªŒè¯å¤±è´¥: ${result.data.address}`, 'error');
                    }
                    
                    if (result.data.emergencyContactName === 'æµ‹è¯•ç´§æ€¥è”ç³»äºº') {
                        logStep(elementId, 'âœ“ ç´§æ€¥è”ç³»äººæ›´æ–°éªŒè¯æˆåŠŸ', 'success');
                    } else {
                        logStep(elementId, `âœ— ç´§æ€¥è”ç³»äººæ›´æ–°éªŒè¯å¤±è´¥: ${result.data.emergencyContactName}`, 'error');
                    }
                    
                    logStep(elementId, 'éªŒè¯å®Œæˆçš„æ•°æ®:');
                    logStep(elementId, `<pre>${JSON.stringify(result.data, null, 2)}</pre>`);
                } else {
                    logStep(elementId, `âœ— éªŒè¯å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                logStep(elementId, `âœ— éªŒè¯é”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        async function runFullTest() {
            const elementId = 'fullTestResult';
            clearResult(elementId);
            logStep(elementId, 'å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...', 'info');
            
            // æ­¥éª¤1: è·å–åŸå§‹æ•°æ®
            logStep(elementId, '=== æ­¥éª¤1: è·å–åŸå§‹æ•°æ® ===', 'info');
            try {
                const getResult = await request('/elderly/1');
                if (getResult.success) {
                    originalData = getResult.data;
                    logStep(elementId, 'âœ“ è·å–åŸå§‹æ•°æ®æˆåŠŸ', 'success');
                } else {
                    logStep(elementId, 'âœ— è·å–åŸå§‹æ•°æ®å¤±è´¥', 'error');
                    return;
                }
            } catch (error) {
                logStep(elementId, 'âœ— è·å–åŸå§‹æ•°æ®å¼‚å¸¸', 'error');
                return;
            }
            
            // æ­¥éª¤2: æ¨¡æ‹Ÿç¼–è¾‘
            logStep(elementId, '=== æ­¥éª¤2: æ¨¡æ‹Ÿç¼–è¾‘ ===', 'info');
            const testData = {
                ...originalData,
                phone: '13000000000',
                address: 'å®Œæ•´æµ‹è¯•åœ°å€ - ' + new Date().toLocaleTimeString(),
                emergencyContactName: 'å®Œæ•´æµ‹è¯•è”ç³»äºº',
                emergencyContactPhone: '13111111111',
                guardianName: 'å®Œæ•´æµ‹è¯•ç›‘æŠ¤äºº',
                guardianPhone: '13222222222',
                guardianRelation: 'æµ‹è¯•å…³ç³»',
                roomNumber: 'TEST-' + Math.floor(Math.random() * 1000),
                remarks: 'å®Œæ•´æµ‹è¯•å¤‡æ³¨ - ' + new Date().toLocaleString()
            };
            
            // æ­¥éª¤3: ä¿å­˜ç¼–è¾‘
            logStep(elementId, '=== æ­¥éª¤3: ä¿å­˜ç¼–è¾‘ ===', 'info');
            try {
                const updateResult = await request('/elderly', {
                    method: 'PUT',
                    body: JSON.stringify(testData)
                });
                
                if (updateResult.success) {
                    logStep(elementId, 'âœ“ ä¿å­˜ç¼–è¾‘æˆåŠŸ', 'success');
                } else {
                    logStep(elementId, 'âœ— ä¿å­˜ç¼–è¾‘å¤±è´¥', 'error');
                    return;
                }
            } catch (error) {
                logStep(elementId, 'âœ— ä¿å­˜ç¼–è¾‘å¼‚å¸¸', 'error');
                return;
            }
            
            // æ­¥éª¤4: éªŒè¯ä¿å­˜ç»“æœ
            logStep(elementId, '=== æ­¥éª¤4: éªŒè¯ä¿å­˜ç»“æœ ===', 'info');
            try {
                const verifyResult = await request('/elderly/1');
                if (verifyResult.success) {
                    const data = verifyResult.data;
                    let successCount = 0;
                    let totalCount = 0;
                    
                    // éªŒè¯å„ä¸ªå­—æ®µ
                    const checks = [
                        { field: 'phone', expected: testData.phone, actual: data.phone },
                        { field: 'address', expected: testData.address, actual: data.address },
                        { field: 'emergencyContactName', expected: testData.emergencyContactName, actual: data.emergencyContactName },
                        { field: 'emergencyContactPhone', expected: testData.emergencyContactPhone, actual: data.emergencyContactPhone },
                        { field: 'guardianName', expected: testData.guardianName, actual: data.guardianName },
                        { field: 'guardianPhone', expected: testData.guardianPhone, actual: data.guardianPhone },
                        { field: 'guardianRelation', expected: testData.guardianRelation, actual: data.guardianRelation },
                        { field: 'roomNumber', expected: testData.roomNumber, actual: data.roomNumber },
                        { field: 'remarks', expected: testData.remarks, actual: data.remarks }
                    ];
                    
                    checks.forEach(check => {
                        totalCount++;
                        if (check.actual === check.expected) {
                            successCount++;
                            logStep(elementId, `âœ“ ${check.field} éªŒè¯æˆåŠŸ`, 'success');
                        } else {
                            logStep(elementId, `âœ— ${check.field} éªŒè¯å¤±è´¥: æœŸæœ› "${check.expected}", å®é™… "${check.actual}"`, 'error');
                        }
                    });
                    
                    logStep(elementId, `=== æµ‹è¯•ç»“æœ: ${successCount}/${totalCount} é¡¹éªŒè¯é€šè¿‡ ===`, 
                           successCount === totalCount ? 'success' : 'error');
                    
                    if (successCount === totalCount) {
                        logStep(elementId, 'ğŸ‰ å®Œæ•´ç¼–è¾‘åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼', 'success');
                    } else {
                        logStep(elementId, 'âŒ ç¼–è¾‘åŠŸèƒ½å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦æ£€æŸ¥', 'error');
                    }
                } else {
                    logStep(elementId, 'âœ— éªŒè¯æ•°æ®è·å–å¤±è´¥', 'error');
                }
            } catch (error) {
                logStep(elementId, 'âœ— éªŒè¯è¿‡ç¨‹å¼‚å¸¸', 'error');
            }
        }
    </script>
</body>
</html>
