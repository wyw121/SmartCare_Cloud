<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>健康统计API测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #409eff;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e4e7ed;
            border-radius: 6px;
        }
        .test-section h3 {
            color: #303133;
            margin-top: 0;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #66b1ff;
        }
        .success {
            background: #67c23a;
        }
        .success:hover {
            background: #85ce61;
        }
        .warning {
            background: #e6a23c;
        }
        .warning:hover {
            background: #ebb563;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #409eff;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            border-left-color: #f56c6c;
            background: #fef0f0;
            color: #f56c6c;
        }
        .success-result {
            border-left-color: #67c23a;
            background: #f0f9ff;
            color: #67c23a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>智慧医养平台 - 健康统计API测试</h1>
        
        <div class="test-section">
            <h3>🏥 健康统计API测试</h3>
            <button onclick="testHealthStatistics()">获取健康统计数据</button>
            <button onclick="testElderlyList()" class="success">获取老人列表</button>
            <button onclick="testAgeDistribution()" class="warning">年龄分布测试</button>
            <div id="healthStatsResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>📊 数据分析测试</h3>
            <button onclick="analyzeHealthData()">分析健康状态分布</button>
            <button onclick="simulateDatabase()" class="success">模拟数据库查询</button>
            <div id="analysisResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>🔧 后端连接测试</h3>
            <button onclick="testBackendConnection()">测试后端连接</button>
            <button onclick="testDatabaseConnection()" class="warning">测试数据库连接</button>
            <div id="connectionResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        
        // 健康统计API测试
        async function testHealthStatistics() {
            const resultDiv = document.getElementById('healthStatsResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '正在请求健康统计数据...';
            
            try {
                const response = await fetch(`${API_BASE}/elderly/health-statistics`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                resultDiv.className = 'result success-result';
                resultDiv.textContent = `请求成功！\n\n响应数据：\n${JSON.stringify(data, null, 2)}`;
                
                // 分析返回的数据
                if (data.data) {
                    const analysis = analyzeStatistics(data.data);
                    resultDiv.textContent += `\n\n数据分析：\n${analysis}`;
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `请求失败：${error.message}`;
                console.error('健康统计API测试失败:', error);
            }
        }
        
        // 老人列表API测试
        async function testElderlyList() {
            const resultDiv = document.getElementById('healthStatsResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '正在获取老人列表...';
            
            try {
                const response = await fetch(`${API_BASE}/elderly/list?pageNum=1&pageSize=10`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                resultDiv.className = 'result success-result';
                
                let analysisText = `老人列表获取成功！\n\n`;
                if (data.data && data.data.records) {
                    analysisText += `总记录数: ${data.data.total}\n`;
                    analysisText += `当前页记录数: ${data.data.records.length}\n\n`;
                    
                    // 分析健康状态分布
                    const healthStatusMap = {};
                    data.data.records.forEach(elderly => {
                        const status = elderly.healthStatus || '未知';
                        healthStatusMap[status] = (healthStatusMap[status] || 0) + 1;
                    });
                    
                    analysisText += `当前页健康状态分布：\n`;
                    Object.entries(healthStatusMap).forEach(([status, count]) => {
                        analysisText += `  ${status}: ${count}人\n`;
                    });
                    
                    analysisText += `\n原始数据：\n${JSON.stringify(data, null, 2)}`;
                }
                
                resultDiv.textContent = analysisText;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `获取老人列表失败：${error.message}`;
                console.error('老人列表API测试失败:', error);
            }
        }
        
        // 年龄分布测试
        async function testAgeDistribution() {
            const resultDiv = document.getElementById('healthStatsResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '正在测试年龄分布计算...';
            
            // 模拟一些测试数据
            const testData = [
                {birthDate: '1945-05-20', healthStatus: 'NORMAL'},
                {birthDate: '1950-08-15', healthStatus: 'ATTENTION'},
                {birthDate: '1960-12-10', healthStatus: 'WARNING'},
                {birthDate: '1965-03-25', healthStatus: '健康'},
                {birthDate: '1955-07-18', healthStatus: '亚健康'},
                {birthDate: '1940-11-30', healthStatus: ''},
                {birthDate: '1948-02-14', healthStatus: null}
            ];
            
            try {
                // 计算年龄分布
                const ageDistribution = calculateAgeDistribution(testData);
                
                resultDiv.className = 'result success-result';
                resultDiv.textContent = `年龄分布计算测试：\n\n${JSON.stringify(ageDistribution, null, 2)}`;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `年龄分布测试失败：${error.message}`;
            }
        }
        
        // 分析健康数据
        function analyzeHealthData() {
            const resultDiv = document.getElementById('analysisResult');
            resultDiv.style.display = 'block';
            
            const analysis = `
健康状态映射分析：

后端映射逻辑应该包含：
1. 标准枚举值：NORMAL(正常), ATTENTION(关注), WARNING(预警)
2. 中文描述：健康, 亚健康, 疾病, 慢性病, 重症
3. 英文描述：healthy, unhealthy, sick, chronic, critical
4. 数字编码：1(健康), 2(亚健康), 3(疾病)
5. 空值/未知：默认归类为亚健康

前端容错处理：
- 当后端无数据时，生成模拟分布
- 对未知状态进行友好显示
- 提供数据刷新和重试机制

数据库字段检查要点：
- health_status字段类型和长度
- 是否有索引优化查询性能
- 数据一致性和规范性
            `;
            
            resultDiv.className = 'result';
            resultDiv.textContent = analysis;
        }
        
        // 模拟数据库查询
        function simulateDatabase() {
            const resultDiv = document.getElementById('analysisResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '模拟执行数据库查询...';
            
            // 模拟SQL查询结果
            setTimeout(() => {
                const mockResult = `
模拟数据库查询结果：

SELECT health_status, COUNT(*) FROM elderly GROUP BY health_status;

结果：
+----------------+----------+
| health_status  | count    |
+----------------+----------+
| NORMAL         |       25 |
| ATTENTION      |       18 |
| WARNING        |       12 |
| 健康           |        8 |
| 亚健康         |        6 |
| NULL           |        3 |
| 慢性病         |        2 |
+----------------+----------+

问题分析：
1. 存在多种健康状态表示方式
2. 有NULL值需要处理
3. 需要统一标准化映射
4. 建议建立健康状态字典表
                `;
                
                resultDiv.className = 'result success-result';
                resultDiv.textContent = mockResult;
            }, 1000);
        }
        
        // 测试后端连接
        async function testBackendConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '正在测试后端连接...';
            
            try {
                const response = await fetch(`${API_BASE}/actuator/health`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success-result';
                    resultDiv.textContent = `后端连接成功！\n\n健康检查结果：\n${JSON.stringify(data, null, 2)}`;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                // 尝试访问其他端点
                try {
                    const response = await fetch(`${API_BASE}/elderly/list?pageNum=1&pageSize=1`);
                    if (response.ok) {
                        resultDiv.className = 'result success-result';
                        resultDiv.textContent = '后端连接成功！（通过老人列表API验证）';
                    } else {
                        throw new Error('后端服务可能未启动');
                    }
                } catch (fallbackError) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `后端连接失败：${error.message}\n\n请确认：\n1. 后端服务是否已启动（端口8080）\n2. 数据库连接是否正常\n3. 网络连接是否正常`;
                }
            }
        }
        
        // 测试数据库连接
        function testDatabaseConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.style.display = 'block';
            
            const dbInfo = `
数据库连接信息：

配置：
- 数据库：MySQL 8.0
- 地址：localhost:3306
- 数据库名：smartcare_cloud
- 用户名：root
- 密码：123456

检查要点：
1. MySQL服务是否启动
2. 数据库smartcare_cloud是否存在
3. elderly表是否存在且有数据
4. health_status字段是否正确定义

建议执行的SQL检查：
SHOW DATABASES;
USE smartcare_cloud;
SHOW TABLES;
DESCRIBE elderly;
SELECT COUNT(*) FROM elderly;
SELECT DISTINCT health_status FROM elderly;
            `;
            
            resultDiv.className = 'result';
            resultDiv.textContent = dbInfo;
        }
        
        // 分析统计数据
        function analyzeStatistics(stats) {
            let analysis = '';
            
            if (stats.ageDistribution) {
                analysis += `年龄分布分析：\n`;
                stats.ageDistribution.forEach(item => {
                    analysis += `  ${item.ageRange}: ${item.healthyCount}健康 + ${item.unhealthyCount}非健康 = ${item.totalCount}总计\n`;
                });
                analysis += '\n';
            }
            
            if (stats.healthStatusDistribution) {
                analysis += `健康状态分布：\n`;
                stats.healthStatusDistribution.forEach(item => {
                    analysis += `  ${item.status}: ${item.count}人 (${item.percentage}%)\n`;
                });
                analysis += '\n';
            }
            
            if (stats.totalCount) {
                analysis += `总老人数：${stats.totalCount}\n`;
            }
            
            return analysis || '数据格式解析中...';
        }
        
        // 计算年龄分布
        function calculateAgeDistribution(data) {
            const currentYear = new Date().getFullYear();
            const ageGroups = {
                '60-70岁': {healthy: 0, unhealthy: 0},
                '70-80岁': {healthy: 0, unhealthy: 0},
                '80-90岁': {healthy: 0, unhealthy: 0},
                '90岁以上': {healthy: 0, unhealthy: 0}
            };
            
            data.forEach(item => {
                if (!item.birthDate) return;
                
                const birthYear = new Date(item.birthDate).getFullYear();
                const age = currentYear - birthYear;
                
                let ageGroup;
                if (age >= 60 && age < 70) ageGroup = '60-70岁';
                else if (age >= 70 && age < 80) ageGroup = '70-80岁';
                else if (age >= 80 && age < 90) ageGroup = '80-90岁';
                else if (age >= 90) ageGroup = '90岁以上';
                else return;
                
                const isHealthy = isHealthyStatus(item.healthStatus);
                if (isHealthy) {
                    ageGroups[ageGroup].healthy++;
                } else {
                    ageGroups[ageGroup].unhealthy++;
                }
            });
            
            return ageGroups;
        }
        
        // 判断是否为健康状态
        function isHealthyStatus(status) {
            if (!status) return false;
            const healthyKeywords = ['NORMAL', 'healthy', '健康', '正常', '1'];
            return healthyKeywords.some(keyword => 
                status.toString().toLowerCase().includes(keyword.toLowerCase())
            );
        }
        
        // 页面加载完成后显示说明
        window.onload = function() {
            console.log('健康统计API测试页面加载完成');
            console.log('请确保后端服务已启动（端口8080）');
        };
    </script>
</body>
</html>
