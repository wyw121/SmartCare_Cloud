<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨å†Œé‚®ç®±çº¦æŸä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #f56c6c, #e53935);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .content {
            padding: 40px;
        }
        .fix-banner {
            background: #f0f9ff;
            border: 2px solid #0891b2;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            color: #0891b2;
            font-size: 1.1em;
            font-weight: 600;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
        }
        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .test-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .test-button {
            background: #409eff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #337ecc;
            transform: translateY(-2px);
        }
        .test-button.success {
            background: #67c23a;
        }
        .test-button.success:hover {
            background: #5daf34;
        }
        .test-button.danger {
            background: #f56c6c;
        }
        .test-button.danger:hover {
            background: #e53935;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            word-wrap: break-word;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .result.success {
            background: #f0f9ff;
            border: 1px solid #0891b2;
            color: #0891b2;
        }
        .result.error {
            background: #fef2f2;
            border: 1px solid #dc2626;
            color: #dc2626;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .code-block .comment {
            color: #68d391;
        }
        .code-block .keyword {
            color: #63b3ed;
        }
        .code-block .string {
            color: #f6ad55;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ é‚®ç®±çº¦æŸä¿®å¤æµ‹è¯•</h1>
            <p>è§£å†³æ•°æ®åº“é‚®ç®±å”¯ä¸€çº¦æŸå†²çªé—®é¢˜</p>
        </div>
        
        <div class="content">
            <div class="fix-banner">
                <div style="font-size: 2em; margin-bottom: 10px;">âœ…</div>
                <div>é‚®ç®±å”¯ä¸€çº¦æŸå†²çªé—®é¢˜å·²ä¿®å¤ï¼</div>
                <div style="font-size: 0.9em; margin-top: 10px;">ç©ºå­—ç¬¦ä¸²ç°åœ¨ä¼šè¢«æ­£ç¡®å¤„ç†ä¸ºnullå€¼</div>
            </div>
            
            <div class="test-grid">
                <div class="test-card">
                    <h3>ğŸ§ª é—®é¢˜é‡ç°æµ‹è¯•</h3>
                    <p>æµ‹è¯•ä¿®å¤å‰çš„é—®é¢˜ï¼šå¤šä¸ªç”¨æˆ·ä¸å¡«å†™é‚®ç®±æ—¶çš„çº¦æŸå†²çª</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ç”¨æˆ·å1:</label>
                            <input type="text" id="username1" value="testuser1" placeholder="ç¬¬ä¸€ä¸ªç”¨æˆ·">
                        </div>
                        <div class="form-group">
                            <label>ç”¨æˆ·å2:</label>
                            <input type="text" id="username2" value="testuser2" placeholder="ç¬¬äºŒä¸ªç”¨æˆ·">
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="test-button success" onclick="testMultipleUsersWithoutEmail()">
                            æµ‹è¯•æ— é‚®ç®±ç”¨æˆ·æ³¨å†Œ
                        </button>
                    </div>
                    <div id="multiple-users-result" class="result" style="display: none;"></div>
                </div>
                
                <div class="test-card">
                    <h3>ğŸ“Š å•ç”¨æˆ·æ³¨å†Œæµ‹è¯•</h3>
                    <p>æµ‹è¯•å„ç§é‚®ç®±æƒ…å†µä¸‹çš„æ³¨å†ŒåŠŸèƒ½</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ç”¨æˆ·å:</label>
                            <input type="text" id="singleUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
                        </div>
                        <div class="form-group">
                            <label>é‚®ç®±:</label>
                            <input type="email" id="singleEmail" placeholder="è¾“å…¥é‚®ç®±(å¯é€‰)">
                        </div>
                        <div class="form-group">
                            <label>è§’è‰²:</label>
                            <select id="singleRole">
                                <option value="admin">ç®¡ç†å‘˜</option>
                                <option value="doctor">åŒ»ç”Ÿ</option>
                                <option value="family">å®¶å±</option>
                            </select>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="test-button" onclick="testSingleUserRegister()">
                            æµ‹è¯•å•ç”¨æˆ·æ³¨å†Œ
                        </button>
                        <button class="test-button success" onclick="testWithEmptyEmail()">
                            æµ‹è¯•ç©ºé‚®ç®±æ³¨å†Œ
                        </button>
                    </div>
                    <div id="single-user-result" class="result" style="display: none;"></div>
                </div>
            </div>
            
            <div class="test-card">
                <h3>ğŸ” ä¿®å¤è¯¦æƒ…</h3>
                <p><strong>é—®é¢˜åŸå› ï¼š</strong> æ•°æ®åº“é‚®ç®±å­—æ®µè®¾ç½®äº†å”¯ä¸€çº¦æŸï¼Œå½“å¤šä¸ªç”¨æˆ·ä¸å¡«å†™é‚®ç®±æ—¶ï¼Œç©ºå­—ç¬¦ä¸²è¢«è§†ä¸ºé‡å¤å€¼</p>
                <p><strong>ä¿®å¤æ–¹æ¡ˆï¼š</strong> å‰ç«¯å’Œåç«¯éƒ½å°†ç©ºå­—ç¬¦ä¸²è½¬æ¢ä¸ºnullå€¼ï¼Œé¿å…çº¦æŸå†²çª</p>
                
                <div class="code-block">
<span class="comment">// åç«¯ä¿®å¤ - UserAuthServiceImpl.java</span>
<span class="keyword">user</span>.setEmail(StringUtils.hasText(registerDTO.getEmail()) ? 
    registerDTO.getEmail() : <span class="keyword">null</span>);

<span class="comment">// å‰ç«¯ä¿®å¤ - register/index.vue</span>
email: registerForm.email || <span class="keyword">null</span>,
department: registerForm.department || <span class="keyword">null</span>,
description: registerForm.description || <span class="keyword">null</span>
                </div>
            </div>
            
            <div class="test-card">
                <h3>ğŸŒ æ‰¹é‡æµ‹è¯•</h3>
                <p>å¿«é€Ÿæµ‹è¯•å¤šä¸ªç”¨æˆ·æ³¨å†Œåœºæ™¯</p>
                <div style="text-align: center;">
                    <button class="test-button" onclick="runBatchTest()">è¿è¡Œæ‰¹é‡æµ‹è¯•</button>
                    <button class="test-button danger" onclick="clearAllResults()">æ¸…ç©ºæ‰€æœ‰ç»“æœ</button>
                </div>
                <div id="batch-test-result" class="result" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        
        // ç”Ÿæˆéšæœºç”¨æˆ·æ•°æ®
        function generateUserData(username, email = null, role = 'admin') {
            return {
                username: username,
                password: '123456',
                confirmPassword: '123456',
                realName: `ç”¨æˆ·${username}`,
                gender: 1,
                phone: `138${Math.floor(Math.random() * 100000000).toString().padStart(8, '0')}`,
                email: email,
                roleCode: role
            };
        }
        
        // æµ‹è¯•æ³¨å†ŒAPI
        async function testRegister(userData) {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }
        
        // æµ‹è¯•å¤šä¸ªç”¨æˆ·ä¸å¡«å†™é‚®ç®±çš„æƒ…å†µ
        async function testMultipleUsersWithoutEmail() {
            const resultDiv = document.getElementById('multiple-users-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'æµ‹è¯•ä¸­...';
            resultDiv.className = 'result';
            
            const username1 = document.getElementById('username1').value || 'testuser1';
            const username2 = document.getElementById('username2').value || 'testuser2';
            
            let results = [];
            
            // æµ‹è¯•ç¬¬ä¸€ä¸ªç”¨æˆ·ï¼ˆæ— é‚®ç®±ï¼‰
            const user1Data = generateUserData(username1, null, 'admin');
            const result1 = await testRegister(user1Data);
            results.push(`ç”¨æˆ·1 (${username1}): ${result1.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`);
            if (!result1.success) {
                results.push(`é”™è¯¯: ${result1.error || result1.data?.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
            
            // æµ‹è¯•ç¬¬äºŒä¸ªç”¨æˆ·ï¼ˆä¹Ÿæ— é‚®ç®±ï¼‰
            const user2Data = generateUserData(username2, null, 'doctor');
            const result2 = await testRegister(user2Data);
            results.push(`ç”¨æˆ·2 (${username2}): ${result2.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`);
            if (!result2.success) {
                results.push(`é”™è¯¯: ${result2.error || result2.data?.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
            
            // æ˜¾ç¤ºç»“æœ
            if (result1.success && result2.success) {
                resultDiv.className = 'result success';
                results.unshift('ğŸ‰ æµ‹è¯•é€šè¿‡ï¼ä¸¤ä¸ªç”¨æˆ·éƒ½æˆåŠŸæ³¨å†Œï¼Œé‚®ç®±çº¦æŸå†²çªå·²è§£å†³ï¼');
            } else {
                resultDiv.className = 'result error';
                results.unshift('âŒ æµ‹è¯•å¤±è´¥ï¼Œä»å­˜åœ¨é—®é¢˜');
            }
            
            resultDiv.textContent = results.join('\n');
        }
        
        // æµ‹è¯•å•ç”¨æˆ·æ³¨å†Œ
        async function testSingleUserRegister() {
            const resultDiv = document.getElementById('single-user-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'æ³¨å†Œä¸­...';
            resultDiv.className = 'result';
            
            const username = document.getElementById('singleUsername').value;
            const email = document.getElementById('singleEmail').value;
            const role = document.getElementById('singleRole').value;
            
            if (!username) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è¯·è¾“å…¥ç”¨æˆ·å';
                return;
            }
            
            const userData = generateUserData(username, email || null, role);
            const result = await testRegister(userData);
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… æ³¨å†ŒæˆåŠŸï¼\nç”¨æˆ·å: ${username}\né‚®ç®±: ${email || '(æœªå¡«å†™)'}\nè§’è‰²: ${role}\nå“åº”: ${JSON.stringify(result.data, null, 2)}`;
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ æ³¨å†Œå¤±è´¥\né”™è¯¯: ${result.error || result.data?.message || 'æœªçŸ¥é”™è¯¯'}\nçŠ¶æ€ç : ${result.status || 'N/A'}`;
            }
        }
        
        // æµ‹è¯•ç©ºé‚®ç®±æ³¨å†Œ
        async function testWithEmptyEmail() {
            const timestamp = Date.now();
            document.getElementById('singleUsername').value = `empty_email_${timestamp}`;
            document.getElementById('singleEmail').value = '';
            document.getElementById('singleRole').value = 'family';
            
            await testSingleUserRegister();
        }
        
        // è¿è¡Œæ‰¹é‡æµ‹è¯•
        async function runBatchTest() {
            const resultDiv = document.getElementById('batch-test-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'è¿è¡Œæ‰¹é‡æµ‹è¯•...';
            resultDiv.className = 'result';
            
            const testCases = [
                { name: 'æœ‰é‚®ç®±ç®¡ç†å‘˜', username: 'admin_with_email', email: 'admin@test.com', role: 'admin' },
                { name: 'æ— é‚®ç®±ç®¡ç†å‘˜', username: 'admin_no_email', email: null, role: 'admin' },
                { name: 'æœ‰é‚®ç®±åŒ»ç”Ÿ', username: 'doctor_with_email', email: 'doctor@test.com', role: 'doctor' },
                { name: 'æ— é‚®ç®±åŒ»ç”Ÿ', username: 'doctor_no_email', email: null, role: 'doctor' },
                { name: 'æœ‰é‚®ç®±å®¶å±', username: 'family_with_email', email: 'family@test.com', role: 'family' },
                { name: 'æ— é‚®ç®±å®¶å±', username: 'family_no_email', email: null, role: 'family' }
            ];
            
            let results = ['ğŸ“Š æ‰¹é‡æµ‹è¯•ç»“æœ:', ''];
            let successCount = 0;
            
            for (const testCase of testCases) {
                const timestamp = Date.now();
                const userData = generateUserData(
                    `${testCase.username}_${timestamp}`, 
                    testCase.email, 
                    testCase.role
                );
                
                const result = await testRegister(userData);
                
                if (result.success) {
                    results.push(`âœ… ${testCase.name}: æˆåŠŸ`);
                    successCount++;
                } else {
                    results.push(`âŒ ${testCase.name}: å¤±è´¥ - ${result.error || result.data?.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            }
            
            results.push('');
            results.push(`ğŸ“ˆ æµ‹è¯•æ€»ç»“: ${successCount}/${testCases.length} ä¸ªæµ‹è¯•é€šè¿‡`);
            
            if (successCount === testCases.length) {
                resultDiv.className = 'result success';
                results.push('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼é‚®ç®±çº¦æŸé—®é¢˜å·²å®Œå…¨è§£å†³ï¼');
            } else {
                resultDiv.className = 'result error';
                results.push('âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å…·ä½“é”™è¯¯ä¿¡æ¯');
            }
            
            resultDiv.textContent = results.join('\n');
        }
        
        // æ¸…ç©ºæ‰€æœ‰ç»“æœ
        function clearAllResults() {
            document.querySelectorAll('.result').forEach(div => {
                div.style.display = 'none';
                div.textContent = '';
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶è®¾ç½®é»˜è®¤å€¼
        window.addEventListener('load', function() {
            const timestamp = Date.now();
            document.getElementById('username1').value = `user1_${timestamp}`;
            document.getElementById('username2').value = `user2_${timestamp}`;
            document.getElementById('singleUsername').value = `single_${timestamp}`;
            
            console.log('é‚®ç®±çº¦æŸä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html>
