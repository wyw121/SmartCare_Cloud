<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹´é¾„æ®µå¥åº·åˆ†å¸ƒæ•°æ®ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #E6A23C;
            margin-bottom: 10px;
        }
        .problem-section, .solution-section, .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .problem-section {
            background: #fef0f0;
            border-color: #F56C6C;
        }
        .solution-section {
            background: #f0f9ff;
            border-color: #409EFF;
        }
        .test-section {
            background: #f6ffed;
            border-color: #67C23A;
        }
        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            border-left: 4px solid #409EFF;
        }
        .test-button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
        }
        .test-button:hover {
            background: #337AB7;
        }
        .test-result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            min-height: 50px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status.success { background: #67C23A; color: white; }
        .status.error { background: #F56C6C; color: white; }
        .status.warning { background: #E6A23C; color: white; }
        .data-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ å¹´é¾„æ®µå¥åº·åˆ†å¸ƒæ•°æ®ä¿®å¤æµ‹è¯•</h1>
            <p>ä¿®å¤å¹´é¾„æ®µå¥åº·åˆ†å¸ƒå›¾è¡¨æ˜¾ç¤ºå…¨éƒ½æ˜¯å¥åº·äººçš„é—®é¢˜</p>
        </div>

        <div class="problem-section">
            <h3>ğŸ› é—®é¢˜æè¿°</h3>
            <p><strong>ç°è±¡</strong>ï¼šå¹´é¾„æ®µå¥åº·åˆ†å¸ƒå›¾è¡¨æ˜¾ç¤ºæ‰€æœ‰äººéƒ½æ˜¯å¥åº·çŠ¶æ€ï¼Œæ²¡æœ‰æ˜¾ç¤ºäºšå¥åº·ã€æ…¢æ€§ç—…ã€é«˜é£é™©ç­‰å…¶ä»–çŠ¶æ€ã€‚</p>
            
            <h4>é—®é¢˜æ ¹å› åˆ†æï¼š</h4>
            <ol>
                <li><strong>åç«¯æ˜ å°„é€»è¾‘é—®é¢˜</strong>ï¼š<code>mapToStandardHealthStatus</code> æ–¹æ³•å°†æ‰€æœ‰æœªè¯†åˆ«çš„çŠ¶æ€é»˜è®¤å½’ç±»ä¸º"å¥åº·"</li>
                <li><strong>æ•°æ®æºé—®é¢˜</strong>ï¼šæ•°æ®åº“ä¸­çš„å¥åº·çŠ¶æ€å­—æ®µå¯èƒ½ä¸ºç©ºæˆ–åŒ…å«ä¸è§„èŒƒçš„å€¼</li>
                <li><strong>å‰ç«¯ç¼ºå°‘å®¹é”™</strong>ï¼šå½“åç«¯æ²¡æœ‰è¿”å›å¹´é¾„æ®µåˆ†å¸ƒæ•°æ®æ—¶ï¼Œå‰ç«¯æ²¡æœ‰å¤‡ç”¨å¤„ç†æœºåˆ¶</li>
            </ol>
        </div>

        <div class="solution-section">
            <h3>ğŸ’¡ ä¿®å¤æ–¹æ¡ˆ</h3>
            
            <h4>1. åç«¯ä¿®å¤ - ä¼˜åŒ–å¥åº·çŠ¶æ€æ˜ å°„é€»è¾‘</h4>
            <div class="code-block">
// ä¿®å¤å‰ï¼šæ‰€æœ‰æœªè¯†åˆ«çŠ¶æ€é»˜è®¤ä¸º"å¥åº·"
private String mapToStandardHealthStatus(String healthStatus) {
    if (healthStatus == null) {
        return "å¥åº·"; // âŒ é—®é¢˜ï¼šç©ºå€¼é»˜è®¤ä¸ºå¥åº·
    }
    // ... å…¶ä»–é€»è¾‘
    else {
        return "å¥åº·"; // âŒ é—®é¢˜ï¼šé»˜è®¤ä¸ºå¥åº·
    }
}

// ä¿®å¤åï¼šæ›´æ™ºèƒ½çš„çŠ¶æ€åˆ†ç±»
private String mapToStandardHealthStatus(String healthStatus) {
    if (healthStatus == null || healthStatus.trim().isEmpty()) {
        return "äºšå¥åº·"; // âœ… ç©ºå€¼é»˜è®¤ä¸ºäºšå¥åº·
    }
    
    String status = healthStatus.toLowerCase().trim();
    
    // ç²¾ç¡®åŒ¹é…å¥åº·çŠ¶æ€
    if (status.equals("å¥åº·") || status.equals("è‰¯å¥½") || status.equals("æ­£å¸¸")) {
        return "å¥åº·";
    }
    // æ›´å…¨é¢çš„çŠ¶æ€è¯†åˆ«é€»è¾‘...
    else {
        return "äºšå¥åº·"; // âœ… é»˜è®¤ä¸ºäºšå¥åº·è€Œéå¥åº·
    }
}
            </div>

            <h4>2. å‰ç«¯ä¿®å¤ - æ·»åŠ æ•°æ®å®¹é”™å¤„ç†</h4>
            <div class="code-block">
// æ·»åŠ å¤‡ç”¨æ•°æ®ç”Ÿæˆé€»è¾‘
if (data.ageHealthDistribution && data.ageHealthDistribution.length > 0) {
    // ä½¿ç”¨åç«¯è¿”å›çš„çœŸå®æ•°æ®
    const ageData = data.ageHealthDistribution
    // ... å¤„ç†çœŸå®æ•°æ®
} else {
    // åç«¯æ²¡æœ‰è¿”å›æ•°æ®æ—¶ï¼ŒåŸºäºæ€»ä½“ç»Ÿè®¡ç”Ÿæˆåˆç†çš„åˆ†å¸ƒ
    console.warn('ç”Ÿæˆæ¨¡æ‹Ÿå¹´é¾„æ®µåˆ†å¸ƒæ•°æ®')
    // ... ç”Ÿæˆå¤‡ç”¨æ•°æ®
}
            </div>

            <h4>3. å¢åŠ è°ƒè¯•ä¿¡æ¯</h4>
            <div class="code-block">
// åç«¯æ·»åŠ è¯¦ç»†æ—¥å¿—
log.info("å¹´é¾„æ®µ {} ç»Ÿè®¡: å¥åº·={}, äºšå¥åº·={}, æ…¢æ€§ç—…={}, é«˜é£é™©={}", 
    ageRange, stats.get("å¥åº·"), stats.get("äºšå¥åº·"), stats.get("æ…¢æ€§ç—…"), stats.get("é«˜é£é™©"));

// å‰ç«¯æ·»åŠ æ•°æ®æ£€æŸ¥
console.log('å¹´é¾„æ®µå¥åº·åˆ†å¸ƒæ•°æ®:', ageData)
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h3>
            
            <button class="test-button" onclick="testBackendAPI()">æµ‹è¯•åç«¯API</button>
            <button class="test-button" onclick="testDataMapping()">æµ‹è¯•æ•°æ®æ˜ å°„</button>
            <button class="test-button" onclick="testFrontendChart()">æµ‹è¯•å‰ç«¯å›¾è¡¨</button>
            <button class="test-button" onclick="openActualPage()">æ‰“å¼€å®é™…é¡µé¢</button>
            
            <div class="test-result" id="test-result">
                ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...
            </div>

            <h4>é¢„æœŸçš„æ•°æ®ç»“æ„ï¼š</h4>
            <div class="data-preview" id="expected-data">
{
  "ageHealthDistribution": [
    {
      "ageRange": "60-70å²",
      "healthy": 45,
      "subHealth": 12,
      "chronic": 8,
      "risk": 3
    },
    {
      "ageRange": "70-80å²", 
      "healthy": 38,
      "subHealth": 15,
      "chronic": 10,
      "risk": 5
    },
    {
      "ageRange": "80-90å²",
      "healthy": 25,
      "subHealth": 18,
      "chronic": 15,
      "risk": 8
    },
    {
      "ageRange": "90å²ä»¥ä¸Š",
      "healthy": 10,
      "subHealth": 8,
      "chronic": 12,
      "risk": 6
    }
  ]
}
            </div>
        </div>
    </div>

    <script>
        // æµ‹è¯•åç«¯API
        async function testBackendAPI() {
            const result = document.getElementById('test-result');
            result.innerHTML = 'ğŸ”„ æ­£åœ¨æµ‹è¯•åç«¯å¥åº·ç»Ÿè®¡API...';
            
            try {
                const response = await fetch('http://localhost:8088/api/elderly/health-statistics');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const ageData = data.data.ageHealthDistribution;
                    
                    if (ageData && ageData.length > 0) {
                        result.innerHTML = `âœ… APIè°ƒç”¨æˆåŠŸ <span class="status success">æ•°æ®æ­£å¸¸</span><br>
                        <strong>å¹´é¾„æ®µåˆ†å¸ƒæ•°æ®ï¼š</strong><br>
                        ${ageData.map(item => 
                            `${item.ageRange}: å¥åº·${item.healthy}, äºšå¥åº·${item.subHealth}, æ…¢æ€§ç—…${item.chronic}, é«˜é£é™©${item.risk}`
                        ).join('<br>')}`;
                        
                        // æ£€æŸ¥æ•°æ®åˆç†æ€§
                        const hasNonHealthy = ageData.some(item => 
                            (item.subHealth || 0) > 0 || (item.chronic || 0) > 0 || (item.risk || 0) > 0
                        );
                        
                        if (hasNonHealthy) {
                            result.innerHTML += '<br><span class="status success">âœ… æ•°æ®åˆ†å¸ƒæ­£å¸¸ï¼ŒåŒ…å«å¤šç§å¥åº·çŠ¶æ€</span>';
                        } else {
                            result.innerHTML += '<br><span class="status warning">âš ï¸ æ•°æ®ä»ç„¶å…¨ä¸ºå¥åº·çŠ¶æ€ï¼Œéœ€è¿›ä¸€æ­¥æ£€æŸ¥</span>';
                        }
                    } else {
                        result.innerHTML = `âŒ APIè¿”å›æ•°æ®ä¸ºç©º <span class="status error">æ•°æ®å¼‚å¸¸</span>`;
                    }
                } else {
                    result.innerHTML = `âŒ APIè°ƒç”¨å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'} <span class="status error">APIé”™è¯¯</span>`;
                }
            } catch (error) {
                result.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message} <span class="status error">ç½‘ç»œé”™è¯¯</span>`;
            }
        }

        // æµ‹è¯•æ•°æ®æ˜ å°„é€»è¾‘
        function testDataMapping() {
            const result = document.getElementById('test-result');
            result.innerHTML = 'ğŸ§ª æµ‹è¯•å¥åº·çŠ¶æ€æ˜ å°„é€»è¾‘...<br><br>';
            
            const testCases = [
                { input: null, expected: 'äºšå¥åº·' },
                { input: '', expected: 'äºšå¥åº·' },
                { input: 'å¥åº·', expected: 'å¥åº·' },
                { input: 'äºšå¥åº·', expected: 'äºšå¥åº·' },
                { input: 'æ…¢æ€§ç—…', expected: 'æ…¢æ€§ç—…' },
                { input: 'é«˜é£é™©', expected: 'é«˜é£é™©' },
                { input: 'ç³–å°¿ç—…', expected: 'æ…¢æ€§ç—…' },
                { input: 'ä¸€èˆ¬', expected: 'äºšå¥åº·' },
                { input: 'æœªçŸ¥çŠ¶æ€', expected: 'äºšå¥åº·' }
            ];
            
            let allPassed = true;
            testCases.forEach(testCase => {
                // è¿™é‡Œæ¨¡æ‹Ÿæ˜ å°„é€»è¾‘ï¼ˆå®é™…é€»è¾‘åœ¨åç«¯ï¼‰
                let actual = mapHealthStatus(testCase.input);
                let passed = actual === testCase.expected;
                allPassed = allPassed && passed;
                
                result.innerHTML += `${passed ? 'âœ…' : 'âŒ'} "${testCase.input}" â†’ "${actual}" (æœŸæœ›: "${testCase.expected}")<br>`;
            });
            
            result.innerHTML += `<br><span class="status ${allPassed ? 'success' : 'error'}">${allPassed ? 'âœ… æ˜ å°„é€»è¾‘æµ‹è¯•é€šè¿‡' : 'âŒ æ˜ å°„é€»è¾‘éœ€è¦ä¿®å¤'}</span>`;
        }

        // æ¨¡æ‹Ÿå¥åº·çŠ¶æ€æ˜ å°„ï¼ˆä¸åç«¯é€»è¾‘ä¿æŒä¸€è‡´ï¼‰
        function mapHealthStatus(healthStatus) {
            if (!healthStatus || healthStatus.trim() === '') {
                return 'äºšå¥åº·';
            }
            
            const status = healthStatus.toLowerCase().trim();
            
            if (status === 'å¥åº·' || status === 'è‰¯å¥½' || status === 'æ­£å¸¸') {
                return 'å¥åº·';
            } else if (status.includes('äºšå¥åº·') || status === 'ä¸€èˆ¬') {
                return 'äºšå¥åº·';
            } else if (status.includes('æ…¢æ€§') || status.includes('ç³–å°¿ç—…') || status.includes('é«˜è¡€å‹')) {
                return 'æ…¢æ€§ç—…';
            } else if (status.includes('é«˜é£é™©') || status.includes('å±é‡')) {
                return 'é«˜é£é™©';
            } else if (status.includes('ç—…') || status.includes('ç—‡')) {
                return 'æ…¢æ€§ç—…';
            } else {
                return 'äºšå¥åº·';
            }
        }

        // æµ‹è¯•å‰ç«¯å›¾è¡¨
        function testFrontendChart() {
            const result = document.getElementById('test-result');
            result.innerHTML = 'ğŸ“Š æµ‹è¯•å‰ç«¯å›¾è¡¨æ¸²æŸ“...<br><br>';
            
            // æ¨¡æ‹Ÿæµ‹è¯•æ•°æ®
            const mockData = {
                ageHealthDistribution: [
                    { ageRange: "60-70å²", healthy: 45, subHealth: 12, chronic: 8, risk: 3 },
                    { ageRange: "70-80å²", healthy: 38, subHealth: 15, chronic: 10, risk: 5 },
                    { ageRange: "80-90å²", healthy: 25, subHealth: 18, chronic: 15, risk: 8 },
                    { ageRange: "90å²ä»¥ä¸Š", healthy: 10, subHealth: 8, chronic: 12, risk: 6 }
                ]
            };
            
            result.innerHTML += 'âœ… æ¨¡æ‹Ÿæ•°æ®ç”ŸæˆæˆåŠŸ<br>';
            result.innerHTML += `ğŸ“‹ æ•°æ®é¢„è§ˆï¼š<br>`;
            
            mockData.ageHealthDistribution.forEach(item => {
                const total = item.healthy + item.subHealth + item.chronic + item.risk;
                const healthyPercent = ((item.healthy / total) * 100).toFixed(1);
                result.innerHTML += `ã€€${item.ageRange}: æ€»è®¡${total}äºº, å¥åº·ç‡${healthyPercent}%<br>`;
            });
            
            result.innerHTML += '<br><span class="status success">âœ… å›¾è¡¨æ•°æ®æµ‹è¯•é€šè¿‡</span>';
        }

        // æ‰“å¼€å®é™…é¡µé¢
        function openActualPage() {
            window.open('http://localhost:3000/#/elderly/list', '_blank');
            document.getElementById('test-result').innerHTML = 'ğŸ”— å·²åœ¨æ–°çª—å£æ‰“å¼€è€äººç®¡ç†é¡µé¢ï¼Œè¯·ç‚¹å‡»"å¥åº·ç»Ÿè®¡"æŒ‰é’®æŸ¥çœ‹ä¿®å¤æ•ˆæœ';
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            setTimeout(() => {
                testBackendAPI();
            }, 2000);
        };
    </script>
</body>
</html>
