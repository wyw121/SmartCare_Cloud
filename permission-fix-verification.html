<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒé™ä¿®å¤éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .test-section h3 {
            color: #495057;
            margin-top: 0;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online {
            background-color: #28a745;
        }
        .status-offline {
            background-color: #dc3545;
        }
        .account-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .account-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }
        .account-card h4 {
            margin-top: 0;
            color: #495057;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ™ºæ…§åŒ»å…»å¹³å°æƒé™ä¿®å¤éªŒè¯</h1>
        
        <!-- æœåŠ¡çŠ¶æ€æ£€æŸ¥ -->
        <div class="test-section">
            <h3>ğŸŒ æœåŠ¡çŠ¶æ€æ£€æŸ¥</h3>
            <div class="button-group">
                <button class="btn-primary" onclick="checkBackendStatus()">æ£€æŸ¥åç«¯æœåŠ¡</button>
                <button class="btn-primary" onclick="checkFrontendStatus()">æ£€æŸ¥å‰ç«¯æœåŠ¡</button>
            </div>
            <div id="statusResults"></div>
        </div>

        <!-- æƒé™ä¿®å¤éªŒè¯ -->
        <div class="test-section">
            <h3>ğŸ”§ æƒé™ä¿®å¤éªŒè¯</h3>
            <p>éªŒè¯ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•åæ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®è€äººç®¡ç†é¡µé¢</p>
            <div class="button-group">
                <button class="btn-success" onclick="testAdminLogin()">ç®¡ç†å‘˜ç™»å½•æµ‹è¯•</button>
                <button class="btn-primary" onclick="testElderlyAPI()">è€äººç®¡ç†APIæµ‹è¯•</button>
                <button class="btn-primary" onclick="testPermissionCheck()">æƒé™æ£€æŸ¥æµ‹è¯•</button>
            </div>
            <div id="permissionResults"></div>
        </div>

        <!-- APIè·¯å¾„éªŒè¯ -->
        <div class="test-section">
            <h3>ğŸ”— APIè·¯å¾„éªŒè¯</h3>
            <p>éªŒè¯å‰åç«¯APIè·¯å¾„æ˜¯å¦åŒ¹é…</p>
            <div class="button-group">
                <button class="btn-primary" onclick="testAPIEndpoints()">æµ‹è¯•APIç«¯ç‚¹</button>
                <button class="btn-primary" onclick="testSecurityConfig()">æµ‹è¯•å®‰å…¨é…ç½®</button>
            </div>
            <div id="apiResults"></div>
        </div>

        <!-- å¿«é€Ÿç™»å½•è´¦å· -->
        <div class="test-section">
            <h3>ğŸ‘¥ å¼€å‘ç¯å¢ƒå¿«é€Ÿç™»å½•</h3>
            <div class="account-info">
                <div class="account-card">
                    <h4>ğŸ›¡ï¸ ç³»ç»Ÿç®¡ç†å‘˜</h4>
                    <p><strong>ç”¨æˆ·å:</strong> admin</p>
                    <p><strong>å¯†ç :</strong> 123456</p>
                    <p><strong>è§’è‰²:</strong> ç³»ç»Ÿç®¡ç†å‘˜</p>
                    <p><strong>æƒé™:</strong> æ‰€æœ‰åŠŸèƒ½è®¿é—®</p>
                </div>
                <div class="account-card">
                    <h4>ğŸ‘¨â€âš•ï¸ åŒ»ç”Ÿè´¦å·</h4>
                    <p><strong>ç”¨æˆ·å:</strong> doctor</p>
                    <p><strong>å¯†ç :</strong> 123456</p>
                    <p><strong>è§’è‰²:</strong> åŒ»ç”Ÿ</p>
                    <p><strong>æƒé™:</strong> åŒ»ç–—ç®¡ç†ç›¸å…³</p>
                </div>
                <div class="account-card">
                    <h4>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶å±è´¦å·</h4>
                    <p><strong>ç”¨æˆ·å:</strong> family</p>
                    <p><strong>å¯†ç :</strong> 123456</p>
                    <p><strong>è§’è‰²:</strong> å®¶å±</p>
                    <p><strong>æƒé™:</strong> æŸ¥çœ‹æƒé™</p>
                </div>
            </div>
        </div>

        <!-- ä¿®å¤è¯´æ˜ -->
        <div class="test-section">
            <h3>ğŸ“ é—®é¢˜ä¿®å¤è¯´æ˜</h3>
            <div class="account-card">
                <h4>ğŸ”§ ä¸»è¦ä¿®å¤å†…å®¹</h4>
                <ul>
                    <li><strong>åç«¯APIè·¯å¾„ä¿®å¤:</strong> å°† ElderlyController çš„è·¯å¾„ä» <code>/elderly</code> æ”¹ä¸º <code>/api/elderly</code></li>
                    <li><strong>Spring Securityé…ç½®ä¿®å¤:</strong> å°†å®‰å…¨é…ç½®ä¸­çš„ <code>/elderly/**</code> æ”¹ä¸º <code>/api/elderly/**</code></li>
                    <li><strong>å‰ç«¯æƒé™å‡½æ•°ä¿®å¤:</strong> ä¿®å¤ <code>canAccessRoute</code> å‡½æ•°çš„é€»è¾‘é—®é¢˜</li>
                    <li><strong>è·¯ç”±æƒé™æ£€æŸ¥:</strong> ç¡®ä¿ç³»ç»Ÿç®¡ç†å‘˜èƒ½å¤Ÿè®¿é—®æ‰€æœ‰é¡µé¢</li>
                </ul>
                
                <h4>ğŸ¯ ä¿®å¤åçš„æ•ˆæœ</h4>
                <ul>
                    <li>ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•åå¯ä»¥æ­£å¸¸è®¿é—®è€äººç®¡ç†é¡µé¢</li>
                    <li>APIè¯·æ±‚ä¸å†å‡ºç°403 Forbiddené”™è¯¯</li>
                    <li>æƒé™æ£€æŸ¥é€»è¾‘æ­£ç¡®è¿è¡Œ</li>
                    <li>æ‰€æœ‰è§’è‰²çš„æƒé™æ§åˆ¶æ­£å¸¸å·¥ä½œ</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:8080';
        const FRONTEND_URL = 'http://localhost:3000';

        let currentToken = null;
        let currentUser = null;

        function showResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>${new Date().toLocaleTimeString()}</strong>
                </div>
                ${message}
            `;
            container.innerHTML = '';
            container.appendChild(resultDiv);
        }

        // æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
        async function checkBackendStatus() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/health`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult('statusResults', `
                        <div style="display: flex; align-items: center;">
                            <span class="status-indicator status-online"></span>
                            <strong>åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ</strong>
                        </div>
                        <div style="margin-top: 10px;">
                            çŠ¶æ€ç : ${response.status}<br>
                            å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}
                        </div>
                    `, 'success');
                } else {
                    showResult('statusResults', `
                        <div style="display: flex; align-items: center;">
                            <span class="status-indicator status-offline"></span>
                            <strong>åç«¯æœåŠ¡å“åº”å¼‚å¸¸</strong>
                        </div>
                        <div style="margin-top: 10px;">
                            çŠ¶æ€ç : ${response.status}<br>
                            é”™è¯¯ä¿¡æ¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    `, 'error');
                }
            } catch (error) {
                showResult('statusResults', `
                    <div style="display: flex; align-items: center;">
                        <span class="status-indicator status-offline"></span>
                        <strong>åç«¯æœåŠ¡è¿æ¥å¤±è´¥</strong>
                    </div>
                    <div style="margin-top: 10px;">
                        é”™è¯¯ä¿¡æ¯: ${error.message}
                    </div>
                `, 'error');
            }
        }

        // æ£€æŸ¥å‰ç«¯æœåŠ¡çŠ¶æ€
        async function checkFrontendStatus() {
            try {
                const response = await fetch(`${FRONTEND_URL}/`);
                
                if (response.ok) {
                    showResult('statusResults', `
                        <div style="display: flex; align-items: center;">
                            <span class="status-indicator status-online"></span>
                            <strong>å‰ç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ</strong>
                        </div>
                        <div style="margin-top: 10px;">
                            çŠ¶æ€ç : ${response.status}<br>
                            å‰ç«¯æœåŠ¡åœ°å€: ${FRONTEND_URL}
                        </div>
                    `, 'success');
                } else {
                    showResult('statusResults', `
                        <div style="display: flex; align-items: center;">
                            <span class="status-indicator status-offline"></span>
                            <strong>å‰ç«¯æœåŠ¡å“åº”å¼‚å¸¸</strong>
                        </div>
                        <div style="margin-top: 10px;">
                            çŠ¶æ€ç : ${response.status}
                        </div>
                    `, 'error');
                }
            } catch (error) {
                showResult('statusResults', `
                    <div style="display: flex; align-items: center;">
                        <span class="status-indicator status-offline"></span>
                        <strong>å‰ç«¯æœåŠ¡è¿æ¥å¤±è´¥</strong>
                    </div>
                    <div style="margin-top: 10px;">
                        é”™è¯¯ä¿¡æ¯: ${error.message}
                    </div>
                `, 'error');
            }
        }

        // æµ‹è¯•ç®¡ç†å‘˜ç™»å½•
        async function testAdminLogin() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: '123456'
                    })
                });

                const data = await response.json();

                if (response.ok && data.code === 200) {
                    currentToken = data.data.token;
                    currentUser = data.data.userInfo;
                    
                    showResult('permissionResults', `
                        <div>âœ… <strong>ç®¡ç†å‘˜ç™»å½•æˆåŠŸ</strong></div>
                        <div style="margin-top: 10px;">
                            <strong>ç”¨æˆ·ä¿¡æ¯:</strong><br>
                            ç”¨æˆ·å: ${currentUser.username}<br>
                            è§’è‰²: ${currentUser.roleText}<br>
                            æƒé™: ${currentUser.permissions ? currentUser.permissions.join(', ') : 'æ— '}
                        </div>
                        <div style="margin-top: 10px;">
                            <strong>Token:</strong> ${currentToken.substring(0, 50)}...
                        </div>
                    `, 'success');
                } else {
                    showResult('permissionResults', `
                        <div>âŒ <strong>ç®¡ç†å‘˜ç™»å½•å¤±è´¥</strong></div>
                        <div style="margin-top: 10px;">
                            é”™è¯¯ä¿¡æ¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    `, 'error');
                }
            } catch (error) {
                showResult('permissionResults', `
                    <div>âŒ <strong>ç™»å½•è¯·æ±‚å¤±è´¥</strong></div>
                    <div style="margin-top: 10px;">
                        é”™è¯¯ä¿¡æ¯: ${error.message}
                    </div>
                `, 'error');
            }
        }

        // æµ‹è¯•è€äººç®¡ç†API
        async function testElderlyAPI() {
            if (!currentToken) {
                showResult('permissionResults', 'âŒ è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·', 'error');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/elderly/page`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        current: 1,
                        size: 10
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('permissionResults', `
                        <div>âœ… <strong>è€äººç®¡ç†APIè®¿é—®æˆåŠŸ</strong></div>
                        <div style="margin-top: 10px;">
                            <strong>APIå“åº”:</strong><br>
                            çŠ¶æ€ç : ${response.status}<br>
                            å“åº”ä»£ç : ${data.code}<br>
                            æ•°æ®æ¡æ•°: ${data.data ? data.data.records?.length || 0 : 0}
                        </div>
                        <div style="margin-top: 10px;">
                            <strong>å®Œæ•´å“åº”:</strong><br>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `, 'success');
                } else {
                    showResult('permissionResults', `
                        <div>âŒ <strong>è€äººç®¡ç†APIè®¿é—®å¤±è´¥</strong></div>
                        <div style="margin-top: 10px;">
                            HTTPçŠ¶æ€ç : ${response.status}<br>
                            é”™è¯¯ä¿¡æ¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    `, 'error');
                }
            } catch (error) {
                showResult('permissionResults', `
                    <div>âŒ <strong>APIè¯·æ±‚å¤±è´¥</strong></div>
                    <div style="margin-top: 10px;">
                        é”™è¯¯ä¿¡æ¯: ${error.message}
                    </div>
                `, 'error');
            }
        }

        // æµ‹è¯•æƒé™æ£€æŸ¥
        async function testPermissionCheck() {
            if (!currentUser) {
                showResult('permissionResults', 'âŒ è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·', 'error');
                return;
            }

            const permissions = currentUser.permissions || [];
            const role = currentUser.role || '';

            let permissionCheckResult = '';

            // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
            if (permissions.includes('*')) {
                permissionCheckResult += 'âœ… ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™ (*)\n';
            } else {
                permissionCheckResult += 'âŒ ç®¡ç†å‘˜æƒé™ä¸å®Œæ•´\n';
            }

            // æ£€æŸ¥è§’è‰²
            if (role === 'admin') {
                permissionCheckResult += 'âœ… è§’è‰²è¯†åˆ«æ­£ç¡® (admin)\n';
            } else {
                permissionCheckResult += `âŒ è§’è‰²è¯†åˆ«é”™è¯¯ (${role})\n`;
            }

            // æ£€æŸ¥å…·ä½“æƒé™
            const requiredPermissions = ['elderly:view', 'elderly:edit', 'elderly:delete'];
            requiredPermissions.forEach(permission => {
                if (permissions.includes('*') || permissions.includes(permission)) {
                    permissionCheckResult += `âœ… æ‹¥æœ‰æƒé™: ${permission}\n`;
                } else {
                    permissionCheckResult += `âŒ ç¼ºå°‘æƒé™: ${permission}\n`;
                }
            });

            showResult('permissionResults', `
                <div><strong>æƒé™æ£€æŸ¥ç»“æœ:</strong></div>
                <div style="margin-top: 10px;">
                    <pre>${permissionCheckResult}</pre>
                </div>
                <div style="margin-top: 10px;">
                    <strong>ç”¨æˆ·å®Œæ•´ä¿¡æ¯:</strong><br>
                    <pre>${JSON.stringify(currentUser, null, 2)}</pre>
                </div>
            `, permissions.includes('*') && role === 'admin' ? 'success' : 'error');
        }

        // æµ‹è¯•APIç«¯ç‚¹
        async function testAPIEndpoints() {
            const endpoints = [
                { url: '/api/auth/health', method: 'GET', name: 'è®¤è¯æœåŠ¡å¥åº·æ£€æŸ¥' },
                { url: '/api/elderly/page', method: 'POST', name: 'è€äººç®¡ç†åˆ†é¡µæŸ¥è¯¢', requiresAuth: true },
                { url: '/api/user/list', method: 'GET', name: 'ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢', requiresAuth: true },
                { url: '/api/health-warning/list', method: 'GET', name: 'å¥åº·é¢„è­¦åˆ—è¡¨', requiresAuth: true }
            ];

            let results = '';

            for (const endpoint of endpoints) {
                try {
                    const options = {
                        method: endpoint.method,
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    };

                    if (endpoint.requiresAuth && currentToken) {
                        options.headers['Authorization'] = `Bearer ${currentToken}`;
                    }

                    if (endpoint.method === 'POST' && endpoint.url.includes('/page')) {
                        options.body = JSON.stringify({ current: 1, size: 10 });
                    }

                    const response = await fetch(`${BACKEND_URL}${endpoint.url}`, options);
                    
                    if (response.ok) {
                        results += `âœ… ${endpoint.name} - çŠ¶æ€ç : ${response.status}\n`;
                    } else {
                        results += `âŒ ${endpoint.name} - çŠ¶æ€ç : ${response.status}\n`;
                    }
                } catch (error) {
                    results += `âŒ ${endpoint.name} - é”™è¯¯: ${error.message}\n`;
                }
            }

            showResult('apiResults', `
                <div><strong>APIç«¯ç‚¹æµ‹è¯•ç»“æœ:</strong></div>
                <div style="margin-top: 10px;">
                    <pre>${results}</pre>
                </div>
            `, 'info');
        }

        // æµ‹è¯•å®‰å…¨é…ç½®
        async function testSecurityConfig() {
            const testUrls = [
                { url: '/api/elderly/page', desc: 'è€äººç®¡ç†APIï¼ˆéœ€è¦è®¤è¯ï¼‰' },
                { url: '/api/auth/health', desc: 'è®¤è¯å¥åº·æ£€æŸ¥ï¼ˆå…¬å¼€ï¼‰' },
                { url: '/swagger-ui/index.html', desc: 'Swaggeræ–‡æ¡£ï¼ˆå…¬å¼€ï¼‰' }
            ];

            let results = '';

            for (const testUrl of testUrls) {
                try {
                    // æµ‹è¯•ä¸å¸¦tokençš„è¯·æ±‚
                    const responseNoAuth = await fetch(`${BACKEND_URL}${testUrl.url}`);
                    
                    if (testUrl.url.includes('/api/elderly/') || testUrl.url.includes('/api/user/')) {
                        if (responseNoAuth.status === 401 || responseNoAuth.status === 403) {
                            results += `âœ… ${testUrl.desc} - æ­£ç¡®æ‹’ç»æœªæˆæƒè®¿é—®\n`;
                        } else {
                            results += `âš ï¸ ${testUrl.desc} - åº”è¯¥æ‹’ç»æœªæˆæƒè®¿é—®ä½†æ²¡æœ‰æ‹’ç»\n`;
                        }
                    } else {
                        if (responseNoAuth.status === 200) {
                            results += `âœ… ${testUrl.desc} - æ­£ç¡®å…è®¸å…¬å¼€è®¿é—®\n`;
                        } else {
                            results += `âŒ ${testUrl.desc} - åº”è¯¥å…è®¸å…¬å¼€è®¿é—®ä½†è¢«æ‹’ç»\n`;
                        }
                    }
                } catch (error) {
                    results += `âŒ ${testUrl.desc} - æµ‹è¯•å¤±è´¥: ${error.message}\n`;
                }
            }

            showResult('apiResults', `
                <div><strong>å®‰å…¨é…ç½®æµ‹è¯•ç»“æœ:</strong></div>
                <div style="margin-top: 10px;">
                    <pre>${results}</pre>
                </div>
            `, 'info');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€
        window.addEventListener('load', () => {
            checkBackendStatus();
        });
    </script>
</body>
</html>
