<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备管理菜单修复工具</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .step {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background-color 0.3s;
            width: 100%;
        }
        button:hover {
            background: #2980b9;
        }
        .success {
            background: #d5f4e6;
            color: #27ae60;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background: #fdf2f2;
            color: #e74c3c;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            background: #e3f2fd;
            color: #1976d2;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        #status {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 设备管理菜单修复工具</h1>
        
        <div class="step">
            <h3>步骤1: 修复登录状态</h3>
            <p>确保用户以管理员身份登录，拥有设备管理访问权限。</p>
            <button onclick="fixLoginStatus()">修复登录状态</button>
        </div>
        
        <div class="step">
            <h3>步骤2: 打开前端页面</h3>
            <p>在新标签页中打开前端页面，检查侧边栏是否显示设备管理菜单。</p>
            <button onclick="openFrontend()">打开前端页面</button>
        </div>
        
        <div class="step">
            <h3>步骤3: 直接访问设备管理</h3>
            <p>如果侧边栏仍然没有显示，直接访问设备管理页面。</p>
            <button onclick="openEquipmentPage()">直接访问设备管理</button>
        </div>
        
        <div class="step">
            <h3>步骤4: 清除缓存重试</h3>
            <p>如果问题仍然存在，清除浏览器缓存并重新登录。</p>
            <button onclick="clearCacheAndRetry()">清除缓存重试</button>
        </div>
        
        <div id="status"></div>
    </div>

    <script>
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function fixLoginStatus() {
            try {
                // 设置管理员登录状态
                const adminData = {
                    id: 1,
                    username: 'admin',
                    name: '系统管理员',
                    role: 'admin',
                    roleText: '系统管理员',
                    permissions: ['*'],
                    avatar: '',
                    department: '系统管理部',
                    phone: '13800138000',
                    email: 'admin@smartcare.com',
                    description: '拥有系统全部管理权限，负责平台整体运营管理'
                };
                
                const token = `fixed_admin_token_${Date.now()}`;
                
                localStorage.setItem('token', token);
                localStorage.setItem('userInfo', JSON.stringify(adminData));
                
                showStatus('✅ 管理员登录状态已修复！Token和用户信息已设置。', 'success');
                
                console.log('🔧 登录状态修复完成:');
                console.log('Token:', token);
                console.log('User Info:', adminData);
                
            } catch (error) {
                showStatus('❌ 修复失败: ' + error.message, 'error');
            }
        }

        function openFrontend() {
            const url = 'http://localhost:3001';
            window.open(url, '_blank');
            showStatus(`🌐 正在打开前端页面: ${url}`, 'info');
            showStatus('请检查侧边栏是否显示"设备管理"菜单项。如果显示，点击测试跳转功能。', 'info');
        }

        function openEquipmentPage() {
            const equipmentUrls = [
                'http://localhost:3001/equipment',
                'http://localhost:3001/equipment/list'
            ];
            
            equipmentUrls.forEach(url => {
                window.open(url, '_blank');
            });
            
            showStatus('🔧 已打开设备管理页面的多个URL，请检查哪个能正常访问。', 'info');
        }

        function clearCacheAndRetry() {
            try {
                // 清除所有本地存储
                localStorage.clear();
                sessionStorage.clear();
                
                showStatus('🧹 本地存储已清除。', 'info');
                
                // 等待一秒后重新设置登录状态
                setTimeout(() => {
                    fixLoginStatus();
                    showStatus('🔄 请刷新前端页面重新登录，或使用上方按钮重新打开前端页面。', 'info');
                }, 1000);
                
            } catch (error) {
                showStatus('❌ 清除缓存失败: ' + error.message, 'error');
            }
        }

        // 页面加载时检查当前状态
        window.onload = function() {
            const token = localStorage.getItem('token');
            const userInfo = localStorage.getItem('userInfo');
            
            if (token && userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    showStatus(`📊 检测到现有登录状态 - 用户: ${user.name || user.username} (${user.role})`, 'info');
                } catch (error) {
                    showStatus('⚠️ 检测到登录状态异常，建议重新修复。', 'error');
                }
            } else {
                showStatus('⚠️ 未检测到登录状态，请点击"修复登录状态"按钮。', 'error');
            }
        };
    </script>
</body>
</html>
