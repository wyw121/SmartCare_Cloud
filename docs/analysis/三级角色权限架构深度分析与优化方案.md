# 智慧医养平台 - 三级角色权限架构深度分析与优化方案

## 📋 目录

- [一、现状分析](#一现状分析)
- [二、严重问题识别](#二严重问题识别)
- [三、优化后的角色权限架构](#三优化后的角色权限架构)
- [四、数据管理规划](#四数据管理规划)
- [五、实施计划](#五实施计划)

---

## 一、现状分析

### 1.1 当前角色权限配置

#### 🔴 **系统管理员 (admin)**

**可访问页面:**

- ✅ 首页仪表板 (`/dashboard`)
- ✅ 老人档案管理 (`/elderly/list`, `/elderly/detail`, `/elderly/add`, `/elderly/edit`)
- ✅ 医生管理 (`/doctor/list`)
- ✅ 健康管理 (`/health/warning`, `/health/records`, `/health/assessment`)
- ✅ 设备管理 (`/equipment/list`, `/equipment/monitor`)
- ✅ 报表统计 (`/reports/statistics`, `/reports/analysis`)
- ✅ 系统管理 (`/system/users`, `/system/roles`, `/system/permissions`)
- ✅ 个人中心 (`/profile`)

**权限范围:**

```javascript
permissions: ['*']  // 拥有所有权限
features: {
  system: ['user:manage', 'role:manage', 'permission:manage', 'config:manage'],
  elderly: ['view', 'add', 'edit', 'delete', 'export'],
  health: ['view', 'add', 'edit', 'delete', 'manage', 'warning:handle'],
  assessment: ['view', 'add', 'edit', 'delete', 'export'],
  equipment: ['view', 'add', 'edit', 'delete', 'monitor'],
  report: ['view', 'export', 'analyze'],
  analysis: ['view', 'manage']
}
```

**数据访问范围:**

- 所有老人档案
- 所有医生信息
- 所有健康记录和预警
- 所有系统用户
- 所有设备数据
- 全部统计报表

---

#### 🟡 **医生 (doctor)**

**可访问页面:**

- ✅ 首页仪表板 (`/dashboard`)
- ✅ 老人档案列表 (`/elderly/list`, `/elderly/detail`, `/elderly/profile`)
- ✅ 健康预警 (`/health/warning`)
- ✅ 健康记录 (`/health/records`)
- ✅ 评估报告 (`/health/assessment`)
- ✅ 设备监控 (`/equipment/list`, `/equipment/monitor`)
- ✅ 报表统计 (`/reports/statistics`, `/reports/analysis`)
- ✅ 个人中心 (`/profile`)
- ❌ 医生管理 (不可访问)
- ❌ 系统管理 (不可访问)

**权限范围:**

```javascript
permissions: [
  'dashboard:view',
  'elderly:view',
  'elderly:add',
  'elderly:edit',
  'elderly:export',
  'health:view',
  'health:add',
  'health:edit',
  'health:manage',
  'health-warning:view',
  'health-warning:handle',
  'health-warning:export',
  'assessment:view',
  'assessment:add',
  'assessment:edit',
  'assessment:export',
  'equipment:view',
  'equipment:monitor',
  'report:view',
  'report:export',
  'analysis:view',
]
```

**数据访问范围:**

- 所有老人档案（⚠️ **问题**: 没有按照科室或负责范围限制）
- 所有健康记录和预警
- 所有评估报告
- 所有设备数据
- 全部统计报表

---

#### 🟢 **家属 (family)**

**可访问页面:**

- ✅ 首页仪表板 (`/dashboard`)
- ✅ 我的关联长辈 (`/elderly/family-view`)
- ✅ 老人详情 (`/elderly/detail/:id`, `/elderly/profile/:id`)
- ✅ 健康档案 (`/elderly/health-records/:id`)
- ✅ 健康预警 (`/health/warning`)
- ✅ 个人中心 (`/profile`)
- ❌ 老人档案列表 (强制重定向到 `/elderly/family-view`)
- ❌ 医生管理 (不可访问)
- ❌ 系统管理 (不可访问)
- ❌ 设备管理 (不可访问)
- ❌ 报表统计 (不可访问)

**权限范围:**

```javascript
permissions: [
  'dashboard:view',
  'elderly:view',
  'health:view',
  'health-warning:view',
  'report:view',
]
```

**数据访问范围:**

- ⚠️ **仅限关联的老人** (通过 `family_elderly_relation` 表控制)
- ⚠️ **访问级别控制**: basic(基础信息) / health(健康概要) / emergency(紧急联系)
- 关联老人的健康记录和预警

---

### 1.2 当前数据模型分析

#### 核心实体表

| 实体                  | 表名                      | 用途         | 关键字段                                          |
| --------------------- | ------------------------- | ------------ | ------------------------------------------------- |
| User                  | `sys_user`                | 系统用户     | id, username, role_code, role_name                |
| Elderly               | `elderly`                 | 老人档案     | id, name, id_card, health_status, care_level      |
| Doctor                | `t_doctor`                | 医生信息     | id, name, department, title, specialization       |
| FamilyElderlyRelation | `family_elderly_relation` | 家属老人关联 | family_id, elderly_id, relationship, access_level |
| HealthRecord          | `health_record`           | 健康记录     | elderly_id, record_date, health_data              |
| HealthWarning         | `health_warning`          | 健康预警     | elderly_id, warning_level, warning_type, status   |
| Equipment             | `equipment`               | 设备台账     | id, device_type, status, elderly_id               |
| Role                  | `sys_role`                | 角色定义     | id, role_code, role_name                          |
| Permission            | `sys_permission`          | 权限定义     | id, permission_code, permission_name              |

---

## 二、严重问题识别

### 🚨 **问题 1: 医生权限过大,缺乏数据隔离**

**问题描述:**

- 医生可以访问**所有老人档案**,没有按科室或负责范围限制
- 医生可以查看**所有健康预警**,包括非本人负责的老人
- 医生可以查看**所有报表数据**,存在数据泄露风险

**安全风险:**

- ⚠️ 违反"最小权限原则"
- ⚠️ 医生可能查看与自己无关的敏感信息
- ⚠️ 无法追溯医生对特定老人的操作记录

**缺失的数据表:**

- ❌ `doctor_elderly_relation` (医生-老人绑定关系表)
- ❌ 老人档案中缺少 `responsible_doctor_id` 字段

---

### 🚨 **问题 2: 家属权限控制不完善**

**问题描述:**

- 家属虽然有 `family_elderly_relation` 关联表,但实际权限控制不够细粒度
- 家属可以通过修改 URL 访问非关联老人的详情 (⚠️ **严重安全漏洞**)
- 缺少家属操作审计日志

**安全风险:**

- 🔴 **前端路由拦截不够**: 仅依赖前端重定向,后端 API 可能未严格校验
- 🔴 **越权访问风险**: 家属可能通过 API 直接访问非关联老人数据
- ⚠️ 缺少操作审计,无法追溯家属查看了哪些信息

**缺失的功能:**

- ❌ 后端 API 层面的家属权限校验中间件
- ❌ 家属查看老人信息的审计日志
- ❌ 家属申请查看新老人的工作流

---

### 🚨 **问题 3: 角色定义不清晰,功能模块混乱**

**问题描述:**

- **管理员角色过于笼统**: 既负责系统管理,又能直接管理老人和医生
- **缺少细分角色**:
  - 没有"护工"角色
  - 没有"社工"角色
  - 没有"养老院管理员"角色
  - 没有"医院管理员"角色
- **医生角色功能不匹配**:
  - 医生可以新增老人档案 (应该由行政人员负责)
  - 医生可以查看所有报表 (应该限制为本人相关数据)

**业务影响:**

- ⚠️ 无法准确反映医养结合的业务场景
- ⚠️ 无法区分医疗机构和养老机构的不同需求
- ⚠️ 权限边界模糊,容易产生误操作

---

### 🚨 **问题 4: 数据完整性和一致性问题**

**问题描述:**

- **老人档案字段不完整**:
  - 缺少"入住日期"、"入住类型"(长期/短期)
  - 缺少"责任医生"、"责任护工"、"责任社工"
  - 缺少"家族病史"详细记录
- **医生信息字段不完整**:
  - 缺少"医生所属机构"(医院还是养老院)
  - 缺少"医生排班信息"
  - 缺少"医生服务范围"(科室/病区)
- **健康预警缺少闭环流程**:
  - 预警生成后,缺少"处理人分配"流程
  - 缺少"处理时限"字段
  - 缺少"处理结果评价"

**数据质量影响:**

- ⚠️ 无法准确统计医生工作量
- ⚠️ 无法生成准确的老人健康趋势报告
- ⚠️ 预警处理流程不规范

---

### 🚨 **问题 5: 缺少关键业务数据表**

**当前缺失的重要数据表:**

| 缺失表名                  | 用途                  | 重要性 |
| ------------------------- | --------------------- | ------ |
| `doctor_elderly_relation` | 医生-老人负责关系     | 🔴 高  |
| `nurse_info`              | 护工信息              | 🔴 高  |
| `social_worker_info`      | 社工信息              | 🟡 中  |
| `organization_info`       | 机构信息(医院/养老院) | 🔴 高  |
| `department_info`         | 科室/病区信息         | 🟡 中  |
| `appointment_record`      | 预约记录              | 🟡 中  |
| `medication_record`       | 用药记录              | 🔴 高  |
| `visit_record`            | 巡诊记录              | 🔴 高  |
| `nursing_record`          | 护理记录              | 🔴 高  |
| `operation_log`           | 操作审计日志          | 🔴 高  |
| `notification_record`     | 通知记录              | 🟡 中  |

---

## 三、优化后的角色权限架构

### 3.1 重新定义角色体系

#### **第一层: 核心管理角色**

##### 🔴 **1. 系统管理员 (system_admin)**

**职责:** 系统技术管理,不涉及业务数据

**页面权限:**

- ✅ 系统管理 (用户、角色、权限、配置)
- ✅ 操作日志查看
- ✅ 系统监控与维护
- ❌ 不能直接管理老人、医生等业务数据

**数据范围:**

- 所有系统用户账号
- 所有角色和权限配置
- 系统日志和审计数据

---

##### 🟡 **2. 业务管理员 (business_admin)**

**职责:** 业务数据管理,机构运营管理

**页面权限:**

- ✅ 首页仪表板 (全局数据)
- ✅ 老人档案管理 (全部)
- ✅ 医生管理 (全部)
- ✅ 护工管理 (全部)
- ✅ 设备管理 (全部)
- ✅ 报表统计 (全部)
- ✅ 数据分析 (全部)
- ✅ 机构管理
- ❌ 系统配置 (不涉及技术配置)

**数据范围:**

- 本机构的所有老人档案
- 本机构的所有医护人员
- 本机构的所有设备
- 本机构的所有统计报表

---

#### **第二层: 专业服务角色**

##### 🩺 **3. 医生 (doctor)**

**职责:** 医疗诊断,健康评估,预警处理

**页面权限:**

- ✅ 工作台 (本人待处理事项)
- ✅ 我负责的老人 (仅限本人负责的老人)
- ✅ 健康预警 (仅限本人负责的老人)
- ✅ 健康记录 (仅限本人负责的老人)
- ✅ 评估报告 (仅限本人负责的老人)
- ✅ 用药记录 (仅限本人负责的老人)
- ✅ 巡诊记录 (本人的巡诊记录)
- ✅ 个人中心
- ❌ 老人档案编辑 (只读)
- ❌ 医生管理
- ❌ 全局报表

**数据范围:**

- **本人负责的老人档案** (通过 `doctor_elderly_relation` 表)
- **本人处理的健康预警**
- **本人创建的评估报告**
- **本人的工作统计数据**

**核心功能:**

1. 查看负责老人的健康档案
2. 处理健康预警
3. 录入健康评估报告
4. 记录巡诊信息
5. 开具医嘱和用药建议
6. 查看本人工作统计

---

##### 👩‍⚕️ **4. 护工 (nurse)**

**职责:** 日常照护,生活护理,体征监测

**页面权限:**

- ✅ 工作台 (今日护理任务)
- ✅ 我照护的老人 (仅限本人负责的老人)
- ✅ 护理记录 (录入和查看)
- ✅ 体征监测 (录入数据)
- ✅ 健康预警查看 (仅限本人照护的老人)
- ✅ 设备使用记录
- ✅ 个人中心
- ❌ 评估报告 (只读)
- ❌ 用药记录 (只读)

**数据范围:**

- 本人照护的老人基础信息
- 本人的护理记录
- 本人监测的体征数据

**核心功能:**

1. 录入日常护理记录
2. 监测和录入体征数据
3. 查看护理任务清单
4. 上报异常情况
5. 使用和记录设备使用情况

---

##### 🤝 **5. 社工 (social_worker)**

**职责:** 心理关怀,活动组织,家属沟通

**页面权限:**

- ✅ 工作台 (本周活动计划)
- ✅ 服务对象管理 (本人服务的老人)
- ✅ 活动记录
- ✅ 访谈记录
- ✅ 家属沟通记录
- ✅ 个人中心
- ❌ 健康记录 (只读基础信息)

**数据范围:**

- 本人服务的老人基础信息
- 本人的活动记录
- 本人的访谈和沟通记录

---

#### **第三层: 外部查看角色**

##### 👨‍👩‍👧 **6. 家属 (family)**

**职责:** 查看关联长辈信息,接收通知

**页面权限:**

- ✅ 首页 (关联长辈概况)
- ✅ 我的长辈 (仅限关联的老人)
- ✅ 健康档案 (根据访问级别控制)
- ✅ 健康预警通知 (仅限关联老人)
- ✅ 生活记录查看
- ✅ 探视预约
- ✅ 个人中心
- ❌ 所有管理功能

**数据范围:**

- **严格限制**: 仅能访问 `family_elderly_relation` 表中关联的老人
- **分级访问控制**:
  - **basic**: 基础信息 (姓名、年龄、房间号)
  - **health**: 健康概要 (健康状态、预警摘要)
  - **full**: 完整信息 (详细健康记录、用药记录)

**核心功能:**

1. 查看关联长辈基本信息
2. 接收健康预警通知
3. 查看生活照片和记录
4. 预约探视时间
5. 在线沟通 (留言)

---

### 3.2 权限配置表 (对照表)

| 功能模块          | 系统管理员 | 业务管理员 | 医生          | 护工        | 社工      | 家属      |
| ----------------- | ---------- | ---------- | ------------- | ----------- | --------- | --------- |
| **系统管理**      | ✅ 全部    | ❌         | ❌            | ❌          | ❌        | ❌        |
| **机构管理**      | ❌         | ✅ 全部    | ❌            | ❌          | ❌        | ❌        |
| **老人档案-查看** | ❌         | ✅ 全部    | ✅ 负责的     | ✅ 照护的   | ✅ 服务的 | ✅ 关联的 |
| **老人档案-编辑** | ❌         | ✅ 全部    | ❌            | ❌          | ❌        | ❌        |
| **医生管理**      | ❌         | ✅ 全部    | ❌            | ❌          | ❌        | ❌        |
| **护工管理**      | ❌         | ✅ 全部    | ❌            | ❌          | ❌        | ❌        |
| **健康预警-查看** | ❌         | ✅ 全部    | ✅ 负责的     | ✅ 照护的   | ❌        | ✅ 关联的 |
| **健康预警-处理** | ❌         | ✅ 全部    | ✅ 负责的     | ⚠️ 上报     | ❌        | ❌        |
| **评估报告-查看** | ❌         | ✅ 全部    | ✅ 负责的     | 📖 只读     | ❌        | ⚠️ 摘要   |
| **评估报告-编辑** | ❌         | ✅ 全部    | ✅ 自己创建的 | ❌          | ❌        | ❌        |
| **护理记录**      | ❌         | ✅ 全部    | 📖 只读       | ✅ 照护的   | ❌        | ⚠️ 摘要   |
| **用药记录**      | ❌         | ✅ 全部    | ✅ 负责的     | 📖 只读     | ❌        | ⚠️ 摘要   |
| **巡诊记录**      | ❌         | ✅ 全部    | ✅ 自己的     | ❌          | ❌        | ❌        |
| **设备管理**      | ❌         | ✅ 全部    | 📖 查看       | ⚠️ 使用记录 | ❌        | ❌        |
| **报表统计**      | ❌         | ✅ 全部    | ⚠️ 个人       | ⚠️ 个人     | ⚠️ 个人   | ❌        |
| **数据分析**      | ❌         | ✅ 全部    | ❌            | ❌          | ❌        | ❌        |

**图例:**

- ✅ 全部权限
- ⚠️ 部分权限
- 📖 只读权限
- ❌ 无权限

---

## 四、数据管理规划

### 4.1 需要新增的数据表

#### **1. 医生-老人绑定关系表 (`doctor_elderly_relation`)**

**用途:** 建立医生与老人的责任关系,实现数据隔离

```sql
CREATE TABLE `doctor_elderly_relation` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `doctor_id` BIGINT NOT NULL COMMENT '医生ID',
  `elderly_id` BIGINT NOT NULL COMMENT '老人ID',
  `relationship_type` VARCHAR(20) NOT NULL COMMENT '关系类型: primary-主治医生, assistant-协助医生, consultant-会诊医生',
  `start_date` DATE NOT NULL COMMENT '开始负责日期',
  `end_date` DATE COMMENT '结束负责日期',
  `status` TINYINT DEFAULT 1 COMMENT '状态: 0-无效, 1-有效',
  `remark` VARCHAR(500) COMMENT '备注',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `create_by` BIGINT,
  `update_by` BIGINT,
  `is_deleted` TINYINT DEFAULT 0,
  PRIMARY KEY (`id`),
  INDEX `idx_doctor_id` (`doctor_id`),
  INDEX `idx_elderly_id` (`elderly_id`),
  INDEX `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='医生-老人关系表';
```

**关键数据项:**

- `relationship_type`: primary(主治医生)、assistant(协助医生)、consultant(会诊医生)
- `status`: 支持动态调整医生负责关系

---

#### **2. 护工信息表 (`nurse_info`)**

```sql
CREATE TABLE `nurse_info` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `employee_number` VARCHAR(50) NOT NULL COMMENT '工号',
  `name` VARCHAR(50) NOT NULL COMMENT '姓名',
  `gender` TINYINT COMMENT '性别: 1-男, 0-女',
  `phone` VARCHAR(20) COMMENT '联系电话',
  `id_card` VARCHAR(18) COMMENT '身份证号',
  `entry_date` DATE COMMENT '入职日期',
  `certificate_type` VARCHAR(50) COMMENT '证书类型',
  `certificate_number` VARCHAR(50) COMMENT '证书编号',
  `work_area` VARCHAR(100) COMMENT '工作区域',
  `status` TINYINT DEFAULT 1 COMMENT '状态: 0-离职, 1-在职',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `is_deleted` TINYINT DEFAULT 0,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_employee_number` (`employee_number`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='护工信息表';
```

---

#### **3. 护工-老人绑定关系表 (`nurse_elderly_relation`)**

```sql
CREATE TABLE `nurse_elderly_relation` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `nurse_id` BIGINT NOT NULL COMMENT '护工ID',
  `elderly_id` BIGINT NOT NULL COMMENT '老人ID',
  `care_level` TINYINT COMMENT '照护等级: 1-一级, 2-二级, 3-三级',
  `start_date` DATE NOT NULL COMMENT '开始照护日期',
  `end_date` DATE COMMENT '结束照护日期',
  `status` TINYINT DEFAULT 1 COMMENT '状态',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `is_deleted` TINYINT DEFAULT 0,
  PRIMARY KEY (`id`),
  INDEX `idx_nurse_id` (`nurse_id`),
  INDEX `idx_elderly_id` (`elderly_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='护工-老人关系表';
```

---

#### **4. 护理记录表 (`nursing_record`)**

```sql
CREATE TABLE `nursing_record` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `elderly_id` BIGINT NOT NULL COMMENT '老人ID',
  `nurse_id` BIGINT NOT NULL COMMENT '护工ID',
  `record_date` DATE NOT NULL COMMENT '记录日期',
  `record_time` TIME NOT NULL COMMENT '记录时间',
  `care_type` VARCHAR(50) COMMENT '护理类型: 晨间护理, 晚间护理, 喂食, 翻身, 清洁等',
  `care_content` TEXT COMMENT '护理内容',
  `elderly_status` VARCHAR(200) COMMENT '老人状态',
  `abnormal_situation` VARCHAR(500) COMMENT '异常情况',
  `images` JSON COMMENT '护理照片',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  INDEX `idx_elderly_date` (`elderly_id`, `record_date`),
  INDEX `idx_nurse_date` (`nurse_id`, `record_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='护理记录表';
```

---

#### **5. 用药记录表 (`medication_record`)**

```sql
CREATE TABLE `medication_record` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `elderly_id` BIGINT NOT NULL COMMENT '老人ID',
  `doctor_id` BIGINT COMMENT '开具医生ID',
  `medication_name` VARCHAR(100) NOT NULL COMMENT '药品名称',
  `medication_type` VARCHAR(50) COMMENT '药品类型',
  `dosage` VARCHAR(50) COMMENT '剂量',
  `frequency` VARCHAR(50) COMMENT '服用频率',
  `start_date` DATE NOT NULL COMMENT '开始日期',
  `end_date` DATE COMMENT '结束日期',
  `administration_route` VARCHAR(50) COMMENT '给药途径: 口服, 注射, 外用等',
  `purpose` VARCHAR(200) COMMENT '用药目的',
  `side_effects` VARCHAR(500) COMMENT '可能副作用',
  `precautions` VARCHAR(500) COMMENT '注意事项',
  `actual_records` JSON COMMENT '实际服药记录: [{date, time, operator_id, status}]',
  `status` TINYINT DEFAULT 1 COMMENT '状态: 0-已停用, 1-使用中',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  INDEX `idx_elderly_id` (`elderly_id`),
  INDEX `idx_doctor_id` (`doctor_id`),
  INDEX `idx_status_date` (`status`, `start_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用药记录表';
```

---

#### **6. 巡诊记录表 (`visit_record`)**

```sql
CREATE TABLE `visit_record` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `elderly_id` BIGINT NOT NULL COMMENT '老人ID',
  `doctor_id` BIGINT NOT NULL COMMENT '医生ID',
  `visit_date` DATE NOT NULL COMMENT '巡诊日期',
  `visit_time` TIME NOT NULL COMMENT '巡诊时间',
  `chief_complaint` VARCHAR(500) COMMENT '主诉',
  `symptoms` TEXT COMMENT '症状描述',
  `physical_exam` TEXT COMMENT '体格检查',
  `diagnosis` VARCHAR(500) COMMENT '诊断',
  `treatment_plan` TEXT COMMENT '治疗方案',
  `prescription` JSON COMMENT '处方: [{drug_name, dosage, frequency, duration}]',
  `next_visit_date` DATE COMMENT '下次巡诊日期',
  `remarks` TEXT COMMENT '备注',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  INDEX `idx_elderly_date` (`elderly_id`, `visit_date`),
  INDEX `idx_doctor_date` (`doctor_id`, `visit_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='巡诊记录表';
```

---

#### **7. 机构信息表 (`organization_info`)**

```sql
CREATE TABLE `organization_info` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `org_code` VARCHAR(50) NOT NULL COMMENT '机构编码',
  `org_name` VARCHAR(100) NOT NULL COMMENT '机构名称',
  `org_type` VARCHAR(20) COMMENT '机构类型: hospital-医院, nursing_home-养老院, community-社区',
  `parent_org_id` BIGINT COMMENT '上级机构ID',
  `contact_person` VARCHAR(50) COMMENT '联系人',
  `contact_phone` VARCHAR(20) COMMENT '联系电话',
  `address` VARCHAR(200) COMMENT '地址',
  `capacity` INT COMMENT '床位数/容量',
  `status` TINYINT DEFAULT 1 COMMENT '状态',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_org_code` (`org_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='机构信息表';
```

---

#### **8. 操作审计日志表 (`operation_log`)**

```sql
CREATE TABLE `operation_log` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '操作用户ID',
  `user_role` VARCHAR(20) COMMENT '用户角色',
  `operation_type` VARCHAR(50) COMMENT '操作类型: view, add, edit, delete, export',
  `operation_module` VARCHAR(50) COMMENT '操作模块',
  `target_type` VARCHAR(50) COMMENT '目标类型: elderly, doctor, health_record等',
  `target_id` BIGINT COMMENT '目标ID',
  `operation_detail` TEXT COMMENT '操作详情',
  `ip_address` VARCHAR(50) COMMENT 'IP地址',
  `user_agent` VARCHAR(500) COMMENT '用户代理',
  `operation_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  `execution_time` INT COMMENT '执行时长(ms)',
  `status` TINYINT COMMENT '状态: 0-失败, 1-成功',
  `error_message` TEXT COMMENT '错误信息',
  PRIMARY KEY (`id`),
  INDEX `idx_user_time` (`user_id`, `operation_time`),
  INDEX `idx_target` (`target_type`, `target_id`),
  INDEX `idx_operation_time` (`operation_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='操作审计日志表';
```

---

### 4.2 需要补充的字段

#### **老人档案表 (`elderly`) 新增字段**

```sql
ALTER TABLE `elderly`
ADD COLUMN `organization_id` BIGINT COMMENT '所属机构ID' AFTER `id`,
ADD COLUMN `admission_date` DATE COMMENT '入住日期',
ADD COLUMN `admission_type` VARCHAR(20) COMMENT '入住类型: long_term-长期, short_term-短期, respite-临时',
ADD COLUMN `responsible_doctor_id` BIGINT COMMENT '责任医生ID',
ADD COLUMN `responsible_nurse_id` BIGINT COMMENT '责任护工ID',
ADD COLUMN `responsible_social_worker_id` BIGINT COMMENT '责任社工ID',
ADD COLUMN `family_medical_history` TEXT COMMENT '家族病史',
ADD COLUMN `allergy_history` TEXT COMMENT '过敏史',
ADD COLUMN `chronic_diseases` JSON COMMENT '慢性病列表: [{disease_name, diagnosis_date, severity}]',
ADD COLUMN `disability_level` TINYINT COMMENT '失能等级: 1-自理, 2-轻度, 3-中度, 4-重度',
ADD COLUMN `mental_status` VARCHAR(50) COMMENT '精神状态',
ADD COLUMN `payment_method` VARCHAR(50) COMMENT '支付方式: self-自费, insurance-医保, government-政府补贴',
ADD INDEX `idx_organization` (`organization_id`),
ADD INDEX `idx_responsible_doctor` (`responsible_doctor_id`),
ADD INDEX `idx_admission_date` (`admission_date`);
```

---

#### **医生表 (`t_doctor`) 新增字段**

```sql
ALTER TABLE `t_doctor`
ADD COLUMN `organization_id` BIGINT COMMENT '所属机构ID',
ADD COLUMN `user_id` BIGINT COMMENT '关联系统用户ID',
ADD COLUMN `work_schedule` JSON COMMENT '排班信息: [{day_of_week, start_time, end_time, location}]',
ADD COLUMN `service_scope` VARCHAR(200) COMMENT '服务范围',
ADD COLUMN `max_patients` INT DEFAULT 50 COMMENT '最大负责老人数',
ADD INDEX `idx_organization` (`organization_id`),
ADD INDEX `idx_user` (`user_id`);
```

---

#### **健康预警表 (`health_warning`) 新增字段**

```sql
ALTER TABLE `health_warning`
ADD COLUMN `assigned_doctor_id` BIGINT COMMENT '分配处理医生ID',
ADD COLUMN `assigned_time` DATETIME COMMENT '分配时间',
ADD COLUMN `handle_deadline` DATETIME COMMENT '处理时限',
ADD COLUMN `handle_result` TEXT COMMENT '处理结果',
ADD COLUMN `handle_evaluation` VARCHAR(500) COMMENT '处理评价',
ADD INDEX `idx_assigned_doctor` (`assigned_doctor_id`),
ADD INDEX `idx_deadline` (`handle_deadline`);
```

---

### 4.3 模拟数据生成计划

#### **阶段 1: 基础数据 (优先级: 🔴 高)**

1. **机构数据** (1 个总机构 + 3 个分支)

   - 1 个医养结合中心(总部)
   - 1 个附属医院
   - 2 个养老院

2. **人员数据**

   - 系统管理员: 2 名
   - 业务管理员: 3 名 (每个机构 1 名)
   - 医生: 10 名 (内科 5 名, 康复科 3 名, 中医科 2 名)
   - 护工: 20 名
   - 社工: 5 名
   - 家属: 50 名

3. **老人档案数据**

   - 100 位老人
   - 覆盖不同照护等级
   - 覆盖不同健康状态
   - 覆盖不同支付方式

4. **关联关系数据**

   - 医生-老人绑定: 每个医生负责 8-12 位老人
   - 护工-老人绑定: 每个护工照护 3-5 位老人
   - 家属-老人绑定: 每位老人关联 1-3 位家属

---

#### **阶段 2: 业务数据 (优先级: 🟡 中)**

1. **健康记录数据**

   - 每位老人最近 3 个月的健康记录
   - 包含体征数据、检查报告

2. **健康预警数据**

   - 最近 1 个月的预警记录
   - 包含已处理和待处理状态

3. **用药记录数据**

   - 当前在用药物
   - 历史用药记录

4. **护理记录数据**

   - 最近 1 个月的护理记录
   - 包含晨间护理、晚间护理、特殊护理

5. **巡诊记录数据**

   - 最近 1 个月的巡诊记录

---

#### **阶段 3: 统计数据 (优先级: 🟢 低)**

1. **设备数据**

   - 血压计、血糖仪等设备台账
   - 设备使用记录

2. **评估报告数据**

   - 健康评估报告
   - 能力评估报告

3. **操作日志数据**

   - 最近 1 周的操作日志

---

### 4.4 数据生成脚本示例

**示例: 生成医生-老人绑定关系数据**

```javascript
// generate-doctor-elderly-relations.js
const doctorIds = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
const elderlyIds = Array.from({ length: 100 }, (_, i) => i + 1)

const relations = []
let elderlyIndex = 0

doctorIds.forEach((doctorId) => {
  // 每个医生负责8-12位老人
  const patientCount = Math.floor(Math.random() * 5) + 8

  for (let i = 0; i < patientCount && elderlyIndex < elderlyIds.length; i++) {
    relations.push({
      doctor_id: doctorId,
      elderly_id: elderlyIds[elderlyIndex],
      relationship_type: 'primary',
      start_date: '2024-01-01',
      status: 1,
    })
    elderlyIndex++
  }
})

// 输出SQL
console.log(
  'INSERT INTO doctor_elderly_relation (doctor_id, elderly_id, relationship_type, start_date, status) VALUES'
)
console.log(
  relations
    .map(
      (r) =>
        `(${r.doctor_id}, ${r.elderly_id}, '${r.relationship_type}', '${r.start_date}', ${r.status})`
    )
    .join(',\n') + ';'
)
```

---

## 五、实施计划

### 阶段 1: 数据模型优化 (预计 2 周)

**第 1 周: 数据库设计和创建**

- [ ] 创建新增的 7 个数据表
- [ ] 为现有表添加缺失字段
- [ ] 创建索引和外键约束
- [ ] 编写数据库迁移脚本

**第 2 周: 数据生成和导入**

- [ ] 编写数据生成脚本
- [ ] 生成阶段 1 基础数据
- [ ] 生成阶段 2 业务数据
- [ ] 数据完整性验证

---

### 阶段 2: 后端权限改造 (预计 3 周)

**第 3 周: 实体和 Mapper 层**

- [ ] 创建新实体类 (Nurse, Organization, MedicationRecord 等)
- [ ] 创建 Mapper 接口
- [ ] 编写单元测试

**第 4 周: Service 层和权限控制**

- [ ] 实现数据隔离逻辑 (医生只能访问负责的老人)
- [ ] 实现家属权限校验中间件
- [ ] 添加操作审计日志记录

**第 5 周: Controller 层和 API**

- [ ] 修改现有 Controller,添加权限校验
- [ ] 创建新的 Controller (护工、社工、机构等)
- [ ] 更新 API 文档

---

### 阶段 3: 前端权限改造 (预计 3 周)

**第 6 周: 路由和菜单重构**

- [ ] 重新设计路由结构
- [ ] 实现角色路由映射
- [ ] 更新侧边栏菜单组件

**第 7 周: 页面开发**

- [ ] 医生工作台页面 (我负责的老人)
- [ ] 护工工作台页面 (今日护理任务)
- [ ] 家属专属页面优化 (严格权限控制)
- [ ] 护理记录、用药记录、巡诊记录页面

**第 8 周: 权限控制完善**

- [ ] 前端权限指令优化
- [ ] API 调用权限校验
- [ ] 页面元素级权限控制

---

### 阶段 4: 测试和上线 (预计 2 周)

**第 9 周: 功能测试**

- [ ] 角色权限测试 (每个角色登录测试)
- [ ] 数据隔离测试 (越权访问测试)
- [ ] 家属权限边界测试
- [ ] 操作审计日志测试

**第 10 周: 性能优化和上线**

- [ ] 数据库查询优化
- [ ] 前端加载性能优化
- [ ] 编写用户操作手册
- [ ] 生产环境部署

---

### 预期成果

✅ **安全性提升**

- 消除越权访问漏洞
- 实现细粒度权限控制
- 完整的操作审计日志

✅ **业务完整性**

- 反映真实医养结合场景
- 支持医生、护工、社工协同工作
- 家属可安全查看长辈信息

✅ **数据质量**

- 完整的老人健康档案
- 规范的护理和用药记录
- 可追溯的医疗服务记录

✅ **可扩展性**

- 清晰的角色体系
- 灵活的权限配置
- 易于新增业务功能

---

## 附录 A: 快速参考

### 角色登录账号 (开发环境)

| 角色       | 用户名           | 密码   | 说明         |
| ---------- | ---------------- | ------ | ------------ |
| 系统管理员 | system_admin     | 123456 | 技术管理     |
| 业务管理员 | business_admin   | 123456 | 业务管理     |
| 医生       | doctor_zhang     | 123456 | 内科医生     |
| 护工       | nurse_wang       | 123456 | 一病区护工   |
| 社工       | social_worker_li | 123456 | 社工         |
| 家属       | family_chen      | 123456 | 陈老先生儿子 |

---

### 关键 API 权限控制示例

**医生查询老人列表 API:**

```java
@GetMapping("/elderly/my-patients")
@PreAuthorize("hasRole('doctor')")
public ResponseResult<List<ElderlyVO>> getMyPatients() {
    Long doctorId = SecurityUtils.getCurrentUserId();
    // 只返回该医生负责的老人
    List<ElderlyVO> patients = elderlyService.getPatientsByDoctorId(doctorId);
    return ResponseResult.success(patients);
}
```

**家属查询老人详情 API:**

```java
@GetMapping("/elderly/detail/{id}")
@PreAuthorize("hasRole('family')")
public ResponseResult<ElderlyVO> getElderlyDetail(@PathVariable Long id) {
    Long familyId = SecurityUtils.getCurrentUserId();
    // 校验家属是否有权限查看该老人
    if (!familyService.canAccessElderly(familyId, id)) {
        throw new PermissionDeniedException("无权访问该老人信息");
    }
    ElderlyVO elderly = elderlyService.getById(id);
    // 根据访问级别过滤数据
    String accessLevel = familyService.getAccessLevel(familyId, id);
    elderly = filterDataByAccessLevel(elderly, accessLevel);
    return ResponseResult.success(elderly);
}
```

---

**报告生成时间:** 2025 年 10 月 28 日
**版本:** v1.0
**作者:** GitHub Copilot
