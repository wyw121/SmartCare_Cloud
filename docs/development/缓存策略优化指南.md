# ç¼“å­˜ç­–ç•¥ä¼˜åŒ–æŒ‡å—

æ™ºæ…§åŒ»å…»å¹³å°çš„ç¼“å­˜ç­–ç•¥è®¾è®¡å’Œä¼˜åŒ–å»ºè®®ã€‚

## ğŸ“‹ ç›®å½•
- [Spring Cacheé…ç½®](#spring-cacheé…ç½®)
- [Redisç¼“å­˜ç­–ç•¥](#redisç¼“å­˜ç­–ç•¥)
- [ç¼“å­˜æ³¨è§£ä½¿ç”¨](#ç¼“å­˜æ³¨è§£ä½¿ç”¨)
- [ç¼“å­˜å¤±æ•ˆç­–ç•¥](#ç¼“å­˜å¤±æ•ˆç­–ç•¥)
- [æ€§èƒ½ç›‘æ§](#æ€§èƒ½ç›‘æ§)

---

## âš™ï¸ Spring Cacheé…ç½®

### å½“å‰é…ç½®ï¼ˆapplication.ymlï¼‰

```yaml
spring:
  cache:
    type: redis
    redis:
      time-to-live: 600000  # ç¼“å­˜è¿‡æœŸæ—¶é—´(æ¯«ç§’) 10åˆ†é’Ÿ
      cache-null-values: false  # ä¸ç¼“å­˜ç©ºå€¼
      
  redis:
    host: localhost
    port: 6379
    database: 0
    timeout: 10000ms
    lettuce:
      pool:
        max-active: 8
        max-wait: -1ms
        max-idle: 8
        min-idle: 0
```

### ä¼˜åŒ–å»ºè®®é…ç½®

```yaml
spring:
  cache:
    type: redis
    redis:
      time-to-live: 3600000  # æå‡è‡³1å°æ—¶
      cache-null-values: false
      use-key-prefix: true  # ä½¿ç”¨keyå‰ç¼€
      key-prefix: "smartcare:"  # ç»Ÿä¸€keyå‰ç¼€
      enable-statistics: true  # å¯ç”¨ç¼“å­˜ç»Ÿè®¡
      
  redis:
    host: localhost
    port: 6379
    database: 0
    timeout: 10000ms
    lettuce:
      pool:
        max-active: 20  # å¢åŠ è¿æ¥æ± å¤§å°
        max-wait: 5000ms  # è®¾ç½®åˆç†çš„ç­‰å¾…æ—¶é—´
        max-idle: 10
        min-idle: 2
    # å¯ç”¨è‡ªåŠ¨é‡è¿
    lettuce:
      shutdown-timeout: 200ms
```

---

## ğŸ¯ ç¼“å­˜ç­–ç•¥è®¾è®¡

### 1. ä¸åŒæ•°æ®çš„ç¼“å­˜æ—¶é—´

```java
/**
 * ç¼“å­˜é…ç½®ç±»
 */
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory factory) {
        // é»˜è®¤é…ç½®
        RedisCacheConfiguration defaultConfig = RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(30)) // é»˜è®¤30åˆ†é’Ÿ
                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(
                        new StringRedisSerializer()))
                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(
                        new GenericJackson2JsonRedisSerializer()))
                .disableCachingNullValues(); // ä¸ç¼“å­˜nullå€¼
        
        // ä¸ºä¸åŒçš„cache nameè®¾ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´
        Map<String, RedisCacheConfiguration> cacheConfigurations = new HashMap<>();
        
        // åŸºç¡€æ•°æ®ï¼š1å°æ—¶ï¼ˆå˜åŒ–å¾ˆå°‘ï¼‰
        cacheConfigurations.put("elderly",
                defaultConfig.entryTtl(Duration.ofHours(1)));
        cacheConfigurations.put("doctor",
                defaultConfig.entryTtl(Duration.ofHours(1)));
        cacheConfigurations.put("user",
                defaultConfig.entryTtl(Duration.ofHours(1)));
        
        // ç»Ÿè®¡æ•°æ®ï¼š10åˆ†é’Ÿï¼ˆéœ€è¦è¾ƒé«˜å®æ—¶æ€§ï¼‰
        cacheConfigurations.put("statistics",
                defaultConfig.entryTtl(Duration.ofMinutes(10)));
        cacheConfigurations.put("dashboard",
                defaultConfig.entryTtl(Duration.ofMinutes(10)));
        
        // å¥åº·è®°å½•ï¼š30åˆ†é’Ÿï¼ˆä¸­ç­‰å®æ—¶æ€§ï¼‰
        cacheConfigurations.put("healthRecord",
                defaultConfig.entryTtl(Duration.ofMinutes(30)));
        
        // é…ç½®æ•°æ®ï¼š24å°æ—¶ï¼ˆå‡ ä¹ä¸å˜ï¼‰
        cacheConfigurations.put("config",
                defaultConfig.entryTtl(Duration.ofHours(24)));
        cacheConfigurations.put("dict",
                defaultConfig.entryTtl(Duration.ofHours(24)));
        
        // é¢„è­¦æ•°æ®ï¼š5åˆ†é’Ÿï¼ˆé«˜å®æ—¶æ€§ï¼‰
        cacheConfigurations.put("healthWarning",
                defaultConfig.entryTtl(Duration.ofMinutes(5)));
        
        return RedisCacheManager.builder(factory)
                .cacheDefaults(defaultConfig)
                .withInitialCacheConfigurations(cacheConfigurations)
                .transactionAware()
                .build();
    }
}
```

---

## ğŸ“ ç¼“å­˜æ³¨è§£æœ€ä½³å®è·µ

### 1. @Cacheable - æŸ¥è¯¢ç¼“å­˜

```java
@Service
public class ElderlyServiceImpl extends ServiceImpl<ElderlyMapper, Elderly> implements ElderlyService {
    
    /**
     * æ ¹æ®IDæŸ¥è¯¢è€äººä¿¡æ¯ï¼ˆå¸¦ç¼“å­˜ï¼‰
     * 
     * keyæ ¼å¼: elderly::id:{id}
     * è¿‡æœŸæ—¶é—´: 1å°æ—¶
     */
    @Cacheable(value = "elderly", key = "'id:' + #id", unless = "#result == null")
    @Override
    public Elderly getById(Serializable id) {
        return super.getById(id);
    }
    
    /**
     * æŸ¥è¯¢é‡ç‚¹å…³æ³¨è€äººï¼ˆå¸¦ç¼“å­˜ï¼‰
     * 
     * keyæ ¼å¼: elderly::keyList
     * è¿‡æœŸæ—¶é—´: 10åˆ†é’Ÿ
     */
    @Cacheable(value = "statistics", key = "'keyElderlyList'")
    public List<Elderly> getKeyElderlyList() {
        return lambdaQuery()
                .eq(Elderly::getHealthStatus, "WARNING")
                .or()
                .eq(Elderly::getHealthStatus, "DANGER")
                .list();
    }
    
    /**
     * å¥åº·ç»Ÿè®¡ï¼ˆå¸¦ç¼“å­˜ï¼‰
     * 
     * ä½¿ç”¨conditioné¿å…æ— æ•ˆç¼“å­˜
     */
    @Cacheable(
        value = "statistics",
        key = "'healthStats'",
        condition = "#useCache == true",
        unless = "#result == null"
    )
    public Map<String, Object> getHealthStatistics(boolean useCache) {
        // ç»Ÿè®¡é€»è¾‘
        return statistics;
    }
}
```

### 2. @CachePut - æ›´æ–°ç¼“å­˜

```java
@Service
public class ElderlyServiceImpl extends ServiceImpl<ElderlyMapper, Elderly> implements ElderlyService {
    
    /**
     * æ›´æ–°è€äººä¿¡æ¯ï¼ˆåŒæ—¶æ›´æ–°ç¼“å­˜ï¼‰
     * 
     * æ³¨æ„ï¼š@CachePutæ€»æ˜¯æ‰§è¡Œæ–¹æ³•ï¼Œç„¶åæ›´æ–°ç¼“å­˜
     */
    @CachePut(value = "elderly", key = "'id:' + #elderly.id")
    @Override
    public boolean updateById(Elderly elderly) {
        boolean success = super.updateById(elderly);
        if (success) {
            // å‘å¸ƒäº‹ä»¶ï¼Œæ¸…é™¤ç›¸å…³ç¼“å­˜
            eventPublisher.publishEvent(new ElderlyUpdatedEvent(this, elderly.getId()));
        }
        return success;
    }
}
```

### 3. @CacheEvict - æ¸…é™¤ç¼“å­˜

```java
@Service
public class ElderlyServiceImpl extends ServiceImpl<ElderlyMapper, Elderly> implements ElderlyService {
    
    /**
     * åˆ é™¤è€äººï¼ˆæ¸…é™¤ç¼“å­˜ï¼‰
     */
    @CacheEvict(value = "elderly", key = "'id:' + #id")
    @Override
    public boolean removeById(Serializable id) {
        return super.removeById(id);
    }
    
    /**
     * æ‰¹é‡åˆ é™¤ï¼ˆæ¸…é™¤æ‰€æœ‰ç›¸å…³ç¼“å­˜ï¼‰
     */
    @CacheEvict(value = "elderly", allEntries = true)
    public boolean removeBatchByIds(Collection<? extends Serializable> idList) {
        return super.removeBatchByIds(idList);
    }
    
    /**
     * æ¸…é™¤ç»Ÿè®¡ç¼“å­˜ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
     */
    @CacheEvict(value = "statistics", allEntries = true)
    @Scheduled(cron = "0 */10 * * * ?") // æ¯10åˆ†é’Ÿæ¸…é™¤ä¸€æ¬¡
    public void clearStatisticsCache() {
        log.info("å®šæ—¶æ¸…é™¤ç»Ÿè®¡ç¼“å­˜");
    }
}
```

### 4. @Caching - ç»„åˆç¼“å­˜æ“ä½œ

```java
@Service
public class ElderlyServiceImpl extends ServiceImpl<ElderlyMapper, Elderly> implements ElderlyService {
    
    /**
     * æ–°å¢è€äººï¼ˆæ¸…é™¤ç»Ÿè®¡ç¼“å­˜ï¼Œä¸ç¼“å­˜ç»“æœï¼‰
     */
    @Caching(evict = {
        @CacheEvict(value = "statistics", allEntries = true),
        @CacheEvict(value = "dashboard", allEntries = true)
    })
    public boolean save(Elderly elderly) {
        return super.save(elderly);
    }
    
    /**
     * æ›´æ–°è€äººå¥åº·çŠ¶æ€ï¼ˆæ›´æ–°ç¼“å­˜+æ¸…é™¤ç»Ÿè®¡ï¼‰
     */
    @Caching(
        put = {
            @CachePut(value = "elderly", key = "'id:' + #elderly.id")
        },
        evict = {
            @CacheEvict(value = "statistics", allEntries = true)
        }
    )
    public boolean updateHealthStatus(Elderly elderly) {
        return super.updateById(elderly);
    }
}
```

---

## ğŸ”„ ç¼“å­˜å¤±æ•ˆç­–ç•¥

### 1. äº‹ä»¶é©±åŠ¨çš„ç¼“å­˜æ¸…é™¤

```java
/**
 * è€äººæ›´æ–°äº‹ä»¶
 */
public class ElderlyUpdatedEvent extends ApplicationEvent {
    private final Long elderlyId;
    
    public ElderlyUpdatedEvent(Object source, Long elderlyId) {
        super(source);
        this.elderlyId = elderlyId;
    }
    
    public Long getElderlyId() {
        return elderlyId;
    }
}

/**
 * ç¼“å­˜æ¸…é™¤ç›‘å¬å™¨
 */
@Component
public class CacheEvictListener {
    
    @Autowired
    private CacheManager cacheManager;
    
    /**
     * ç›‘å¬è€äººæ›´æ–°äº‹ä»¶ï¼Œæ¸…é™¤ç›¸å…³ç¼“å­˜
     */
    @EventListener
    public void onElderlyUpdated(ElderlyUpdatedEvent event) {
        // æ¸…é™¤ç»Ÿè®¡ç¼“å­˜
        Cache statisticsCache = cacheManager.getCache("statistics");
        if (statisticsCache != null) {
            statisticsCache.clear();
        }
        
        // æ¸…é™¤ä»ªè¡¨æ¿ç¼“å­˜
        Cache dashboardCache = cacheManager.getCache("dashboard");
        if (dashboardCache != null) {
            dashboardCache.clear();
        }
        
        log.info("è€äººä¿¡æ¯æ›´æ–°ï¼Œå·²æ¸…é™¤ç›¸å…³ç¼“å­˜ï¼ŒelderlyId: {}", event.getElderlyId());
    }
}
```

### 2. ç¼“å­˜é¢„çƒ­

```java
@Component
public class CacheWarmer implements CommandLineRunner {
    
    @Autowired
    private ElderlyService elderlyService;
    
    @Autowired
    private DoctorService doctorService;
    
    @Override
    public void run(String... args) {
        log.info("å¼€å§‹ç¼“å­˜é¢„çƒ­...");
        
        // é¢„çƒ­çƒ­ç‚¹æ•°æ®
        elderlyService.getKeyElderlyList();
        elderlyService.getHealthStatistics(true);
        doctorService.getDoctorList();
        
        log.info("ç¼“å­˜é¢„çƒ­å®Œæˆ");
    }
}
```

### 3. ç¼“å­˜ç©¿é€é˜²æŠ¤

```java
@Service
public class ElderlyServiceImpl extends ServiceImpl<ElderlyMapper, Elderly> implements ElderlyService {
    
    /**
     * é˜²æ­¢ç¼“å­˜ç©¿é€
     * ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨æˆ–ç¼“å­˜ç©ºå¯¹è±¡
     */
    @Cacheable(
        value = "elderly",
        key = "'id:' + #id",
        unless = "#result == null",  // nullå€¼ä¸ç¼“å­˜ï¼Œé˜²æ­¢ç¼“å­˜ç©¿é€
        condition = "#id != null"
    )
    public Elderly getByIdWithBloomFilter(Long id) {
        // 1. å…ˆæ£€æŸ¥å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆå¯é€‰ï¼‰
        if (!bloomFilter.mightContain(id)) {
            return null; // è‚¯å®šä¸å­˜åœ¨
        }
        
        // 2. æŸ¥è¯¢æ•°æ®åº“
        return super.getById(id);
    }
}
```

---

## ğŸ“Š æ€§èƒ½ç›‘æ§

### 1. ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯

```java
@RestController
@RequestMapping("/api/monitor")
public class CacheMonitorController {
    
    @Autowired
    private CacheManager cacheManager;
    
    /**
     * è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
     */
    @GetMapping("/cache/stats")
    public Map<String, Object> getCacheStats() {
        Map<String, Object> stats = new HashMap<>();
        
        Collection<String> cacheNames = cacheManager.getCacheNames();
        for (String cacheName : cacheNames) {
            Cache cache = cacheManager.getCache(cacheName);
            if (cache instanceof RedisCache) {
                stats.put(cacheName, getCacheInfo((RedisCache) cache));
            }
        }
        
        return stats;
    }
    
    private Map<String, Object> getCacheInfo(RedisCache cache) {
        Map<String, Object> info = new HashMap<>();
        info.put("name", cache.getName());
        // æ›´å¤šç»Ÿè®¡ä¿¡æ¯...
        return info;
    }
    
    /**
     * æ¸…é™¤æŒ‡å®šç¼“å­˜
     */
    @DeleteMapping("/cache/{cacheName}")
    public ResponseResult<Void> clearCache(@PathVariable String cacheName) {
        Cache cache = cacheManager.getCache(cacheName);
        if (cache != null) {
            cache.clear();
            return ResponseResult.success("ç¼“å­˜æ¸…é™¤æˆåŠŸ");
        }
        return ResponseResult.error("ç¼“å­˜ä¸å­˜åœ¨");
    }
}
```

### 2. Redisç›‘æ§å‘½ä»¤

```bash
# è¿æ¥Redis
redis-cli

# æŸ¥çœ‹æ‰€æœ‰key
KEYS smartcare:*

# æŸ¥çœ‹keyçš„è¿‡æœŸæ—¶é—´
TTL smartcare:elderly::id:1

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
INFO memory

# æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡
INFO stats

# ç›‘æ§å‘½ä»¤æ‰§è¡Œ
MONITOR

# æŸ¥çœ‹æ…¢æŸ¥è¯¢
SLOWLOG GET 10
```

---

## âœ… ç¼“å­˜ä¼˜åŒ–æ£€æŸ¥æ¸…å•

### è®¾è®¡é˜¶æ®µ
- [ ] è¯†åˆ«éœ€è¦ç¼“å­˜çš„æ•°æ®ï¼ˆè¯»å¤šå†™å°‘ã€è®¡ç®—å¤æ‚ï¼‰
- [ ] ç¡®å®šåˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´
- [ ] è®¾è®¡ç¼“å­˜keyçš„å‘½åè§„èŒƒ
- [ ] è€ƒè™‘ç¼“å­˜å¤±æ•ˆç­–ç•¥

### å®ç°é˜¶æ®µ
- [ ] æ­£ç¡®ä½¿ç”¨@Cacheableã€@CachePutã€@CacheEvict
- [ ] è®¾ç½®åˆç†çš„conditionå’Œunlessæ¡ä»¶
- [ ] ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¸…é™¤ç›¸å…³ç¼“å­˜
- [ ] å®ç°ç¼“å­˜é¢„çƒ­æœºåˆ¶

### è¿ç»´é˜¶æ®µ
- [ ] ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
- [ ] ç›‘æ§Rediså†…å­˜ä½¿ç”¨
- [ ] å®šæœŸæ¸…ç†æ— ç”¨ç¼“å­˜
- [ ] å‹æµ‹éªŒè¯ç¼“å­˜æ•ˆæœ

---

## ğŸš¨ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. ç¼“å­˜é›ªå´©

**é—®é¢˜**ï¼šå¤§é‡ç¼“å­˜åŒæ—¶å¤±æ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// ä¸ºä¸åŒçš„keyè®¾ç½®éšæœºè¿‡æœŸæ—¶é—´
@Cacheable(value = "elderly", key = "'id:' + #id")
public Elderly getById(Long id) {
    // åœ¨CacheConfigä¸­è®¾ç½®
    // .entryTtl(Duration.ofMinutes(30 + new Random().nextInt(10)))
    return super.getById(id);
}
```

### 2. ç¼“å­˜å‡»ç©¿

**é—®é¢˜**ï¼šçƒ­ç‚¹keyå¤±æ•ˆï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// ä½¿ç”¨åˆ†å¸ƒå¼é”
@Cacheable(value = "statistics", key = "'hotData'", sync = true)
public Object getHotData() {
    // sync=true ä¼šä½¿ç”¨åŒæ­¥é”
    return expensiveOperation();
}
```

### 3. ç¼“å­˜ä¸æ•°æ®åº“ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// æ–¹æ¡ˆ1ï¼šå…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“
@Transactional
public void updateElderly(Elderly elderly) {
    // 1. åˆ é™¤ç¼“å­˜
    cacheManager.getCache("elderly").evict("id:" + elderly.getId());
    
    // 2. æ›´æ–°æ•°æ®åº“
    updateById(elderly);
    
    // 3. å†æ¬¡åˆ é™¤ç¼“å­˜ï¼ˆå»¶è¿ŸåŒåˆ ï¼‰
    CompletableFuture.runAsync(() -> {
        try {
            Thread.sleep(500);
            cacheManager.getCache("elderly").evict("id:" + elderly.getId());
        } catch (InterruptedException e) {
            log.error("å»¶è¿Ÿåˆ é™¤ç¼“å­˜å¤±è´¥", e);
        }
    });
}
```

---

## ğŸ¯ ä¼˜åŒ–å»ºè®®æ€»ç»“

1. **åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´**ï¼šæ ¹æ®æ•°æ®ç‰¹ç‚¹è®¾ç½®ä¸åŒçš„TTL
2. **ä½¿ç”¨äº‹ä»¶é©±åŠ¨**ï¼šé€šè¿‡äº‹ä»¶è‡ªåŠ¨æ¸…é™¤ç›¸å…³ç¼“å­˜
3. **é¿å…è¿‡åº¦ç¼“å­˜**ï¼šä¸è¦ç¼“å­˜æ‰€æœ‰æ•°æ®ï¼Œé€‰æ‹©åˆé€‚çš„æ•°æ®
4. **ç›‘æ§ç¼“å­˜æ•ˆæœ**ï¼šå®šæœŸæŸ¥çœ‹å‘½ä¸­ç‡å’Œæ€§èƒ½æå‡
5. **é˜²æ­¢ç¼“å­˜é—®é¢˜**ï¼šè€ƒè™‘é›ªå´©ã€å‡»ç©¿ã€ç©¿é€ç­‰é—®é¢˜
6. **å®šæœŸæ¸…ç†**ï¼šæ¸…ç†æ— ç”¨æˆ–è¿‡æœŸçš„ç¼“å­˜key
