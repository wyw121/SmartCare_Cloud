# 阶段4: 测试和上线工作计划

**项目**: 智慧医养平台权限系统  
**阶段**: 阶段4 - 测试和上线  
**预计时间**: 2周 (第9-10周)  
**开始日期**: 2025-11-01  
**目标**: 全面测试权限系统,优化性能,完成生产环境部署

---

## 📅 第9周: 功能测试 (2025-11-01 ~ 2025-11-07)

### 1️⃣ 角色权限测试 (2天)

**测试目标**: 验证6种角色的路由访问、菜单显示、按钮权限控制

**测试角色**:
- `system_admin` - 系统管理员
- `business_admin` - 业务管理员
- `doctor` - 医生
- `nurse` - 护工
- `social_worker` - 社工
- `family` - 家属

**测试用例清单**:

#### 1.1 路由访问权限测试
```
测试步骤:
1. 使用不同角色账号登录系统
2. 尝试访问各个路由URL
3. 记录实际访问结果

预期结果:
- ✅ 有权限的路由正常显示
- ✅ 无权限的路由自动跳转到403页面或首页
- ✅ 路由守卫拦截生效

测试矩阵:
| 路由                    | system_admin | business_admin | doctor | nurse | social_worker | family |
|------------------------|--------------|----------------|--------|-------|---------------|--------|
| /dashboard             | ✅           | ✅             | ✅     | ✅    | ✅            | ✅     |
| /system/users          | ✅           | ❌             | ❌     | ❌    | ❌            | ❌     |
| /elderly/list          | ❌           | ✅             | ✅     | ❌    | ❌            | ❌     |
| /elderly/family-view   | ❌           | ❌             | ❌     | ❌    | ❌            | ✅     |
| /doctor/list           | ❌           | ✅             | ❌     | ❌    | ❌            | ❌     |
| /doctor/workbench      | ❌           | ❌             | ✅     | ❌    | ❌            | ❌     |
| /nurse/workbench       | ❌           | ❌             | ❌     | ✅    | ❌            | ❌     |
```

#### 1.2 菜单显示测试
```
测试步骤:
1. 使用不同角色登录
2. 检查侧边栏菜单项
3. 对比role-config.js中的配置

预期结果:
- ✅ 只显示有权限的菜单
- ✅ 无权限菜单完全隐藏
- ✅ 菜单层级结构正确

医生角色应看到的菜单:
- 首页仪表板
- 医生工作台
- 老人管理 > 我负责的老人
- 健康管理 > 健康预警/健康记录/评估报告
- 医疗记录 > 用药记录/巡诊记录
- 个人统计
- 个人中心
```

#### 1.3 按钮级权限测试
```
测试页面: /elderly/list (老人列表页)

测试步骤:
1. 医生角色登录
2. 进入老人列表页
3. 检查操作按钮可见性

预期结果:
医生角色应该:
- ✅ 看到 "查看" 按钮
- ✅ 看到 "健康" 按钮
- ✅ 看到 "评估" 按钮
- ❌ 看不到 "编辑" 按钮
- ❌ 看不到 "删除" 按钮
- ❌ 看不到 "新增老人档案" 按钮
- ❌ 看不到 "批量删除" 按钮

业务管理员应该:
- ✅ 看到所有按钮
```

**测试工具**:
- 手动测试 (Chrome DevTools)
- 截图记录
- 测试报告模板: `docs/testing/role-permission-test-report.md`

**交付物**:
- [ ] 角色权限测试报告
- [ ] 权限问题列表 (如有)
- [ ] 修复验证记录

---

### 2️⃣ 数据隔离测试 (2天)

**测试目标**: 验证@DataPermission注解的SQL过滤效果,确保角色只能看到自己权限范围内的数据

**核心测试场景**:

#### 2.1 医生数据隔离测试
```
测试API: GET /api/elderly/my-patients

测试步骤:
1. 在数据库中准备测试数据:
   - 老人A (id=1): 由医生张三(doctor_id=1)负责
   - 老人B (id=2): 由医生李四(doctor_id=2)负责
   - 老人C (id=3): 无医生负责

2. 使用医生张三(id=1)的token调用API

3. 检查返回结果和数据库SQL日志

预期结果:
- ✅ 只返回老人A的数据
- ✅ SQL中包含doctor_elderly_relation关联查询
- ✅ WHERE条件包含 doctor_id = 1
- ❌ 不返回老人B和老人C

SQL示例:
SELECT * FROM elderly_info e
WHERE EXISTS (
  SELECT 1 FROM doctor_elderly_relation der
  WHERE der.doctor_id = 1 
  AND der.elderly_id = e.id
)
```

#### 2.2 护工数据隔离测试
```
测试API: GET /api/elderly/my-patients (护工角色)

测试步骤:
1. 准备测试数据:
   - 老人A: 由护工王五(nurse_id=1)负责
   - 老人B: 由护工赵六(nurse_id=2)负责

2. 使用护工王五的token调用API

3. 验证SQL过滤条件

预期结果:
- ✅ 只返回老人A
- ✅ SQL关联nurse_elderly_relation表
- ✅ WHERE条件: nurse_id = 1
```

#### 2.3 家属数据隔离测试
```
测试场景: 家属查看老人列表

测试步骤:
1. 准备数据:
   - 家属张三(family_id=1): 关联老人A、老人B
   - 家属李四(family_id=2): 关联老人C

2. 家属张三登录,访问 /elderly/family-view

3. 检查API返回数据

预期结果:
- ✅ 只返回老人A和老人B
- ✅ SQL关联family_elderly_relation表
- ❌ 不返回老人C
```

#### 2.4 越权访问测试
```
测试场景: 尝试越权访问他人数据

测试步骤:
1. 医生张三(id=1)尝试访问: /api/elderly/detail?id=2 (老人B,由医生李四负责)

2. 记录响应结果

预期结果:
- ✅ 返回403 Forbidden错误
- ✅ 前端跳转到403错误页面
- ✅ 后台记录越权访问日志
```

**测试工具**:
- Postman / Insomnia (API测试)
- MySQL Workbench (SQL日志查看)
- Chrome DevTools (Network面板)

**交付物**:
- [ ] 数据隔离测试报告
- [ ] SQL执行日志截图
- [ ] 越权访问测试记录

---

### 3️⃣ 家属权限边界测试 (1天)

**测试目标**: 验证家属三级访问权限(basic/health/full)的功能正确性

**测试场景**:

#### 3.1 基础权限(basic)测试
```
测试步骤:
1. 在family_elderly_relation表设置:
   INSERT INTO family_elderly_relation 
   VALUES (family_id=1, elderly_id=1, access_level='basic')

2. 家属登录,访问 /elderly/family-detail/1

预期结果:
- ✅ 可以看到: 姓名、性别、年龄、房间号、地址
- ✅ 显示"权限提示": 您当前拥有基础信息访问权限
- ❌ 看不到: 健康状态、病史、用药史
- ❌ "查看健康记录"按钮禁用
- ❌ "查看健康预警"按钮禁用
```

#### 3.2 健康权限(health)测试
```
测试步骤:
1. 设置access_level='health'
2. 刷新页面

预期结果:
- ✅ 可以看到所有基础信息
- ✅ 可以看到: 健康状态、照护等级、BMI、病史、用药史
- ✅ "查看健康记录"按钮可用
- ✅ "查看健康预警"按钮可用
- ✅ 权限提示显示"健康信息访问权限"
```

#### 3.3 完全权限(full)测试
```
测试步骤:
1. 设置access_level='full'
2. 刷新页面

预期结果:
- ✅ 显示所有信息
- ✅ 所有快捷操作可用
- ✅ 权限标签显示"完全访问权限"(绿色)
```

#### 3.4 权限动态切换测试
```
测试步骤:
1. 管理员修改家属权限: basic -> health
2. 家属端不刷新页面,导航到其他页面再返回

预期结果:
- ✅ 权限立即生效
- ✅ 页面内容自动更新
- ✅ 按钮状态正确切换
```

**交付物**:
- [ ] 家属权限测试矩阵
- [ ] 权限切换测试视频

---

### 4️⃣ 操作审计日志测试 (1天)

**测试目标**: 验证@AuditLog注解记录关键操作,确保审计日志完整准确

**测试操作清单**:

#### 4.1 老人档案操作日志
```
测试操作:
1. 新增老人档案
2. 编辑老人信息
3. 删除老人档案
4. 批量删除

预期audit_log记录:
- ✅ operation: "新增老人档案" / "编辑老人信息" / "删除老人档案"
- ✅ operator_id: 当前登录用户ID
- ✅ operator_name: 当前登录用户姓名
- ✅ module: "elderly"
- ✅ target_id: 老人ID
- ✅ target_name: 老人姓名
- ✅ ip_address: 客户端IP
- ✅ create_time: 操作时间
- ✅ details: JSON格式详细信息
```

#### 4.2 健康记录操作日志
```
测试操作:
1. 医生添加健康记录
2. 医生处理健康预警

预期记录:
- ✅ module: "health"
- ✅ operation: "添加健康记录" / "处理健康预警"
- ✅ 记录修改前后的数据对比
```

#### 4.3 权限操作日志
```
测试操作:
1. 管理员修改家属访问权限
2. 管理员分配医生-老人关联关系

预期记录:
- ✅ module: "permission"
- ✅ 记录权限变更详情
- ✅ before/after数据对比
```

#### 4.4 日志查询测试
```
测试场景:
1. 管理员访问操作日志页面
2. 按时间范围筛选
3. 按操作人筛选
4. 按模块筛选
5. 导出日志

预期结果:
- ✅ 筛选条件生效
- ✅ 分页正常
- ✅ 导出Excel格式正确
```

**交付物**:
- [ ] 审计日志测试报告
- [ ] audit_log表数据样本
- [ ] 日志导出文件样本

---

## 📅 第10周: 性能优化和上线 (2025-11-08 ~ 2025-11-14)

### 1️⃣ 数据库查询优化 (2天)

**优化目标**: 减少慢查询,提升关联查询性能,优化数据权限过滤SQL

#### 1.1 慢查询分析
```sql
-- 启用慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1; -- 超过1秒记录为慢查询

-- 分析慢查询日志
-- 检查/var/lib/mysql/slow-query.log
```

**重点优化SQL**:

1. **医生负责老人查询**
```sql
-- 优化前 (可能的全表扫描)
SELECT * FROM elderly_info e
WHERE EXISTS (
  SELECT 1 FROM doctor_elderly_relation der
  WHERE der.doctor_id = ?
  AND der.elderly_id = e.id
)

-- 优化后 (添加索引)
CREATE INDEX idx_doctor_elderly ON doctor_elderly_relation(doctor_id, elderly_id);
CREATE INDEX idx_elderly_id ON elderly_info(id);

-- 使用INNER JOIN替代EXISTS
SELECT e.* FROM elderly_info e
INNER JOIN doctor_elderly_relation der ON e.id = der.elderly_id
WHERE der.doctor_id = ?
```

2. **家属关联老人查询**
```sql
-- 添加复合索引
CREATE INDEX idx_family_elderly ON family_elderly_relation(
  family_member_id, 
  elderly_id, 
  access_level
);
```

3. **健康预警查询优化**
```sql
-- 添加状态和时间索引
CREATE INDEX idx_warning_status_time ON health_warning(
  status, 
  warning_level, 
  create_time DESC
);
```

#### 1.2 索引优化建议
```sql
-- elderly_info表
ALTER TABLE elderly_info ADD INDEX idx_health_status(health_status);
ALTER TABLE elderly_info ADD INDEX idx_care_level(care_level);
ALTER TABLE elderly_info ADD INDEX idx_room_number(room_number);

-- health_records表
ALTER TABLE health_records ADD INDEX idx_elderly_record_time(
  elderly_id, 
  record_time DESC
);

-- audit_log表
ALTER TABLE audit_log ADD INDEX idx_operator_time(
  operator_id, 
  create_time DESC
);
ALTER TABLE audit_log ADD INDEX idx_module_time(
  module, 
  create_time DESC
);
```

#### 1.3 查询性能基准测试
```
测试场景:
1. 医生查询500个老人 (有关联关系)
2. 护工查询200个护理任务
3. 家属查询3个关联长辈
4. 管理员查询所有老人(10000条)

优化目标:
- 医生查询: < 200ms
- 护工查询: < 150ms
- 家属查询: < 100ms
- 管理员查询: < 500ms (分页20条/页)
```

**交付物**:
- [ ] 慢查询分析报告
- [ ] 索引优化SQL脚本
- [ ] 性能基准测试报告

---

### 2️⃣ 前端加载性能优化 (2天)

**优化目标**: 减少首屏加载时间,优化路由懒加载,提升用户体验

#### 2.1 路由懒加载优化
```javascript
// frontend/src/router/index.js

// 优化前: 所有组件都在首次加载
import ElderlyList from '@/views/elderly/List.vue'

// 优化后: 按需加载,使用魔法注释分组
const ElderlyList = () => import(
  /* webpackChunkName: "elderly" */
  '@/views/elderly/List.vue'
)

// 分组策略:
// - common: 首页、登录、403/404等常用页面
// - elderly: 老人管理相关页面
// - doctor: 医生工作台相关
// - nurse: 护工工作台相关
// - family: 家属专用页面
// - system: 系统管理页面
```

#### 2.2 权限配置缓存优化
```javascript
// frontend/src/store/permission.js

export const usePermissionStore = defineStore('permission', {
  state: () => ({
    rolePermissions: null,
    cacheTime: null,
    CACHE_DURATION: 5 * 60 * 1000 // 5分钟缓存
  }),
  
  actions: {
    async loadPermissions(force = false) {
      const now = Date.now()
      
      // 如果有缓存且未过期,直接使用
      if (!force && this.rolePermissions && 
          this.cacheTime && 
          (now - this.cacheTime) < this.CACHE_DURATION) {
        return this.rolePermissions
      }
      
      // 重新加载权限
      const userRole = useUserStore().role
      this.rolePermissions = ROLE_PERMISSIONS[userRole]
      this.cacheTime = now
      
      return this.rolePermissions
    }
  }
})
```

#### 2.3 组件级性能优化
```vue
<!-- 使用v-memo优化列表渲染 -->
<template>
  <div v-for="elderly in elderlyList" 
       :key="elderly.id"
       v-memo="[elderly.id, elderly.healthStatus]">
    <!-- 仅在id或healthStatus变化时重新渲染 -->
  </div>
</template>

<!-- 虚拟滚动优化长列表 -->
<script setup>
import { useVirtualList } from '@vueuse/core'

const { list, containerProps, wrapperProps } = useVirtualList(
  elderlyList,
  { itemHeight: 80 }
)
</script>
```

#### 2.4 首屏加载优化检查清单
```
- [ ] 启用gzip压缩
- [ ] 配置CDN加速
- [ ] 图片懒加载
- [ ] 字体子集化
- [ ] CSS按需引入
- [ ] Tree Shaking (移除未使用代码)
- [ ] Code Splitting (代码分割)
- [ ] Prefetch/Preload关键资源
```

**性能指标目标**:
- FCP (首次内容绘制): < 1.5s
- LCP (最大内容绘制): < 2.5s
- TTI (可交互时间): < 3.5s
- 首屏Bundle大小: < 500KB

**交付物**:
- [ ] Lighthouse性能报告
- [ ] 前端性能优化清单
- [ ] 打包体积分析报告

---

### 3️⃣ 编写用户操作手册 (1天)

**文档结构**: `docs/user-manual.md`

```markdown
# 智慧医养平台用户操作手册

## 第1章: 系统概述
- 1.1 系统简介
- 1.2 角色说明
- 1.3 功能模块总览

## 第2章: 登录与账户
- 2.1 首次登录
- 2.2 密码修改
- 2.3 个人信息维护

## 第3章: 角色功能指南

### 3.1 系统管理员
- 用户管理
- 角色配置
- 权限分配

### 3.2 业务管理员
- 老人档案管理
- 医生账户管理
- 数据统计分析

### 3.3 医生
- 工作台使用
- 我负责的老人
- 健康记录录入
- 评估报告编写
- 巡诊记录管理

### 3.4 护工
- 护理任务查看
- 护理记录录入
- 用药执行确认

### 3.5 社工
- 活动计划管理
- 访谈记录

### 3.6 家属
- 关联长辈查看
- 健康预警查看
- 权限申请流程

## 第4章: 权限说明
- 4.1 访问权限
- 4.2 数据权限
- 4.3 操作权限
- 4.4 权限申请

## 第5章: 常见问题
- 5.1 无法访问某个页面?
- 5.2 看不到某个老人的信息?
- 5.3 按钮显示为灰色?
- 5.4 如何申请更高权限?

## 第6章: 联系支持
- 技术支持电话
- 邮箱
- 在线客服
```

**编写要求**:
- 配图说明 (截图 + 标注)
- 操作步骤清晰
- 常见错误处理
- 最佳实践建议

**交付物**:
- [ ] 用户操作手册 (Markdown)
- [ ] PDF版本
- [ ] 操作视频 (可选)

---

### 4️⃣ 生产环境部署 (2天)

**部署架构**:
```
┌─────────────┐
│   Nginx     │ (反向代理 + SSL)
│   80/443    │
└──────┬──────┘
       │
    ┌──┴───────────────┬──────────────┐
    │                  │              │
┌───▼────┐      ┌─────▼──────┐  ┌───▼──────┐
│ Vue3   │      │ Spring     │  │  MySQL   │
│ 前端   │      │ Boot后端   │  │  数据库  │
│ :5173  │      │ :8080      │  │  :3306   │
└────────┘      └────────────┘  └──────────┘
```

#### 4.1 环境准备
```bash
# 服务器配置建议
CPU: 4核心
内存: 8GB
磁盘: 100GB SSD
操作系统: Ubuntu 22.04 LTS

# 安装依赖
sudo apt update
sudo apt install -y nginx mysql-server openjdk-17-jdk nodejs npm
```

#### 4.2 数据库部署
```bash
# 1. 执行数据库迁移脚本
mysql -u root -p < backend/sql/create_all_tables.sql

# 2. 初始化权限数据
mysql -u root -p smartcare < backend/sql/init_roles_and_permissions.sql

# 3. 创建索引
mysql -u root -p smartcare < backend/sql/create_performance_indexes.sql

# 4. 导入测试数据 (可选)
mysql -u root -p smartcare < backend/test-data/sample_data.sql
```

#### 4.3 后端部署
```bash
# 1. 编译打包
cd backend
mvn clean package -DskipTests

# 2. 配置生产环境
vim src/main/resources/application-prod.yml

# 修改:
# - 数据库连接
# - JWT密钥
# - 日志级别
# - 跨域配置

# 3. 启动后端服务
nohup java -jar target/smartcare-cloud-0.0.1.jar \
  --spring.profiles.active=prod \
  > /var/log/smartcare/backend.log 2>&1 &

# 4. 配置systemd服务
sudo vim /etc/systemd/system/smartcare-backend.service

[Unit]
Description=SmartCare Backend Service
After=network.target mysql.service

[Service]
Type=simple
User=smartcare
WorkingDirectory=/opt/smartcare/backend
ExecStart=/usr/bin/java -jar smartcare-cloud-0.0.1.jar --spring.profiles.active=prod
Restart=on-failure

[Install]
WantedBy=multi-user.target

# 启动服务
sudo systemctl enable smartcare-backend
sudo systemctl start smartcare-backend
```

#### 4.4 前端部署
```bash
# 1. 构建生产版本
cd frontend
npm run build

# 2. 配置Nginx
sudo vim /etc/nginx/sites-available/smartcare

server {
    listen 80;
    server_name smartcare.example.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name smartcare.example.com;
    
    # SSL证书
    ssl_certificate /etc/ssl/certs/smartcare.crt;
    ssl_certificate_key /etc/ssl/private/smartcare.key;
    
    # 前端静态文件
    root /opt/smartcare/frontend/dist;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 后端API代理
    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Gzip压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript;
    gzip_min_length 1000;
}

# 启用站点
sudo ln -s /etc/nginx/sites-available/smartcare /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

#### 4.5 SSL证书配置
```bash
# 使用Let's Encrypt免费证书
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d smartcare.example.com

# 自动续期
sudo certbot renew --dry-run
```

#### 4.6 监控配置
```bash
# 安装Prometheus + Grafana (可选)
# 配置Spring Boot Actuator
# 监控指标:
# - CPU/内存使用率
# - 接口响应时间
# - 数据库连接数
# - 错误率
# - 在线用户数
```

#### 4.7 部署检查清单
```
环境配置:
- [ ] 数据库连接测试
- [ ] Redis连接测试 (如使用)
- [ ] 防火墙规则配置
- [ ] SSL证书有效期检查

功能验证:
- [ ] 登录功能正常
- [ ] 各角色权限正确
- [ ] API接口响应正常
- [ ] 静态资源加载正常
- [ ] 403/404页面正常

性能验证:
- [ ] 首页加载 < 3秒
- [ ] 接口响应 < 500ms
- [ ] 并发100用户无异常

安全验证:
- [ ] HTTPS强制跳转
- [ ] SQL注入防护
- [ ] XSS防护
- [ ] CSRF防护
- [ ] 敏感数据加密

备份策略:
- [ ] 数据库每日备份
- [ ] 应用日志保留30天
- [ ] 代码版本管理
```

**交付物**:
- [ ] 部署文档
- [ ] 环境配置清单
- [ ] 运维手册
- [ ] 应急预案

---

## 📊 验收标准

### 功能验收
- [x] 6种角色权限正常运行
- [x] 数据隔离有效
- [x] 家属三级权限生效
- [x] 审计日志完整

### 性能验收
- [ ] 数据库查询 < 500ms
- [ ] 首屏加载 < 3s
- [ ] 并发100用户稳定

### 安全验收
- [ ] 越权访问被拦截
- [ ] HTTPS加密传输
- [ ] 敏感数据加密
- [ ] 审计日志记录

### 文档验收
- [ ] 用户手册完整
- [ ] 部署文档清晰
- [ ] 测试报告齐全

---

## 📝 风险管理

### 高风险项
1. **生产环境数据迁移失败**
   - 缓解措施: 提前备份,分步迁移,回滚方案
   
2. **性能不达标**
   - 缓解措施: 预先压测,逐步优化,监控告警

3. **权限配置错误**
   - 缓解措施: 充分测试,灰度发布,快速修复

### 应急预案
- 数据库备份恢复流程
- 应用快速回滚方案
- 紧急联系人名单
- 故障处理SOP

---

## 🎯 成功标准

1. ✅ 所有测试用例通过
2. ✅ 性能指标达标
3. ✅ 生产环境稳定运行7天
4. ✅ 用户培训完成
5. ✅ 文档交付齐全

---

**计划制定**: 2025-10-29  
**计划执行**: 2025-11-01 ~ 2025-11-14  
**预计交付**: 2025-11-15
