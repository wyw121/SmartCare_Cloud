# 日志规范文档

## 日志配置说明

项目使用 `Logback` 作为日志框架，通过 `SLF4J` 接口进行统一的日志记录。

### 配置文件
- **位置**: `backend/src/main/resources/logback-spring.xml`
- **日志存储**: `./logs/` 目录

### 日志文件类型

| 文件名 | 日志级别 | 用途 | 保留时间 |
|--------|----------|------|----------|
| `smartcare-cloud-info.log` | INFO | 普通业务日志 | 30天 |
| `smartcare-cloud-warn.log` | WARN | 警告信息 | 30天 |
| `smartcare-cloud-error.log` | ERROR | 错误异常 | 60天 |
| `smartcare-cloud-audit.log` | INFO | 操作审计日志 | 180天 |

### 日志归档策略
- **单文件大小限制**: 50-100MB
- **总容量限制**: 5-20GB
- **压缩格式**: `.gz`
- **归档目录**: `./logs/archive/`

---

## 日志级别使用规范

### DEBUG 级别
**使用场景**: 开发调试信息，仅在dev环境启用

```java
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
public class ElderlyService {
    
    public void saveElderly(Elderly elderly) {
        log.debug("开始保存老人档案，ID: {}, 姓名: {}", elderly.getId(), elderly.getName());
        
        // 业务逻辑...
        
        log.debug("老人档案保存成功，返回ID: {}", elderly.getId());
    }
}
```

**适用内容**:
- 方法入参和返回值
- 中间变量值
- 条件分支判断结果
- SQL执行参数

### INFO 级别
**使用场景**: 重要业务流程的关键节点

```java
@Slf4j
@Service
public class HealthWarningService {
    
    public void createWarning(HealthWarning warning) {
        log.info("创建健康预警 - 老人ID: {}, 预警类型: {}, 预警级别: {}", 
                 warning.getElderlyId(), warning.getWarningType(), warning.getWarningLevel());
        
        // 业务逻辑...
        
        log.info("健康预警创建成功，预警ID: {}", warning.getId());
    }
    
    public void processWarning(Long warningId, String handler) {
        log.info("处理健康预警 - 预警ID: {}, 处理人: {}", warningId, handler);
        
        // 业务逻辑...
        
        log.info("健康预警处理完成 - 预警ID: {}", warningId);
    }
}
```

**适用内容**:
- 业务流程开始和结束
- 重要状态变更
- 定时任务执行
- 外部接口调用

### WARN 级别
**使用场景**: 潜在问题或不期望的情况，但不影响系统运行

```java
@Slf4j
@Service
public class DoctorService {
    
    public void updateDoctorInfo(Doctor doctor) {
        // 检查医生资质是否即将过期
        if (doctor.getLicenseExpiryDate().isBefore(LocalDate.now().plusMonths(1))) {
            log.warn("医生资质即将过期 - 医生ID: {}, 姓名: {}, 过期日期: {}", 
                     doctor.getId(), doctor.getName(), doctor.getLicenseExpiryDate());
        }
        
        // 业务逻辑...
    }
}
```

**适用内容**:
- 使用默认值替代空参数
- 资源使用率高但未达到阈值
- 过时API的使用
- 配置项缺失但有默认值
- 数据校验失败但已容错处理

### ERROR 级别
**使用场景**: 系统错误和异常，需要立即关注

```java
@Slf4j
@Service
public class FileStorageService {
    
    public String uploadFile(MultipartFile file) {
        try {
            // 文件上传逻辑...
            return filePath;
        } catch (IOException e) {
            log.error("文件上传失败 - 文件名: {}, 错误信息: {}", 
                      file.getOriginalFilename(), e.getMessage(), e);
            throw new BusinessException("文件上传失败");
        }
    }
}
```

**适用内容**:
- 系统异常和错误
- 数据库操作失败
- 外部接口调用失败
- 必要资源缺失
- 安全相关错误

**⚠️ 注意**: ERROR日志必须包含异常堆栈信息 `e`

---

## 特殊日志 - 审计日志

### 审计日志Logger
使用专用Logger记录操作审计日志，独立存储于 `smartcare-cloud-audit.log`

```java
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class AuditLogAspect {
    
    // 使用专用审计日志Logger
    private static final Logger AUDIT_LOG = LoggerFactory.getLogger("AUDIT_LOG");
    
    public void recordAudit(String username, String operation, String ip) {
        AUDIT_LOG.info("用户操作 - 用户名: {}, 操作: {}, IP: {}, 时间: {}", 
                       username, operation, ip, LocalDateTime.now());
    }
}
```

### 审计日志记录内容
- 用户登录/登出
- 数据新增/修改/删除
- 权限变更
- 敏感操作（导出数据、批量删除等）

---

## 日志最佳实践

### ✅ 推荐做法

#### 1. 使用 Lombok `@Slf4j` 注解
```java
@Slf4j
@Service
public class ElderlyService {
    // 自动生成 private static final Logger log
}
```

#### 2. 使用占位符 `{}`，避免字符串拼接
```java
// ✅ 正确
log.info("保存老人档案成功，ID: {}, 姓名: {}", id, name);

// ❌ 错误
log.info("保存老人档案成功，ID: " + id + ", 姓名: " + name);
```

#### 3. 记录异常时包含完整堆栈
```java
// ✅ 正确
log.error("数据库操作失败，错误信息: {}", e.getMessage(), e);

// ❌ 错误
log.error("数据库操作失败: " + e.getMessage());
```

#### 4. 敏感信息脱敏
```java
// ✅ 正确
log.info("用户登录成功 - 用户名: {}, IP: {}", username, ip);

// ❌ 错误 - 不要记录密码
log.info("用户登录 - 用户名: {}, 密码: {}", username, password);
```

#### 5. 条件日志使用 `isXxxEnabled()`
```java
// 复杂对象序列化前检查日志级别
if (log.isDebugEnabled()) {
    log.debug("复杂对象详情: {}", JSON.toJSONString(complexObject));
}
```

### ❌ 禁止做法

1. **禁止在循环中打印INFO/DEBUG日志**
```java
// ❌ 错误
for (Elderly elderly : elderlyList) {
    log.info("处理老人: {}", elderly.getName());
}

// ✅ 正确
log.info("批量处理老人档案，数量: {}", elderlyList.size());
```

2. **禁止打印完整的请求/响应体**
```java
// ❌ 错误 - 可能包含敏感信息且日志过大
log.info("请求体: {}", requestBody);

// ✅ 正确 - 仅记录关键信息
log.info("请求操作: {}, 用户ID: {}", operation, userId);
```

3. **禁止使用 `System.out.println()` 或 `printStackTrace()`**
```java
// ❌ 错误
System.out.println("调试信息");
e.printStackTrace();

// ✅ 正确
log.debug("调试信息");
log.error("异常信息", e);
```

---

## 环境配置

### 开发环境 (dev)
- **控制台日志**: 彩色格式，便于查看
- **文件日志**: INFO/WARN/ERROR
- **日志级别**: 
  - 项目包: `DEBUG`
  - SQL: `DEBUG`
  - Spring Security: `DEBUG`

### 测试环境 (test)
- **控制台日志**: 启用
- **文件日志**: INFO/WARN/ERROR
- **日志级别**: 
  - 项目包: `INFO`
  - SQL: `INFO`

### 生产环境 (prod)
- **控制台日志**: 禁用
- **文件日志**: INFO/WARN/ERROR
- **日志级别**: 
  - 项目包: `INFO`
  - SQL: `WARN`（关闭SQL日志）
  - Spring Security: `WARN`

---

## 日志监控建议

### 错误日志监控
- 定期检查 `error.log` 文件
- 配置日志告警（错误日志超过阈值时发送通知）
- 使用ELK或其他日志分析工具

### 审计日志留存
- 审计日志保留180天（6个月）
- 定期备份至安全存储
- 支持合规性审计需求

### 日志分析
- 分析高频错误原因
- 统计用户操作行为
- 识别性能瓶颈

---

## 示例代码

### Controller层日志示例
```java
@Slf4j
@RestController
@RequestMapping("/api/elderly")
public class ElderlyController {
    
    @PostMapping
    public ResponseResult<Elderly> create(@RequestBody Elderly elderly) {
        log.info("创建老人档案 - 姓名: {}, 身份证: {}", 
                 elderly.getName(), elderly.getIdCard());
        
        try {
            Elderly saved = elderlyService.save(elderly);
            log.info("创建老人档案成功 - ID: {}", saved.getId());
            return ResponseResult.success(saved);
        } catch (Exception e) {
            log.error("创建老人档案失败 - 姓名: {}, 错误: {}", 
                      elderly.getName(), e.getMessage(), e);
            return ResponseResult.error("创建失败");
        }
    }
}
```

### Service层日志示例
```java
@Slf4j
@Service
public class HealthWarningServiceImpl implements HealthWarningService {
    
    @Override
    @Transactional
    public void handleWarning(Long warningId, String handler, String solution) {
        log.info("开始处理健康预警 - 预警ID: {}, 处理人: {}", warningId, handler);
        
        HealthWarning warning = getById(warningId);
        if (warning == null) {
            log.warn("健康预警不存在 - ID: {}", warningId);
            throw new BusinessException("预警不存在");
        }
        
        log.debug("预警详情 - 类型: {}, 级别: {}, 状态: {}", 
                  warning.getWarningType(), warning.getWarningLevel(), warning.getStatus());
        
        warning.setStatus(1); // 处理中
        warning.setHandler(handler);
        warning.setSolution(solution);
        updateById(warning);
        
        log.info("健康预警处理完成 - 预警ID: {}", warningId);
    }
}
```

---

## 总结

规范的日志记录有助于：
1. **快速定位问题**: 通过详细的日志信息快速找到错误原因
2. **性能分析**: 分析业务流程的性能瓶颈
3. **安全审计**: 记录关键操作，满足合规要求
4. **运维监控**: 实时监控系统运行状态

请团队成员严格遵守本规范，确保日志质量。
