# 后端权限改造 - 快速开始指南

## 🚀 快速部署

### 1. 执行数据库脚本

```bash
# 连接数据库
mysql -u root -p

# 选择数据库
USE smartcare_cloud;

# 执行脚本
SOURCE D:/repositories/SmartCare_Cloud/backend/sql/permission_enhancement.sql;
```

### 2. 编译项目

```bash
cd backend
mvn clean compile
```

### 3. 启动后端服务

```bash
mvn spring-boot:run -Dspring-boot.run.profiles=dev
```

### 4. 访问API文档

打开浏览器访问: `http://localhost:8080/swagger-ui.html`

---

## 📖 核心功能使用

### 功能1: 为医生分配老人

**API**: `POST /api/doctor-elderly-relation/assign`

```json
{
  "doctorId": 1,
  "elderlyIds": [1, 2, 3],
  "relationshipType": "primary"
}
```

### 功能2: 查询医生负责的老人

**API**: `GET /api/doctor-elderly-relation/doctor/{doctorId}/elderly-list`

### 功能3: 转移主治医生

**API**: `POST /api/doctor-elderly-relation/transfer`

```json
{
  "elderlyId": 1,
  "oldDoctorId": 1,
  "newDoctorId": 2
}
```

### 功能4: 权限校验示例

访问老人详情时自动校验权限:

```bash
# 医生Token (只能访问负责的老人)
curl -H "Authorization: Bearer <doctor_token>" \
     http://localhost:8080/api/elderly/1

# 返回: 200 OK (有权限)
# 或: 403 Forbidden (无权限)
```

---

## 🔧 Controller中使用权限注解

```java
@RestController
@RequestMapping("/api/elderly")
public class ElderlyController {
    
    // 添加@DataPermission注解即可启用权限校验
    @DataPermission(elderlyIdParam = "id")
    @GetMapping("/{id}")
    public ResponseResult<Elderly> getElderlyById(@PathVariable Long id) {
        // 执行前会自动校验权限
        return elderlyService.getElderlyById(id);
    }
}
```

---

## 📊 测试数据

### 测试用户

| 角色 | 用户名 | 密码 | 说明 |
|------|--------|------|------|
| 管理员 | admin | 123456 | 访问所有数据 |
| 医生1 | doctor1 | 123456 | 只能访问负责的老人 |
| 医生2 | doctor2 | 123456 | 只能访问负责的老人 |
| 家属 | family1 | 123456 | 只能访问关联的老人 |

### 测试关联关系

```sql
-- 医生1负责老人1和老人2
INSERT INTO doctor_elderly_relation (doctor_id, elderly_id, relationship_type, start_date, status)
VALUES (1, 1, 'primary', CURDATE(), 1),
       (1, 2, 'primary', CURDATE(), 1);

-- 医生2负责老人3
INSERT INTO doctor_elderly_relation (doctor_id, elderly_id, relationship_type, start_date, status)
VALUES (2, 3, 'primary', CURDATE(), 1);
```

---

## ⚠️ 注意事项

1. **JWT配置**: 确保`application.yml`中配置了正确的JWT密钥
2. **数据库权限**: 执行SQL脚本需要CREATE TABLE权限
3. **端口占用**: 默认端口8080,如有冲突请修改配置
4. **Redis**: 如果启用缓存,需要启动Redis服务
5. **日志级别**: 开发环境建议设置DEBUG级别查看权限校验日志

---

## 🐛 常见问题

### Q1: 权限校验不生效?

**A**: 检查以下几点:
1. 是否添加了`@DataPermission`注解
2. JWT Token是否正确传递
3. 切面是否正确配置 (检查@Aspect和@Component注解)

### Q2: 医生无法访问自己负责的老人?

**A**: 检查:
1. `doctor_elderly_relation`表中是否有对应记录
2. 记录的`status`字段是否为1
3. `end_date`是否为null或未过期

### Q3: 编译错误?

**A**: 确保:
1. Maven版本 ≥ 3.8
2. JDK版本 = 11
3. 依赖下载完整: `mvn clean install`

---

## 📞 技术支持

如有问题,请查看:
- 详细文档: `docs/reports/后端权限改造完成报告.md`
- API文档: `http://localhost:8080/swagger-ui.html`
- 日志文件: `backend/logs/smartcare.log`

---

**最后更新**: 2025-10-29  
**版本**: v1.0.0
