# 单元测试开发指南

## 📋 测试框架

### 后端测试 (Java)
- **JUnit 5** - 测试框架
- **Mockito** - Mock框架
- **Spring Boot Test** - Spring集成测试
- **H2** - 内存数据库(可选)

### 前端测试 (Vue)
- **Vitest** - 测试运行器
- **Vue Test Utils** - Vue组件测试工具
- **@testing-library/vue** - DOM测试工具(可选)

---

## 🧪 后端Service层单元测试

### 测试模板

```java
package com.smartcare.cloud.service;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

/**
 * XXXService 单元测试
 */
@ExtendWith(MockitoExtension.class)
public class XXXServiceTest {

    @Mock
    private XXXMapper xxxMapper;  // Mock依赖的Mapper

    @InjectMocks
    private XXXServiceImpl xxxService;  // 被测试的Service实现类

    private XXX testData;  // 测试数据

    @BeforeEach
    void setUp() {
        // 初始化测试数据
        testData = new XXX();
        testData.setId(1L);
        // ... 设置其他字段
    }

    @Test
    void testGetById_Success() {
        // Given - 准备测试数据
        Long id = 1L;
        when(xxxMapper.selectById(id)).thenReturn(testData);

        // When - 执行测试方法
        XXX result = xxxService.getById(id);

        // Then - 验证结果
        assertNotNull(result);
        assertEquals(testData.getId(), result.getId());
        verify(xxxMapper, times(1)).selectById(id);
    }

    @Test
    void testGetById_NotFound() {
        // Given
        Long id = 999L;
        when(xxxMapper.selectById(id)).thenReturn(null);

        // When
        XXX result = xxxService.getById(id);

        // Then
        assertNull(result);
        verify(xxxMapper, times(1)).selectById(id);
    }

    @Test
    void testSave_Success() {
        // Given
        when(xxxMapper.insert(any(XXX.class))).thenReturn(1);

        // When
        boolean result = xxxService.save(testData);

        // Then
        assertTrue(result);
        verify(xxxMapper, times(1)).insert(testData);
    }

    @Test
    void testUpdate_Success() {
        // Given
        when(xxxMapper.updateById(any(XXX.class))).thenReturn(1);

        // When
        boolean result = xxxService.updateById(testData);

        // Then
        assertTrue(result);
        verify(xxxMapper, times(1)).updateById(testData);
    }

    @Test
    void testDelete_Success() {
        // Given
        Long id = 1L;
        when(xxxMapper.deleteById(id)).thenReturn(1);

        // When
        boolean result = xxxService.removeById(id);

        // Then
        assertTrue(result);
        verify(xxxMapper, times(1)).deleteById(id);
    }
}
```

---

## 📝 ElderlyService测试示例

### 创建测试文件
`backend/src/test/java/com/smartcare/cloud/service/ElderlyServiceTest.java`

```java
package com.smartcare.cloud.service;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

import java.util.Arrays;
import java.util.List;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.smartcare.cloud.dto.ElderlyPageDTO;
import com.smartcare.cloud.entity.Elderly;
import com.smartcare.cloud.mapper.ElderlyMapper;
import com.smartcare.cloud.service.impl.ElderlyServiceImpl;

/**
 * 老人服务单元测试
 */
@ExtendWith(MockitoExtension.class)
@DisplayName("老人服务单元测试")
public class ElderlyServiceTest {

    @Mock
    private ElderlyMapper elderlyMapper;

    @InjectMocks
    private ElderlyServiceImpl elderlyService;

    private Elderly testElderly;

    @BeforeEach
    void setUp() {
        testElderly = new Elderly();
        testElderly.setId(1L);
        testElderly.setName("张三");
        testElderly.setGender(1);
        testElderly.setAge(75);
        testElderly.setIdCard("110101195001011234");
        testElderly.setPhone("13800138000");
        testElderly.setHealthStatus("HEALTHY");
    }

    @Test
    @DisplayName("根据ID查询老人 - 成功")
    void testGetById_Success() {
        // Given
        when(elderlyMapper.selectById(1L)).thenReturn(testElderly);

        // When
        Elderly result = elderlyService.getById(1L);

        // Then
        assertNotNull(result);
        assertEquals("张三", result.getName());
        assertEquals(75, result.getAge());
        verify(elderlyMapper, times(1)).selectById(1L);
    }

    @Test
    @DisplayName("根据ID查询老人 - 不存在")
    void testGetById_NotFound() {
        // Given
        when(elderlyMapper.selectById(999L)).thenReturn(null);

        // When
        Elderly result = elderlyService.getById(999L);

        // Then
        assertNull(result);
        verify(elderlyMapper, times(1)).selectById(999L);
    }

    @Test
    @DisplayName("保存老人信息 - 成功")
    void testSave_Success() {
        // Given
        when(elderlyMapper.insert(any(Elderly.class))).thenReturn(1);

        // When
        boolean result = elderlyService.save(testElderly);

        // Then
        assertTrue(result);
        verify(elderlyMapper, times(1)).insert(testElderly);
    }

    @Test
    @DisplayName("更新老人信息 - 成功")
    void testUpdate_Success() {
        // Given
        when(elderlyMapper.updateById(any(Elderly.class))).thenReturn(1);

        // When
        boolean result = elderlyService.updateById(testElderly);

        // Then
        assertTrue(result);
        verify(elderlyMapper, times(1)).updateById(testElderly);
    }

    @Test
    @DisplayName("删除老人信息 - 成功")
    void testDelete_Success() {
        // Given
        when(elderlyMapper.deleteById(1L)).thenReturn(1);

        // When
        boolean result = elderlyService.removeById(1L);

        // Then
        assertTrue(result);
        verify(elderlyMapper, times(1)).deleteById(1L);
    }

    @Test
    @DisplayName("批量删除老人 - 成功")
    void testBatchDelete_Success() {
        // Given
        List<Long> ids = Arrays.asList(1L, 2L, 3L);
        when(elderlyMapper.deleteBatchIds(ids)).thenReturn(3);

        // When
        boolean result = elderlyService.removeByIds(ids);

        // Then
        assertTrue(result);
        verify(elderlyMapper, times(1)).deleteBatchIds(ids);
    }
}
```

---

## 🎨 前端组件测试

### Vitest配置
`frontend/vitest.config.js`

```javascript
import { defineConfig } from 'vitest/config'
import vue from '@vitejs/plugin-vue'
import path from 'path'

export default defineConfig({
  plugins: [vue()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./tests/setup.js']
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src')
    }
  }
})
```

### 测试设置文件
`frontend/tests/setup.js`

```javascript
import { config } from '@vue/test-utils'
import ElementPlus from 'element-plus'

// 全局配置Vue Test Utils
config.global.plugins = [ElementPlus]
```

### 组件测试示例
`frontend/tests/components/ElderlyList.spec.js`

```javascript
import { describe, it, expect, beforeEach, vi } from 'vitest'
import { mount } from '@vue/test-utils'
import ElderlyList from '@/views/elderly/list.vue'
import ElementPlus from 'element-plus'

describe('ElderlyList.vue', () => {
  let wrapper

  beforeEach(() => {
    // Mock API调用
    vi.mock('@/api/elderly', () => ({
      getElderlyPage: vi.fn(() => Promise.resolve({
        code: 200,
        data: {
          records: [
            { id: 1, name: '张三', age: 75, gender: 1 },
            { id: 2, name: '李四', age: 80, gender: 0 }
          ],
          total: 2
        }
      }))
    }))

    wrapper = mount(ElderlyList, {
      global: {
        plugins: [ElementPlus]
      }
    })
  })

  it('应该正确渲染组件', () => {
    expect(wrapper.exists()).toBe(true)
    expect(wrapper.find('.elderly-management').exists()).toBe(true)
  })

  it('应该显示页面标题', () => {
    expect(wrapper.find('h2').text()).toBe('老人档案管理')
  })

  it('应该包含搜索表单', () => {
    expect(wrapper.find('.search-form').exists()).toBe(true)
    expect(wrapper.find('el-input').exists()).toBe(true)
  })

  it('应该包含操作按钮', () => {
    const buttons = wrapper.findAll('el-button')
    expect(buttons.length).toBeGreaterThan(0)
  })

  it('应该正确处理搜索', async () => {
    const nameInput = wrapper.find('input[placeholder="输入姓名自动搜索"]')
    await nameInput.setValue('张三')
    
    // 等待防抖
    await new Promise(resolve => setTimeout(resolve, 600))
    
    // 验证API被调用
    // expect(getElderlyPage).toHaveBeenCalled()
  })

  it('应该正确显示列表数据', async () => {
    await wrapper.vm.$nextTick()
    
    const table = wrapper.find('el-table')
    expect(table.exists()).toBe(true)
  })
})
```

### 工具函数测试示例
`frontend/tests/utils/request-optimize.spec.js`

```javascript
import { describe, it, expect, beforeEach, vi } from 'vitest'
import { debounce, throttle, createCancelableRequest } from '@/utils/request-optimize'

describe('request-optimize.js', () => {
  describe('debounce', () => {
    it('应该延迟执行函数', async () => {
      const fn = vi.fn()
      const debouncedFn = debounce(fn, 300)

      debouncedFn()
      expect(fn).not.toHaveBeenCalled()

      await new Promise(resolve => setTimeout(resolve, 400))
      expect(fn).toHaveBeenCalledTimes(1)
    })

    it('应该只执行最后一次调用', async () => {
      const fn = vi.fn()
      const debouncedFn = debounce(fn, 300)

      debouncedFn('call1')
      debouncedFn('call2')
      debouncedFn('call3')

      await new Promise(resolve => setTimeout(resolve, 400))
      expect(fn).toHaveBeenCalledTimes(1)
      expect(fn).toHaveBeenCalledWith('call3')
    })
  })

  describe('throttle', () => {
    it('应该限制函数执行频率', async () => {
      const fn = vi.fn()
      const throttledFn = throttle(fn, 1000)

      throttledFn()
      throttledFn()
      throttledFn()

      expect(fn).toHaveBeenCalledTimes(1)

      await new Promise(resolve => setTimeout(resolve, 1100))
      throttledFn()
      expect(fn).toHaveBeenCalledTimes(2)
    })
  })

  describe('createCancelableRequest', () => {
    it('应该创建可取消的请求', () => {
      const { request, cancel } = createCancelableRequest()

      expect(typeof request).toBe('function')
      expect(typeof cancel).toBe('function')
    })

    it('应该能够取消pending请求', async () => {
      const { request, cancel } = createCancelableRequest()
      const mockApi = vi.fn(() => new Promise(resolve => setTimeout(resolve, 1000)))

      const requestPromise = request(mockApi)
      cancel('测试取消')

      await expect(requestPromise).rejects.toThrow()
    })
  })
})
```

---

## 📊 测试覆盖率目标

### 后端测试覆盖率
- **Service层**: ≥ 80%
- **Controller层**: ≥ 60% (基础测试)
- **Util工具类**: ≥ 90%

### 前端测试覆盖率
- **工具函数**: ≥ 90%
- **核心组件**: ≥ 70%
- **页面组件**: ≥ 50%

---

## 🚀 运行测试

### 后端测试
```bash
cd backend

# 运行所有测试
mvn test

# 运行指定测试类
mvn test -Dtest=ElderlyServiceTest

# 生成测试报告
mvn test jacoco:report
```

### 前端测试
```bash
cd frontend

# 安装测试依赖
npm install -D vitest @vue/test-utils jsdom

# 运行测试
npm run test

# 生成覆盖率报告
npm run test:coverage

# 监听模式
npm run test:watch
```

---

## 📋 待补充的测试用例

### 高优先级
- [x] ElderlyServiceTest (已有示例)
- [ ] HealthWarningServiceTest
- [ ] DoctorServiceTest
- [ ] UserAuthServiceTest

### 中优先级
- [ ] FamilyServiceTest
- [ ] EquipmentServiceTest
- [ ] AuditLogServiceTest

### 低优先级
- [ ] FileStorageServiceTest
- [ ] MessagePushServiceTest

---

## 💡 测试最佳实践

### 1. 遵循AAA模式
- **Arrange (准备)**: 设置测试数据和Mock
- **Act (执行)**: 调用被测方法
- **Assert (断言)**: 验证结果

### 2. 测试命名规范
```java
void test<MethodName>_<Scenario>() {
    // 方法名_测试场景
    // 例: testGetById_Success()
}
```

### 3. 使用@DisplayName
```java
@DisplayName("根据ID查询老人 - 成功")
void testGetById_Success() { }
```

### 4. 隔离测试
- 每个测试独立运行
- 不依赖其他测试的结果
- 使用@BeforeEach初始化数据

### 5. Mock外部依赖
- 数据库访问使用Mock
- 外部API调用使用Mock
- 时间相关使用固定值

---

## 📚 参考资料

- [JUnit 5 官方文档](https://junit.org/junit5/docs/current/user-guide/)
- [Mockito 官方文档](https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html)
- [Vitest 官方文档](https://vitest.dev/)
- [Vue Test Utils 官方文档](https://test-utils.vuejs.org/)

---

**创建时间**: 2025年10月28日  
**作者**: GitHub Copilot  
**状态**: 指南完成，待补充测试用例
