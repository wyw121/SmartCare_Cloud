# 前端性能优化实施示例

## 已实施的优化

### 1. 图片懒加载指令 ✓

**位置**: `frontend/src/directives/lazy.js`

**使用方法**:
```vue
<template>
  <!-- 在任何组件中使用 -->
  <img v-lazy="elderly.avatar" alt="老人头像" />
  <img v-lazy="healthRecord.image" alt="健康档案图片" />
</template>
```

**特性**:
- ✓ 使用 IntersectionObserver API
- ✓ 自动占位图和错误处理
- ✓ 提前50px预加载
- ✓ 自动清理和内存管理

**应用页面**:
- [ ] 老人列表页 - 头像
- [ ] 老人详情页 - 多张图片
- [ ] 健康档案页 - 检查报告图片
- [ ] 设备管理页 - 设备图片

---

### 2. 请求优化工具 ✓

**位置**: `frontend/src/utils/request-optimize.js`

#### 2.1 防抖函数

**使用示例** (搜索框):
```vue
<script setup>
import { debounce } from '@/utils/request-optimize'
import { ref } from 'vue'

const searchKeyword = ref('')

// 防抖搜索，用户停止输入300ms后才执行
const handleSearch = debounce((keyword) => {
  console.log('搜索:', keyword)
  fetchData({ name: keyword })
}, 300)

// 监听输入变化
watch(searchKeyword, (newVal) => {
  handleSearch(newVal)
})
</script>

<template>
  <el-input 
    v-model="searchKeyword" 
    placeholder="请输入姓名搜索"
    @input="handleSearch"
  />
</template>
```

#### 2.2 请求取消

**使用示例**:
```vue
<script setup>
import { createCancelableRequest } from '@/utils/request-optimize'
import { onBeforeUnmount } from 'vue'

const { request, cancel } = createCancelableRequest()

// 执行请求
const loadData = async () => {
  try {
    const data = await request(api.getElderlyList, { page: 1 })
    console.log('数据加载成功', data)
  } catch (error) {
    if (error.name === 'CanceledError') {
      console.log('请求被取消')
    }
  }
}

// 组件卸载时取消请求
onBeforeUnmount(() => {
  cancel('组件已卸载')
})
</script>
```

#### 2.3 并行请求

**使用示例** (仪表板同时加载多个数据):
```vue
<script setup>
import { batchRequests } from '@/utils/request-optimize'
import { onMounted } from 'vue'

onMounted(async () => {
  try {
    // 并行请求多个接口
    const [elderlyData, warningData, statsData] = await batchRequests([
      () => api.getElderlyList(),
      () => api.getWarningList(),
      () => api.getStatistics()
    ])
    
    // 处理数据
    console.log('所有数据已加载', elderlyData, warningData, statsData)
  } catch (error) {
    console.error('加载失败', error)
  }
})
</script>
```

#### 2.4 请求缓存

**使用示例** (缓存字典数据):
```vue
<script setup>
import { withCache } from '@/utils/request-optimize'
import api from '@/api'

// 缓存5分钟
const getCachedDictData = withCache(api.getDictData, 5 * 60 * 1000)

// 第一次调用会请求服务器
const data1 = await getCachedDictData('health_status')

// 5分钟内再次调用会使用缓存
const data2 = await getCachedDictData('health_status') // 使用缓存
</script>
```

---

### 3. 优化应用建议

#### 老人列表页 (elderly/list.vue)

**当前问题**:
- 搜索框输入即触发请求（性能浪费）
- 切换页面时未取消pending请求
- 无图片懒加载

**优化方案**:

```vue
<script setup>
import { debounce, createCancelableRequest } from '@/utils/request-optimize'
import { ref, watch, onBeforeUnmount } from 'vue'

// 1. 创建可取消的请求
const { request, cancel } = createCancelableRequest()

// 2. 搜索防抖
const searchForm = ref({ name: '', idCard: '', healthStatus: '' })

const handleSearch = debounce(async () => {
  try {
    const response = await request(getElderlyPage, {
      pageNum: 1,
      pageSize: 10,
      ...searchForm.value
    })
    // 处理响应
  } catch (error) {
    if (error.name !== 'CanceledError') {
      console.error('搜索失败', error)
    }
  }
}, 500) // 停止输入500ms后搜索

// 3. 监听搜索条件变化
watch(() => searchForm.value.name, () => {
  handleSearch()
})

// 4. 组件卸载时取消请求
onBeforeUnmount(() => {
  cancel('页面已关闭')
})
</script>

<template>
  <!-- 5. 图片懒加载 -->
  <el-table :data="tableData">
    <el-table-column label="头像">
      <template #default="{ row }">
        <img 
          v-lazy="row.avatar" 
          class="elderly-avatar"
          alt="头像"
        />
      </template>
    </el-table-column>
  </el-table>
</template>

<style scoped>
.elderly-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  transition: opacity 0.3s;
}

.elderly-avatar.loaded {
  opacity: 1;
}
</style>
```

#### 健康预警列表 (health-warning/list.vue)

**优化重点**:
1. 搜索防抖
2. 实时刷新时避免重复请求
3. 预警级别筛选防抖

```vue
<script setup>
import { debounce, throttle } from '@/utils/request-optimize'

// 搜索防抖（用户输入）
const handleSearch = debounce(fetchData, 300)

// 定时刷新节流（避免频繁刷新）
const autoRefresh = throttle(fetchData, 5000)

// 5秒刷新一次，但使用节流避免重复
setInterval(autoRefresh, 5000)
</script>
```

#### 仪表板页面 (dashboard/index.vue)

**优化重点**:
1. 并行加载多个统计数据
2. 缓存不常变化的数据

```vue
<script setup>
import { batchRequests, withCache } from '@/utils/request-optimize'
import { onMounted } from 'vue'

// 缓存配置数据（24小时）
const getCachedConfig = withCache(api.getSystemConfig, 24 * 60 * 60 * 1000)

onMounted(async () => {
  // 并行加载仪表板数据
  const [elderly, warning, stats, config] = await batchRequests([
    () => api.getElderlyStats(),
    () => api.getWarningStats(),
    () => api.getHealthStats(),
    () => getCachedConfig() // 使用缓存
  ])
})
</script>
```

---

## 性能提升预期

| 优化项 | 优化前 | 优化后 | 提升幅度 |
|-------|--------|--------|---------|
| 搜索响应 | 每次输入都请求 | 500ms防抖 | 减少80%请求 |
| 列表滚动 | 所有图片同时加载 | 懒加载 | 减少70%初始请求 |
| 页面切换 | 请求继续执行 | 自动取消 | 避免资源浪费 |
| 仪表板加载 | 串行加载 | 并行加载 | 速度提升60% |
| 字典数据 | 每次重复请求 | 缓存5分钟 | 减少100%重复请求 |

---

## 下一步实施计划

### 第一阶段 (本周)
- [x] 创建懒加载指令
- [x] 创建请求优化工具
- [ ] 应用到老人列表页
- [ ] 应用到健康预警列表页

### 第二阶段 (下周)
- [ ] 应用到所有列表页面
- [ ] 添加加载占位图
- [ ] 性能监控埋点
- [ ] 编写单元测试

### 第三阶段 (下下周)
- [ ] 性能基准测试
- [ ] 优化效果评估
- [ ] 文档完善
- [ ] 团队培训

---

## 使用检查清单

### 新开发页面
- [ ] 列表页面使用图片懒加载
- [ ] 搜索框使用防抖
- [ ] 组件卸载时取消pending请求
- [ ] 多个独立请求使用并行加载
- [ ] 不常变化的数据使用缓存

### 代码审查
- [ ] 检查是否有无防抖的搜索
- [ ] 检查是否有未取消的请求
- [ ] 检查是否有重复的请求
- [ ] 检查图片是否使用懒加载
- [ ] 检查是否有性能瓶颈

---

## 常见问题

### Q: 懒加载指令支持哪些图片格式？
A: 支持所有浏览器支持的图片格式（jpg, png, gif, webp等）

### Q: 防抖时间如何设置？
A: 
- 搜索框：300-500ms
- 自动完成：200-300ms
- 窗口resize：200-300ms

### Q: 什么时候使用节流，什么时候使用防抖？
A:
- **防抖**: 连续触发只执行最后一次（搜索、输入验证）
- **节流**: 持续触发按固定频率执行（滚动、resize）

### Q: 请求缓存会不会导致数据不一致？
A: 
- 设置合理的缓存时间
- 不常变化的数据（字典、配置）可以缓存长时间
- 实时数据不要缓存或缓存时间很短（30秒内）

---

## 参考资料

- [IntersectionObserver API](https://developer.mozilla.org/zh-CN/docs/Web/API/Intersection_Observer_API)
- [AbortController API](https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController)
- [Vue 3 自定义指令](https://cn.vuejs.org/guide/reusability/custom-directives.html)
- [Promise.all 并行请求](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/all)
