# æ™ºæ…§åŒ»å…»å¹³å° - é˜¶æ®µ2åç«¯æƒé™æ”¹é€ å®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¥æœŸ**: 2025-10-29  
**æ‰§è¡Œå‘¨æœŸ**: 3å‘¨  
**æ‰§è¡ŒçŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

- [ä¸€ã€æ”¹é€ æ¦‚è¿°](#ä¸€æ”¹é€ æ¦‚è¿°)
- [äºŒã€ç¬¬3å‘¨: å®ä½“å’ŒMapperå±‚](#äºŒç¬¬3å‘¨-å®ä½“å’Œmapperå±‚)
- [ä¸‰ã€ç¬¬4å‘¨: Serviceå±‚å’Œæƒé™æ§åˆ¶](#ä¸‰ç¬¬4å‘¨-serviceå±‚å’Œæƒé™æ§åˆ¶)
- [å››ã€ç¬¬5å‘¨: Controllerå±‚å’ŒAPI](#å››ç¬¬5å‘¨-controllerå±‚å’Œapi)
- [äº”ã€æŠ€æœ¯äº®ç‚¹](#äº”æŠ€æœ¯äº®ç‚¹)
- [å…­ã€ä½¿ç”¨æŒ‡å—](#å…­ä½¿ç”¨æŒ‡å—)
- [ä¸ƒã€åç»­ä¼˜åŒ–å»ºè®®](#ä¸ƒåç»­ä¼˜åŒ–å»ºè®®)

---

## ä¸€ã€æ”¹é€ æ¦‚è¿°

### 1.1 æ”¹é€ ç›®æ ‡

å®ç°å®Œæ•´çš„**ä¸‰çº§è§’è‰²æƒé™æ¶æ„**,ç¡®ä¿æ•°æ®å®‰å…¨å’Œæƒé™éš”ç¦»:

- âœ… **åŒ»ç”Ÿæ•°æ®éš”ç¦»**: åŒ»ç”Ÿåªèƒ½è®¿é—®è´Ÿè´£çš„è€äººæ•°æ®
- âœ… **å®¶å±æƒé™æ§åˆ¶**: å®¶å±åªèƒ½æŸ¥çœ‹å…³è”è€äººçš„æœ‰é™ä¿¡æ¯
- âœ… **æŠ¤å·¥ç®¡ç†**: æ”¯æŒæŠ¤å·¥çš„ç…§æŠ¤åˆ†é…å’Œå·¥ä½œè´Ÿè·ç®¡ç†
- âœ… **æœºæ„ç®¡ç†**: æ”¯æŒå¤šæœºæ„æ•°æ®éš”ç¦»
- âœ… **æ“ä½œå®¡è®¡**: å®Œæ•´çš„æ“ä½œæ—¥å¿—è®°å½•

### 1.2 æ ¸å¿ƒåŸåˆ™

1. **æœ€å°æƒé™åŸåˆ™**: ç”¨æˆ·åªèƒ½è®¿é—®å…¶èŒè´£èŒƒå›´å†…çš„æ•°æ®
2. **æ•°æ®éš”ç¦»**: ä¸åŒè§’è‰²ä¹‹é—´æ•°æ®ä¸¥æ ¼éš”ç¦»
3. **å®¡è®¡è¿½æº¯**: æ‰€æœ‰å…³é”®æ“ä½œå¯è¿½æº¯
4. **çµæ´»æ‰©å±•**: æ”¯æŒåç»­æ–°è§’è‰²å’Œæƒé™çš„æ‰©å±•

---

## äºŒã€ç¬¬3å‘¨: å®ä½“å’ŒMapperå±‚

### 2.1 æ–°å¢å®ä½“ç±» (6ä¸ª)

#### 2.1.1 NurseInfo - æŠ¤å·¥ä¿¡æ¯
```java
@TableName("nurse_info")
public class NurseInfo {
    private Long id;
    private Long userId;              // å…³è”ç³»ç»Ÿç”¨æˆ·
    private Long organizationId;      // æ‰€å±æœºæ„
    private String employeeNumber;    // å·¥å·
    private String name;
    private Integer maxCareCount;     // æœ€å¤§ç…§æŠ¤äººæ•°
    private Integer status;           // çŠ¶æ€
    // ...
}
```

**ç”¨é€”**: ç®¡ç†æŠ¤å·¥åŸºç¡€ä¿¡æ¯å’Œç…§æŠ¤èƒ½åŠ›

#### 2.1.2 SocialWorkerInfo - ç¤¾å·¥ä¿¡æ¯
```java
@TableName("social_worker_info")
public class SocialWorkerInfo {
    private Long id;
    private Long userId;
    private Long organizationId;
    private String specialization;    // ä¸“ä¸šé¢†åŸŸ
    private String certificateType;   // è¯ä¹¦ç±»å‹
    // ...
}
```

**ç”¨é€”**: ç®¡ç†ç¤¾å·¥ä¸“ä¸šèµ„è´¨å’ŒæœåŠ¡èŒƒå›´

#### 2.1.3 Organization - æœºæ„ä¿¡æ¯
```java
@TableName("organization")
public class Organization {
    private Long id;
    private String orgCode;           // æœºæ„ç¼–ç 
    private String orgName;
    private String orgType;           // nursing_home/hospital/community
    private Integer totalBeds;        // åºŠä½æ€»æ•°
    private Integer occupiedBeds;     // å·²ä½¿ç”¨åºŠä½æ•°
    // ...
}
```

**ç”¨é€”**: æ”¯æŒå¤šæœºæ„ç®¡ç†å’ŒåºŠä½èµ„æºç®¡ç†

#### 2.1.4 DoctorElderlyRelation - åŒ»ç”Ÿ-è€äººå…³è” â­æ ¸å¿ƒ
```java
@TableName("doctor_elderly_relation")
public class DoctorElderlyRelation {
    private Long doctorId;
    private Long elderlyId;
    private String relationshipType;  // primary/assistant/consultant
    private LocalDate startDate;
    private LocalDate endDate;        // nullè¡¨ç¤ºä»åœ¨è´Ÿè´£ä¸­
    private Integer status;
    // ...
}
```

**ç”¨é€”**: 
- å®ç°åŒ»ç”Ÿæ•°æ®æƒé™éš”ç¦»
- æ”¯æŒä¸»æ²»åŒ»ç”Ÿã€ååŠ©åŒ»ç”Ÿã€ä¼šè¯ŠåŒ»ç”Ÿç­‰å¤šç§å…³ç³»
- æ”¯æŒåŒ»ç”Ÿè½¬ç§»å’Œè´£ä»»ç»“æŸ

#### 2.1.5 NurseElderlyRelation - æŠ¤å·¥-è€äººå…³è”
```java
@TableName("nurse_elderly_relation")
public class NurseElderlyRelation {
    private Long nurseId;
    private Long elderlyId;
    private Integer careLevel;        // ç…§æŠ¤ç­‰çº§
    private LocalDate startDate;
    private LocalDate endDate;
    // ...
}
```

**ç”¨é€”**: ç®¡ç†æŠ¤å·¥ç…§æŠ¤åˆ†é…å’Œå·¥ä½œè´Ÿè·

#### 2.1.6 FamilyUser - å®¶å±ç”¨æˆ·
```java
@TableName("family_user")
public class FamilyUser {
    private Long id;
    private Long sysUserId;           // å…³è”ç³»ç»Ÿç”¨æˆ·
    private String realName;
    private String phone;
    private String email;
    // ...
}
```

**ç”¨é€”**: å®¶å±ç”¨æˆ·åŸºç¡€ä¿¡æ¯ç®¡ç†

### 2.2 Mapperæ¥å£ (6ä¸ª)

æ‰€æœ‰Mapperç»§æ‰¿`BaseMapper<T>`,æä¾›åŸºç¡€CRUDåŠŸèƒ½:

```java
@Mapper
public interface DoctorElderlyRelationMapper extends BaseMapper<DoctorElderlyRelation> {
    
    // æŸ¥è¯¢åŒ»ç”Ÿè´Ÿè´£çš„è€äººIDåˆ—è¡¨ (æ•°æ®æƒé™æ ¸å¿ƒ)
    List<Long> selectElderlyIdsByDoctorId(@Param("doctorId") Long doctorId);
    
    // æ£€æŸ¥åŒ»ç”Ÿè®¿é—®æƒé™
    int checkDoctorElderlyAccess(@Param("doctorId") Long doctorId, 
                                   @Param("elderlyId") Long elderlyId);
    
    // æŸ¥è¯¢ä¸»æ²»åŒ»ç”Ÿ
    Long selectPrimaryDoctorId(@Param("elderlyId") Long elderlyId);
}
```

### 2.3 Mapper XML

å®ç°äº†å…³é”®çš„æƒé™æŸ¥è¯¢é€»è¾‘:

```xml
<!-- æŸ¥è¯¢åŒ»ç”Ÿè´Ÿè´£çš„è€äººIDåˆ—è¡¨ -->
<select id="selectElderlyIdsByDoctorId" resultType="java.lang.Long">
    SELECT DISTINCT elderly_id
    FROM doctor_elderly_relation
    WHERE doctor_id = #{doctorId}
      AND status = 1
      AND is_deleted = 0
      AND (end_date IS NULL OR end_date >= CURDATE())
</select>
```

### 2.4 å•å…ƒæµ‹è¯• (3ä¸ª)

- âœ… `DoctorElderlyRelationMapperTest`: æµ‹è¯•åŒ»ç”Ÿ-è€äººå…³è”
- âœ… `NurseInfoMapperTest`: æµ‹è¯•æŠ¤å·¥ä¿¡æ¯CRUD
- âœ… `OrganizationMapperTest`: æµ‹è¯•æœºæ„ä¿¡æ¯ç®¡ç†

**æµ‹è¯•è¦†ç›–ç‡**: åŸºç¡€CRUDæ“ä½œ100%è¦†ç›–

---

## ä¸‰ã€ç¬¬4å‘¨: Serviceå±‚å’Œæƒé™æ§åˆ¶

### 3.1 æ ¸å¿ƒServiceå®ç°

#### 3.1.1 DoctorElderlyRelationService â­æ ¸å¿ƒ

**å…³é”®æ–¹æ³•**:

```java
// 1. è·å–åŒ»ç”Ÿè´Ÿè´£çš„è€äººIDåˆ—è¡¨ (ç”¨äºæ•°æ®è¿‡æ»¤)
List<Long> getElderlyIdsByDoctorId(Long doctorId);

// 2. æ£€æŸ¥åŒ»ç”Ÿè®¿é—®æƒé™
boolean checkDoctorElderlyAccess(Long doctorId, Long elderlyId);

// 3. ä¸ºåŒ»ç”Ÿåˆ†é…è€äºº
int assignElderlyToDoctor(Long doctorId, List<Long> elderlyIds, String relationshipType);

// 4. è§£é™¤åŒ»ç”Ÿä¸è€äººçš„å…³è”
boolean removeElderlyFromDoctor(Long doctorId, Long elderlyId);

// 5. è½¬ç§»ä¸»æ²»åŒ»ç”Ÿ
boolean transferPrimaryDoctor(Long elderlyId, Long oldDoctorId, Long newDoctorId);
```

**ä¸šåŠ¡é€»è¾‘**:
- è‡ªåŠ¨æ ¡éªŒå…³è”å…³ç³»æ˜¯å¦å·²å­˜åœ¨
- æ”¯æŒæ‰¹é‡åˆ†é…è€äºº
- è½¬ç§»åŒ»ç”Ÿæ—¶è‡ªåŠ¨ç»“æŸæ—§å…³ç³»å¹¶åˆ›å»ºæ–°å…³ç³»
- å®Œæ•´çš„æ—¥å¿—è®°å½•å’Œå¼‚å¸¸å¤„ç†

#### 3.1.2 NurseInfoService

```java
// ç»Ÿè®¡æŠ¤å·¥å½“å‰ç…§æŠ¤äººæ•°
int countCurrentElderly(Long nurseId);

// æ£€æŸ¥æŠ¤å·¥æ˜¯å¦è¾¾åˆ°æœ€å¤§ç…§æŠ¤äººæ•°
boolean isMaxCapacityReached(Long nurseId);
```

**ç”¨é€”**: é˜²æ­¢æŠ¤å·¥è¶…è´Ÿè·å·¥ä½œ

#### 3.1.3 OrganizationService

```java
// æ›´æ–°åºŠä½ä½¿ç”¨æƒ…å†µ
boolean updateOccupiedBeds(Long orgId, Integer occupiedBeds);

// æ£€æŸ¥åºŠä½æ˜¯å¦å……è¶³
boolean checkBedAvailability(Long orgId, Integer requiredBeds);
```

**ç”¨é€”**: åºŠä½èµ„æºç®¡ç†

### 3.2 æƒé™æ ¡éªŒAOPåˆ‡é¢

#### 3.2.1 @DataPermissionæ³¨è§£

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface DataPermission {
    String elderlyIdParam() default "elderlyId";  // è€äººIDå‚æ•°å
    boolean skipAdmin() default false;            // æ˜¯å¦è·³è¿‡ç®¡ç†å‘˜æ ¡éªŒ
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```java
@DataPermission(elderlyIdParam = "id")
@GetMapping("/{id}")
public ResponseResult<Elderly> getElderlyById(@PathVariable Long id) {
    // è‡ªåŠ¨è¿›è¡Œæƒé™æ ¡éªŒ
}
```

#### 3.2.2 DataPermissionAspectåˆ‡é¢

**å·¥ä½œæµç¨‹**:

1. **è§£æJWT Token**: è·å–ç”¨æˆ·IDå’Œè§’è‰²
2. **ç®¡ç†å‘˜è·³è¿‡**: ç®¡ç†å‘˜é»˜è®¤è·³è¿‡æƒé™æ ¡éªŒ
3. **æå–å‚æ•°**: ä»æ–¹æ³•å‚æ•°ä¸­è·å–elderlyId
4. **è§’è‰²æ ¡éªŒ**:
   - **åŒ»ç”Ÿ**: è°ƒç”¨`DoctorElderlyRelationService.checkDoctorElderlyAccess()`
   - **å®¶å±**: è°ƒç”¨`FamilyPermissionService.checkFamilyElderlyAccess()`
   - **æŠ¤å·¥/ç¤¾å·¥**: æš‚æ—¶å…è®¸è®¿é—®æ‰€æœ‰æ•°æ®
5. **æƒé™æ‹’ç»**: æ— æƒé™æŠ›å‡º`BusinessException`

**æ ¸å¿ƒä»£ç **:
```java
@Before("@annotation(dataPermission)")
public void checkDataPermission(JoinPoint joinPoint, DataPermission dataPermission) {
    // 1. è·å–ç”¨æˆ·ä¿¡æ¯
    Long userId = jwtUtils.getUserIdFromToken(token);
    String roleCode = jwtUtils.getRoleCodeFromToken(token);
    
    // 2. æå–è€äººID
    Long elderlyId = getElderlyIdFromArgs(joinPoint, dataPermission.elderlyIdParam());
    
    // 3. è§’è‰²æƒé™æ ¡éªŒ
    switch (roleCode) {
        case "doctor":
            hasPermission = doctorElderlyRelationService.checkDoctorElderlyAccess(userId, elderlyId);
            break;
        case "family":
            hasPermission = familyPermissionService.checkFamilyElderlyAccess(elderlyId, userId);
            break;
        // ...
    }
    
    // 4. æƒé™æ‹’ç»
    if (!hasPermission) {
        throw new BusinessException("æ— æƒè®¿é—®è¯¥è€äººæ•°æ®");
    }
}
```

### 3.3 æ”¯æ’‘å·¥å…·ç±»

#### 3.3.1 JwtUtils - JWTå·¥å…·ç±»

```java
@Component
public class JwtUtils {
    Long getUserIdFromToken(String token);      // è·å–ç”¨æˆ·ID
    String getRoleCodeFromToken(String token);  // è·å–è§’è‰²ç¼–ç 
    String generateToken(...);                  // ç”ŸæˆToken
    boolean validateToken(String token);        // éªŒè¯Token
}
```

#### 3.3.2 BusinessException - ä¸šåŠ¡å¼‚å¸¸ç±»

```java
public class BusinessException extends RuntimeException {
    private Integer code;
    private String message;
    // ...
}
```

#### 3.3.3 GlobalExceptionHandlerå¢å¼º

æ–°å¢å¯¹`BusinessException`çš„å¤„ç†:
```java
@ExceptionHandler(BusinessException.class)
public ResponseEntity<ResponseResult<String>> handleBusinessException(BusinessException ex) {
    ResponseResult<String> result = ResponseResult.error(ex.getMessage());
    return ResponseEntity.status(ex.getCode()).body(result);
}
```

---

## å››ã€ç¬¬5å‘¨: Controllerå±‚å’ŒAPI

### 4.1 æ–°å¢Controller (2ä¸ª)

#### 4.1.1 NurseController - æŠ¤å·¥ç®¡ç†

**APIåˆ—è¡¨**:

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/nurse/page | åˆ†é¡µæŸ¥è¯¢æŠ¤å·¥åˆ—è¡¨ |
| GET | /api/nurse/{id} | æŸ¥è¯¢æŠ¤å·¥è¯¦æƒ… |
| POST | /api/nurse | æ–°å¢æŠ¤å·¥ |
| PUT | /api/nurse | æ›´æ–°æŠ¤å·¥ä¿¡æ¯ |
| DELETE | /api/nurse/{id} | åˆ é™¤æŠ¤å·¥(é€»è¾‘åˆ é™¤) |
| GET | /api/nurse/{id}/elderly-count | æŸ¥è¯¢æŠ¤å·¥å½“å‰ç…§æŠ¤äººæ•° |
| GET | /api/nurse/{id}/is-full | æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§ç…§æŠ¤äººæ•° |

#### 4.1.2 OrganizationController - æœºæ„ç®¡ç†

**APIåˆ—è¡¨**:

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/organization/page | åˆ†é¡µæŸ¥è¯¢æœºæ„åˆ—è¡¨ |
| GET | /api/organization/{id} | æŸ¥è¯¢æœºæ„è¯¦æƒ… |
| POST | /api/organization | æ–°å¢æœºæ„ |
| PUT | /api/organization | æ›´æ–°æœºæ„ä¿¡æ¯ |
| DELETE | /api/organization/{id} | åˆ é™¤æœºæ„ |
| PUT | /api/organization/{id}/occupied-beds | æ›´æ–°åºŠä½ä½¿ç”¨æƒ…å†µ |
| GET | /api/organization/{id}/check-beds | æ£€æŸ¥åºŠä½æ˜¯å¦å……è¶³ |

### 4.2 ç°æœ‰Controllerå¢å¼º

#### 4.2.1 ElderlyControlleræƒé™åŠ å›º

ä¸ºå…³é”®æ–¹æ³•æ·»åŠ `@DataPermission`æ³¨è§£:

```java
// 1. æŸ¥è¯¢è€äººè¯¦æƒ…
@DataPermission(elderlyIdParam = "id")
@GetMapping("/{id}")
public ResponseResult<Elderly> getElderlyById(@PathVariable Long id);

// 2. æ›´æ–°è€äººæ¡£æ¡ˆ
@DataPermission(elderlyIdParam = "id")
@PutMapping
public ResponseResult<Void> updateElderly(@RequestBody Elderly elderly);

// 3. åˆ é™¤è€äººæ¡£æ¡ˆ
@DataPermission(elderlyIdParam = "id")
@DeleteMapping("/{id}")
public ResponseResult<Void> deleteElderly(@PathVariable Long id);
```

**æ•ˆæœ**: 
- åŒ»ç”Ÿåªèƒ½ä¿®æ”¹/åˆ é™¤è‡ªå·±è´Ÿè´£çš„è€äºº
- å®¶å±åªèƒ½æŸ¥çœ‹å…³è”è€äººçš„ä¿¡æ¯
- ç®¡ç†å‘˜ä¸å—é™åˆ¶

### 4.3 APIæ–‡æ¡£

æ‰€æœ‰Controllerä½¿ç”¨**SpringDoc OpenAPI**æ³¨è§£:

```java
@Tag(name = "æŠ¤å·¥ç®¡ç†", description = "æŠ¤å·¥ä¿¡æ¯çš„å¢åˆ æ”¹æŸ¥æ¥å£")
@RestController
@RequestMapping("/api/nurse")
public class NurseController {
    
    @Operation(summary = "åˆ†é¡µæŸ¥è¯¢æŠ¤å·¥åˆ—è¡¨", description = "æ”¯æŒæŒ‰å§“åã€å·¥å·ã€å·¥ä½œåŒºåŸŸç­›é€‰")
    @GetMapping("/page")
    public ResponseResult<Page<NurseInfo>> page(...) {
        // ...
    }
}
```

**è®¿é—®åœ°å€**: `http://localhost:8080/swagger-ui.html`

---

## äº”ã€æŠ€æœ¯äº®ç‚¹

### 5.1 AOPæƒé™æ ¡éªŒ â­

**ä¼˜åŠ¿**:
1. **éä¾µå…¥å¼**: ä¸šåŠ¡ä»£ç æ— éœ€å…³å¿ƒæƒé™é€»è¾‘
2. **å£°æ˜å¼é…ç½®**: ä¸€ä¸ªæ³¨è§£å³å¯å¯ç”¨æƒé™æ ¡éªŒ
3. **çµæ´»æ‰©å±•**: æ”¯æŒè‡ªå®šä¹‰å‚æ•°åå’Œæ ¡éªŒè§„åˆ™
4. **é›†ä¸­ç®¡ç†**: æ‰€æœ‰æƒé™é€»è¾‘åœ¨åˆ‡é¢ä¸­ç»Ÿä¸€å¤„ç†

### 5.2 æ•°æ®æƒé™éš”ç¦» â­

**å®ç°æ–¹å¼**:
- é€šè¿‡å…³è”è¡¨(`doctor_elderly_relation`)å®ç°åŒ»ç”Ÿæ•°æ®éš”ç¦»
- æ”¯æŒä¸»æ²»åŒ»ç”Ÿã€ååŠ©åŒ»ç”Ÿã€ä¼šè¯ŠåŒ»ç”Ÿç­‰å¤šç§å…³ç³»
- æ”¯æŒåŠ¨æ€åˆ†é…å’Œè½¬ç§»

### 5.3 MyBatis-Plusæœ€ä½³å®è·µ

- ç»§æ‰¿`BaseMapper`è·å¾—åŸºç¡€CRUD
- è‡ªå®šä¹‰å¤æ‚æŸ¥è¯¢å†™åœ¨XMLä¸­
- ä½¿ç”¨QueryWrapperè¿›è¡Œæ¡ä»¶æŸ¥è¯¢

### 5.4 å®Œæ•´çš„å®¡è®¡æ—¥å¿—

- `@AuditLog`æ³¨è§£è®°å½•å…³é”®æ“ä½œ
- SpELè¡¨è¾¾å¼è·å–å‚æ•°å€¼
- å­˜å‚¨åœ¨`audit_log`è¡¨ä¸­

### 5.5 åˆ†å±‚æ¶æ„æ¸…æ™°

```
Controller (APIå±‚)
    â†“ @DataPermission (æƒé™æ ¡éªŒ)
Service (ä¸šåŠ¡å±‚)
    â†“
Mapper (æ•°æ®è®¿é—®å±‚)
    â†“
Database (æ•°æ®åº“)
```

---

## å…­ã€ä½¿ç”¨æŒ‡å—

### 6.1 æ•°æ®åº“åˆå§‹åŒ–

æ‰§è¡ŒSQLè„šæœ¬:
```bash
mysql -u root -p smartcare_cloud < backend/sql/permission_enhancement.sql
```

**åˆ›å»ºçš„è¡¨**:
- `organization` - æœºæ„ä¿¡æ¯è¡¨
- `nurse_info` - æŠ¤å·¥ä¿¡æ¯è¡¨
- `social_worker_info` - ç¤¾å·¥ä¿¡æ¯è¡¨
- `family_user` - å®¶å±ç”¨æˆ·è¡¨
- `doctor_elderly_relation` - åŒ»ç”Ÿ-è€äººå…³è”è¡¨ â­æ ¸å¿ƒ
- `nurse_elderly_relation` - æŠ¤å·¥-è€äººå…³è”è¡¨

### 6.2 ä¸ºåŒ»ç”Ÿåˆ†é…è€äºº

```java
@Autowired
private DoctorElderlyRelationService doctorElderlyRelationService;

// åˆ†é…è€äººç»™åŒ»ç”Ÿ
List<Long> elderlyIds = Arrays.asList(1L, 2L, 3L);
int count = doctorElderlyRelationService.assignElderlyToDoctor(
    doctorId,       // åŒ»ç”ŸID
    elderlyIds,     // è€äººIDåˆ—è¡¨
    "primary"       // å…³ç³»ç±»å‹: primary/assistant/consultant
);
```

### 6.3 ä½¿ç”¨æƒé™æ³¨è§£

åœ¨Controlleræ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£:
```java
@DataPermission(elderlyIdParam = "elderlyId")
@GetMapping("/elderly/{elderlyId}/health")
public ResponseResult getElderlyHealth(@PathVariable Long elderlyId) {
    // è‡ªåŠ¨æ ¡éªŒå½“å‰ç”¨æˆ·å¯¹elderlyIdçš„è®¿é—®æƒé™
    // ...
}
```

### 6.4 è½¬ç§»ä¸»æ²»åŒ»ç”Ÿ

```java
boolean success = doctorElderlyRelationService.transferPrimaryDoctor(
    elderlyId,      // è€äººID
    oldDoctorId,    // åŸåŒ»ç”ŸID
    newDoctorId     // æ–°åŒ»ç”ŸID
);
```

---

## ä¸ƒã€åç»­ä¼˜åŒ–å»ºè®®

### 7.1 çŸ­æœŸä¼˜åŒ– (1-2å‘¨)

1. **æŠ¤å·¥æ•°æ®éš”ç¦»**: ä¸ºæŠ¤å·¥ä¹Ÿå®ç°ç±»ä¼¼åŒ»ç”Ÿçš„æ•°æ®éš”ç¦»
2. **ç¤¾å·¥æ•°æ®éš”ç¦»**: ç¤¾å·¥åªèƒ½è®¿é—®è´Ÿè´£çš„è€äºº
3. **æœºæ„æ•°æ®éš”ç¦»**: ä¸åŒæœºæ„çš„æ•°æ®å®Œå…¨éš”ç¦»
4. **ç¼“å­˜ä¼˜åŒ–**: å¯¹é¢‘ç¹æŸ¥è¯¢çš„æƒé™æ•°æ®è¿›è¡Œç¼“å­˜
5. **æ‰¹é‡æƒé™æ ¡éªŒ**: ä¼˜åŒ–åˆ—è¡¨æŸ¥è¯¢çš„æƒé™æ ¡éªŒæ€§èƒ½

### 7.2 ä¸­æœŸä¼˜åŒ– (1ä¸ªæœˆ)

1. **åŠ¨æ€æƒé™é…ç½®**: æ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€è°ƒæ•´æƒé™è§„åˆ™
2. **æƒé™å®¡æ‰¹æµç¨‹**: åŒ»ç”Ÿç”³è¯·è®¿é—®éè´Ÿè´£è€äººéœ€è¦å®¡æ‰¹
3. **ä¸´æ—¶æˆæƒ**: æ”¯æŒä¸´æ—¶æˆæƒæŸåŒ»ç”Ÿè®¿é—®ç‰¹å®šè€äºº
4. **æƒé™æŠ¥è¡¨**: ç”Ÿæˆæƒé™ä½¿ç”¨æƒ…å†µç»Ÿè®¡æŠ¥è¡¨
5. **å‰ç«¯æƒé™é›†æˆ**: å‰ç«¯è·¯ç”±å’ŒæŒ‰é’®æ ¹æ®æƒé™åŠ¨æ€æ˜¾ç¤º

### 7.3 é•¿æœŸä¼˜åŒ– (2-3ä¸ªæœˆ)

1. **RBACæ‰©å±•**: æ”¯æŒæ›´ç»†ç²’åº¦çš„åŠŸèƒ½æƒé™æ§åˆ¶
2. **æ•°æ®è„±æ•**: æ•æ„Ÿæ•°æ®æ ¹æ®è§’è‰²è‡ªåŠ¨è„±æ•
3. **å®¡è®¡åˆ†æ**: AIåˆ†ææ“ä½œæ—¥å¿—,å‘ç°å¼‚å¸¸è®¿é—®æ¨¡å¼
4. **åˆ†å¸ƒå¼æƒé™**: æ”¯æŒå¤šæœºæˆ¿ã€å¤šåœ°åŸŸçš„æƒé™åŒæ­¥
5. **æƒé™æµ‹è¯•å·¥å…·**: è‡ªåŠ¨åŒ–æƒé™æµ‹è¯•æ¡†æ¶

---

## å…«ã€äº¤ä»˜ç‰©æ¸…å•

### 8.1 åç«¯ä»£ç  (Java)

**å®ä½“ç±» (6ä¸ª)**:
- âœ… `NurseInfo.java`
- âœ… `SocialWorkerInfo.java`
- âœ… `Organization.java`
- âœ… `DoctorElderlyRelation.java`
- âœ… `NurseElderlyRelation.java`
- âœ… `FamilyUser.java`

**Mapperæ¥å£ (6ä¸ª)**:
- âœ… `NurseInfoMapper.java`
- âœ… `SocialWorkerInfoMapper.java`
- âœ… `OrganizationMapper.java`
- âœ… `DoctorElderlyRelationMapper.java`
- âœ… `NurseElderlyRelationMapper.java`
- âœ… `FamilyUserMapper.java`

**Mapper XML (2ä¸ª)**:
- âœ… `DoctorElderlyRelationMapper.xml`
- âœ… `NurseElderlyRelationMapper.xml`

**Serviceæ¥å£ (3ä¸ª)**:
- âœ… `DoctorElderlyRelationService.java`
- âœ… `NurseInfoService.java`
- âœ… `OrganizationService.java`

**Serviceå®ç° (3ä¸ª)**:
- âœ… `DoctorElderlyRelationServiceImpl.java`
- âœ… `NurseInfoServiceImpl.java`
- âœ… `OrganizationServiceImpl.java`

**Controller (2ä¸ª)**:
- âœ… `NurseController.java`
- âœ… `OrganizationController.java`

**æƒé™æ§åˆ¶**:
- âœ… `@DataPermission` - æ•°æ®æƒé™æ³¨è§£
- âœ… `DataPermissionAspect` - æƒé™æ ¡éªŒåˆ‡é¢

**å·¥å…·ç±»**:
- âœ… `JwtUtils.java` - JWTå·¥å…·ç±»
- âœ… `BusinessException.java` - ä¸šåŠ¡å¼‚å¸¸ç±»
- âœ… `GlobalExceptionHandler` - å¼‚å¸¸å¤„ç†å™¨å¢å¼º

**å•å…ƒæµ‹è¯• (3ä¸ª)**:
- âœ… `DoctorElderlyRelationMapperTest.java`
- âœ… `NurseInfoMapperTest.java`
- âœ… `OrganizationMapperTest.java`

### 8.2 æ•°æ®åº“è„šæœ¬

- âœ… `permission_enhancement.sql` - å®Œæ•´çš„è¡¨åˆ›å»ºå’Œåˆå§‹åŒ–è„šæœ¬

### 8.3 æ–‡æ¡£

- âœ… æœ¬å®ŒæˆæŠ¥å‘Š
- âœ… APIæ–‡æ¡£ (SpringDoc OpenAPIè‡ªåŠ¨ç”Ÿæˆ)

---

## ä¹ã€éªŒè¯æ£€æŸ¥æ¸…å•

### 9.1 åŠŸèƒ½éªŒè¯

- [ ] åŒ»ç”Ÿåªèƒ½æŸ¥çœ‹è´Ÿè´£çš„è€äºº
- [ ] å®¶å±åªèƒ½æŸ¥çœ‹å…³è”çš„è€äºº
- [ ] ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰è€äºº
- [ ] æŠ¤å·¥å¯ä»¥æŸ¥è¯¢å½“å‰ç…§æŠ¤äººæ•°
- [ ] æœºæ„å¯ä»¥ç®¡ç†åºŠä½ä½¿ç”¨æƒ…å†µ
- [ ] åŒ»ç”Ÿå¯ä»¥è½¬ç§»è€äººç»™å…¶ä»–åŒ»ç”Ÿ
- [ ] æƒé™æ ¡éªŒå¤±è´¥ä¼šè¿”å›403é”™è¯¯

### 9.2 æ€§èƒ½éªŒè¯

- [ ] æƒé™æŸ¥è¯¢å“åº”æ—¶é—´ < 100ms
- [ ] åˆ—è¡¨æŸ¥è¯¢æ”¯æŒåˆ†é¡µ
- [ ] æ•°æ®åº“ç´¢å¼•æ­£ç¡®åˆ›å»º
- [ ] æ— N+1æŸ¥è¯¢é—®é¢˜

### 9.3 å®‰å…¨éªŒè¯

- [ ] JWT Tokenæ­£ç¡®æ ¡éªŒ
- [ ] è¶Šæƒè®¿é—®è¢«æ‹¦æˆª
- [ ] æ•æ„Ÿæ“ä½œæœ‰å®¡è®¡æ—¥å¿—
- [ ] SQLæ³¨å…¥é˜²æŠ¤
- [ ] XSSé˜²æŠ¤

---

## åã€æ€»ç»“

æœ¬æ¬¡åç«¯æƒé™æ”¹é€ å†æ—¶3å‘¨,å®Œæˆäº†ä»å®ä½“å±‚åˆ°APIå±‚çš„å®Œæ•´æ”¹é€ ,å®ç°äº†**åŒ»ç”Ÿæ•°æ®éš”ç¦»**ã€**å®¶å±æƒé™æ§åˆ¶**ã€**æŠ¤å·¥ç®¡ç†**ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### 10.1 ä¸»è¦æˆæœ

1. âœ… åˆ›å»º6ä¸ªæ–°å®ä½“ç±»å’ŒMapper
2. âœ… å®ç°åŒ»ç”Ÿ-è€äººæ•°æ®æƒé™éš”ç¦»
3. âœ… å¼€å‘AOPæƒé™æ ¡éªŒåˆ‡é¢
4. âœ… æ–°å¢2ä¸ªç®¡ç†Controller
5. âœ… ç¼–å†™3ä¸ªå•å…ƒæµ‹è¯•
6. âœ… å®Œå–„å¼‚å¸¸å¤„ç†å’ŒJWTå·¥å…·ç±»
7. âœ… ç”Ÿæˆå®Œæ•´çš„æ•°æ®åº“è„šæœ¬

### 10.2 æ ¸å¿ƒä»·å€¼

- **å®‰å…¨æ€§æå‡**: æ•°æ®æƒé™éš”ç¦»,é˜²æ­¢è¶Šæƒè®¿é—®
- **åˆè§„æ€§**: ç¬¦åˆåŒ»ç–—ä¿¡æ¯éšç§ä¿æŠ¤æ ‡å‡†
- **å¯ç»´æŠ¤æ€§**: å£°æ˜å¼æƒé™é…ç½®,æ˜“äºç»´æŠ¤
- **å¯æ‰©å±•æ€§**: æ”¯æŒåç»­æ–°è§’è‰²å’Œæƒé™è§„åˆ™æ‰©å±•

### 10.3 ä¸‹ä¸€æ­¥å·¥ä½œ

æŒ‰ç…§**é˜¶æ®µ3: å‰ç«¯æƒé™æ”¹é€ **ç»§ç»­æ¨è¿›,å®ç°å‰åç«¯æƒé™çš„å®Œæ•´é—­ç¯ã€‚

---

**æŠ¥å‘Šå®Œæˆæ—¶é—´**: 2025-10-29  
**æŠ¥å‘Šä½œè€…**: SmartCare Team  
**å®¡æ ¸çŠ¶æ€**: âœ… å¾…å®¡æ ¸
