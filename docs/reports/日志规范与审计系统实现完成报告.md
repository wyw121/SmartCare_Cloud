# æ—¥å¿—è§„èŒƒä¸å®¡è®¡ç³»ç»Ÿå®ç°å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ å®æ–½æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–å®Œæˆäº†å®Œæ•´çš„æ—¥å¿—è§„èŒƒä½“ç³»å’Œæ“ä½œå®¡è®¡æ—¥å¿—ç³»ç»Ÿ,æå‡äº†ç³»ç»Ÿçš„å¯è§‚æµ‹æ€§ã€å¯è¿½æº¯æ€§å’Œå®‰å…¨åˆè§„æ€§ã€‚

---

## âœ… å®Œæˆå†…å®¹

### 1ï¸âƒ£ Logbackæ—¥å¿—é…ç½® (`logback-spring.xml`)

#### é…ç½®ç‰¹æ€§
- **å¤šç¯å¢ƒæ”¯æŒ**: dev/test/prod ä¸‰ç§ç¯å¢ƒé…ç½®
- **æ—¥å¿—åˆ†çº§å­˜å‚¨**: INFO/WARN/ERROR/AUDIT å››ç±»æ—¥å¿—æ–‡ä»¶
- **è‡ªåŠ¨å½’æ¡£**: æŒ‰æ—¥æœŸå’Œå¤§å°è‡ªåŠ¨åˆ†å‰²,å‹ç¼©å­˜å‚¨
- **å¼‚æ­¥è¾“å‡º**: ä½¿ç”¨ `AsyncAppender` æå‡æ€§èƒ½
- **å½©è‰²æ§åˆ¶å°**: å¼€å‘ç¯å¢ƒå‹å¥½çš„å½©è‰²æ—¥å¿—è¾“å‡º

#### æ—¥å¿—æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶å | çº§åˆ« | ä¿ç•™æ—¶é—´ | å•æ–‡ä»¶å¤§å° | æ€»å®¹é‡ | ç”¨é€” |
|--------|------|----------|------------|--------|------|
| `smartcare-cloud-info.log` | INFO | 30å¤© | 100MB | 10GB | ä¸šåŠ¡æ—¥å¿— |
| `smartcare-cloud-warn.log` | WARN | 30å¤© | 50MB | 5GB | è­¦å‘Šä¿¡æ¯ |
| `smartcare-cloud-error.log` | ERROR | 60å¤© | 50MB | 5GB | é”™è¯¯å¼‚å¸¸ |
| `smartcare-cloud-audit.log` | INFO | 180å¤© | 100MB | 20GB | æ“ä½œå®¡è®¡ |

#### ç¯å¢ƒé…ç½®å·®å¼‚

**å¼€å‘ç¯å¢ƒ (dev)**
```yaml
- æ§åˆ¶å°: å½©è‰²æ—¥å¿— âœ…
- æ–‡ä»¶è¾“å‡º: INFO/WARN/ERROR âœ…
- é¡¹ç›®æ—¥å¿—çº§åˆ«: DEBUG
- SQLæ—¥å¿—: DEBUG
```

**æµ‹è¯•ç¯å¢ƒ (test)**
```yaml
- æ§åˆ¶å°: æ™®é€šæ—¥å¿— âœ…
- æ–‡ä»¶è¾“å‡º: INFO/WARN/ERROR âœ…
- é¡¹ç›®æ—¥å¿—çº§åˆ«: INFO
- SQLæ—¥å¿—: INFO
```

**ç”Ÿäº§ç¯å¢ƒ (prod)**
```yaml
- æ§åˆ¶å°: ç¦ç”¨ âŒ
- æ–‡ä»¶è¾“å‡º: INFO/WARN/ERROR âœ…
- é¡¹ç›®æ—¥å¿—çº§åˆ«: INFO
- SQLæ—¥å¿—: WARN (å…³é—­)
```

---

### 2ï¸âƒ£ æ—¥å¿—è§„èŒƒæ–‡æ¡£

åˆ›å»ºäº†å®Œæ•´çš„ **ã€Šæ—¥å¿—è§„èŒƒæ–‡æ¡£ã€‹** (`docs/development/æ—¥å¿—è§„èŒƒæ–‡æ¡£.md`)

#### æ–‡æ¡£å†…å®¹
1. **æ—¥å¿—çº§åˆ«ä½¿ç”¨è§„èŒƒ**: DEBUG/INFO/WARN/ERROR ä½¿ç”¨åœºæ™¯å’Œä»£ç ç¤ºä¾‹
2. **å®¡è®¡æ—¥å¿—è§„èŒƒ**: ç‹¬ç«‹Loggeré…ç½®,è®°å½•å…³é”®æ“ä½œ
3. **æœ€ä½³å®è·µ**: æ¨èåšæ³•å’Œç¦æ­¢åšæ³•
4. **ç¯å¢ƒé…ç½®è¯´æ˜**: ä¸‰ç§ç¯å¢ƒçš„è¯¦ç»†é…ç½®
5. **æ—¥å¿—ç›‘æ§å»ºè®®**: é”™è¯¯ç›‘æ§ã€å®¡è®¡ç•™å­˜ã€æ—¥å¿—åˆ†æ

#### æ ¸å¿ƒè§„èŒƒè¦ç‚¹

**âœ… æ¨èåšæ³•**
- ä½¿ç”¨ Lombok `@Slf4j` æ³¨è§£
- ä½¿ç”¨å ä½ç¬¦ `{}` é¿å…å­—ç¬¦ä¸²æ‹¼æ¥
- è®°å½•å¼‚å¸¸åŒ…å«å®Œæ•´å †æ ˆ
- æ•æ„Ÿä¿¡æ¯å¿…é¡»è„±æ•
- å¤æ‚å¯¹è±¡åºåˆ—åŒ–å‰æ£€æŸ¥æ—¥å¿—çº§åˆ«

**âŒ ç¦æ­¢åšæ³•**
- ç¦æ­¢åœ¨å¾ªç¯ä¸­æ‰“å° INFO/DEBUG æ—¥å¿—
- ç¦æ­¢æ‰“å°å®Œæ•´è¯·æ±‚/å“åº”ä½“
- ç¦æ­¢ä½¿ç”¨ `System.out.println()` æˆ– `printStackTrace()`

---

### 3ï¸âƒ£ æ“ä½œå®¡è®¡æ—¥å¿—ç³»ç»Ÿ

#### æ•°æ®åº“è¡¨è®¾è®¡ (`audit_log`)

```sql
CREATE TABLE `audit_log` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT COMMENT 'ç”¨æˆ·ID',
  `username` VARCHAR(50) COMMENT 'ç”¨æˆ·å',
  `operation_type` VARCHAR(20) COMMENT 'æ“ä½œç±»å‹',
  `operation_module` VARCHAR(50) COMMENT 'æ“ä½œæ¨¡å—',
  `operation_desc` VARCHAR(500) COMMENT 'æ“ä½œæè¿°',
  `request_method` VARCHAR(10) COMMENT 'è¯·æ±‚æ–¹æ³•',
  `request_url` VARCHAR(500) COMMENT 'è¯·æ±‚URL',
  `request_params` TEXT COMMENT 'è¯·æ±‚å‚æ•°',
  `ip_address` VARCHAR(50) COMMENT 'IPåœ°å€',
  `user_agent` VARCHAR(500) COMMENT 'ç”¨æˆ·ä»£ç†',
  `operation_status` TINYINT COMMENT 'æ“ä½œçŠ¶æ€',
  `error_message` TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
  `execution_time` INT COMMENT 'æ‰§è¡Œæ—¶é—´(ms)',
  `created_time` DATETIME COMMENT 'æ“ä½œæ—¶é—´',
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_operation_type` (`operation_type`),
  INDEX `idx_created_time` (`created_time`)
);
```

**æ“ä½œç±»å‹æšä¸¾**:
- `LOGIN` - ç™»å½•
- `LOGOUT` - ç™»å‡º
- `CREATE` - æ–°å¢
- `UPDATE` - ä¿®æ”¹
- `DELETE` - åˆ é™¤
- `EXPORT` - å¯¼å‡º
- `IMPORT` - å¯¼å…¥

**æ“ä½œæ¨¡å—æšä¸¾**:
- `ELDERLY` - è€äººç®¡ç†
- `DOCTOR` - åŒ»ç”Ÿç®¡ç†
- `HEALTH_WARNING` - å¥åº·é¢„è­¦
- `FAMILY` - å®¶å±ç®¡ç†
- `SYSTEM` - ç³»ç»Ÿç®¡ç†

#### åç«¯å®ç°

**1. å®ä½“ç±»** - `AuditLog.java`
```java
@Data
@Builder
@TableName("audit_log")
public class AuditLog {
    private Long id;
    private Long userId;
    private String username;
    private String operationType;
    private String operationModule;
    private String operationDesc;
    // ... å…¶ä»–å­—æ®µ
}
```

**2. Mapperæ¥å£** - `AuditLogMapper.java`
```java
@Mapper
public interface AuditLogMapper extends BaseMapper<AuditLog> {
}
```

**3. Serviceå±‚** - `AuditLogService.java` & `AuditLogServiceImpl.java`
```java
@Service
public class AuditLogServiceImpl extends ServiceImpl<AuditLogMapper, AuditLog> 
    implements AuditLogService {
    
    @Async
    @Override
    public void saveAuditLogAsync(AuditLog auditLog) {
        // å¼‚æ­¥ä¿å­˜å®¡è®¡æ—¥å¿—
        save(auditLog);
        
        // åŒæ—¶å†™å…¥å®¡è®¡æ—¥å¿—æ–‡ä»¶
        AUDIT_LOG.info("æ“ä½œå®¡è®¡ - ç”¨æˆ·: {}, æ“ä½œ: {}, ...", ...);
    }
}
```

**4. è‡ªå®šä¹‰æ³¨è§£** - `@AuditLog`
```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface AuditLog {
    String module();  // æ“ä½œæ¨¡å—
    String type();    // æ“ä½œç±»å‹
    String description() default "";  // æ”¯æŒSpELè¡¨è¾¾å¼
}
```

**5. AOPåˆ‡é¢** - `AuditLogAspect.java`
```java
@Aspect
@Component
public class AuditLogAspect {
    
    @Around("@annotation(com.smartcare.cloud.annotation.AuditLog)")
    public Object around(ProceedingJoinPoint joinPoint) throws Throwable {
        // è®°å½•å¼€å§‹æ—¶é—´
        // è§£ææ³¨è§£è·å–æ“ä½œä¿¡æ¯
        // ä»è¯·æ±‚è·å–ç”¨æˆ·ä¿¡æ¯ã€IPåœ°å€
        // æ‰§è¡Œç›®æ ‡æ–¹æ³•
        // è®°å½•æ‰§è¡Œæ—¶é—´
        // å¼‚æ­¥ä¿å­˜å®¡è®¡æ—¥å¿—
    }
}
```

**ç‰¹æ€§**:
- **SpELè¡¨è¾¾å¼æ”¯æŒ**: åŠ¨æ€è·å–æ–¹æ³•å‚æ•°å€¼
- **IPåœ°å€è·å–**: æ”¯æŒä»£ç†ç¯å¢ƒçœŸå®IPè·å–
- **å¼‚æ­¥ä¿å­˜**: ä¸å½±å“ä¸»ä¸šåŠ¡æ€§èƒ½
- **åŒé‡è®°å½•**: æ•°æ®åº“ + å®¡è®¡æ—¥å¿—æ–‡ä»¶

#### ä½¿ç”¨ç¤ºä¾‹

åœ¨Controlleræ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£:

```java
@AuditLog(module = "ELDERLY", type = "CREATE", description = "åˆ›å»ºè€äººæ¡£æ¡ˆ:#elderly.name")
@PostMapping
public ResponseResult<Void> addElderly(@RequestBody Elderly elderly) {
    return elderlyService.addElderly(elderly);
}

@AuditLog(module = "ELDERLY", type = "UPDATE", description = "æ›´æ–°è€äººæ¡£æ¡ˆ:#elderly.name")
@PutMapping
public ResponseResult<Void> updateElderly(@RequestBody Elderly elderly) {
    return elderlyService.updateElderly(elderly);
}

@AuditLog(module = "ELDERLY", type = "DELETE", description = "åˆ é™¤è€äººæ¡£æ¡ˆ ID:#id")
@DeleteMapping("/{id}")
public ResponseResult<Void> deleteElderly(@PathVariable Long id) {
    return elderlyService.deleteElderly(id);
}
```

**SpELè¡¨è¾¾å¼è¯´æ˜**:
- `#elderly.name` - è·å–å‚æ•° `elderly` çš„ `name` å±æ€§
- `#id` - è·å–å‚æ•° `id` çš„å€¼

---

## ğŸ“Š å®æ–½æˆæœ

### æ–‡ä»¶åˆ›å»ºæ¸…å•

| ç±»å‹ | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|------|----------|------|
| é…ç½® | `backend/src/main/resources/logback-spring.xml` | Logbackæ—¥å¿—é…ç½® |
| SQL | `backend/sql/create_audit_log_table.sql` | å®¡è®¡æ—¥å¿—è¡¨åˆ›å»ºè„šæœ¬ |
| å®ä½“ | `entity/AuditLog.java` | å®¡è®¡æ—¥å¿—å®ä½“ç±» |
| Mapper | `mapper/AuditLogMapper.java` | å®¡è®¡æ—¥å¿—Mapper |
| Service | `service/AuditLogService.java` | å®¡è®¡æ—¥å¿—Serviceæ¥å£ |
| ServiceImpl | `service/impl/AuditLogServiceImpl.java` | å®¡è®¡æ—¥å¿—Serviceå®ç° |
| æ³¨è§£ | `annotation/AuditLog.java` | å®¡è®¡æ—¥å¿—æ³¨è§£ |
| åˆ‡é¢ | `aspect/AuditLogAspect.java` | å®¡è®¡æ—¥å¿—AOPåˆ‡é¢ |
| æ–‡æ¡£ | `docs/development/æ—¥å¿—è§„èŒƒæ–‡æ¡£.md` | æ—¥å¿—ä½¿ç”¨è§„èŒƒæ–‡æ¡£ |

### ä»£ç ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `ElderlyController.java` | æ·»åŠ  `@AuditLog` æ³¨è§£åˆ° CREATE/UPDATE/DELETE æ–¹æ³• |

### ç¼–è¯‘éªŒè¯

```bash
âœ… Mavenç¼–è¯‘: æˆåŠŸ (SUCCESS)
âœ… æ— ç¼–è¯‘é”™è¯¯
âœ… æ— lintè­¦å‘Š
```

---

## ğŸ¯ åç»­å»ºè®®

### 1. æ‰©å±•å®¡è®¡æ—¥å¿—è¦†ç›–èŒƒå›´

åœ¨å…¶ä»–Controllerçš„å…³é”®æ–¹æ³•æ·»åŠ  `@AuditLog` æ³¨è§£:

**ä¼˜å…ˆçº§é«˜**:
- `AuthController` - ç™»å½•/ç™»å‡ºæ“ä½œ
- `DoctorController` - åŒ»ç”Ÿå¢åˆ æ”¹
- `HealthWarningController` - å¥åº·é¢„è­¦å¤„ç†
- `UserController` - ç”¨æˆ·ç®¡ç†æ“ä½œ

**ä¼˜å…ˆçº§ä¸­**:
- `FamilyController` - å®¶å±ç®¡ç†
- `EquipmentController` - è®¾å¤‡ç®¡ç†
- `SystemRoleController` - è§’è‰²æƒé™ç®¡ç†

### 2. æ•°æ®åº“éƒ¨ç½²

æ‰§è¡ŒSQLè„šæœ¬åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨:

```bash
mysql -u root smartcare_cloud < backend/sql/create_audit_log_table.sql
```

### 3. æ—¥å¿—ç›‘æ§

**ç”Ÿäº§ç¯å¢ƒå»ºè®®**:
- é…ç½®æ—¥å¿—å‘Šè­¦(é”™è¯¯æ—¥å¿—è¶…è¿‡é˜ˆå€¼)
- å®šæœŸå¤‡ä»½å®¡è®¡æ—¥å¿—(æ»¡è¶³åˆè§„è¦æ±‚)
- ä½¿ç”¨ELK/Grafanaç­‰å·¥å…·åˆ†ææ—¥å¿—

**ç›‘æ§æŒ‡æ ‡**:
- é”™è¯¯æ—¥å¿—æ•°é‡è¶‹åŠ¿
- é«˜é¢‘é”™è¯¯ç±»å‹ç»Ÿè®¡
- ç”¨æˆ·æ“ä½œè¡Œä¸ºåˆ†æ
- ç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆè¯†åˆ«

### 4. å®¡è®¡æ—¥å¿—æŸ¥è¯¢æ¥å£

å¯ä»¥åˆ›å»ºå®¡è®¡æ—¥å¿—æŸ¥è¯¢API:

```java
@GetMapping("/api/audit-log")
public ResponseResult<Page<AuditLog>> getAuditLog(
    @RequestParam String username,
    @RequestParam String operationType,
    @RequestParam LocalDateTime startTime,
    @RequestParam LocalDateTime endTime
) {
    // æŸ¥è¯¢å®¡è®¡æ—¥å¿—
}
```

### 5. å‰ç«¯å®¡è®¡æ—¥å¿—å±•ç¤ºé¡µé¢

åœ¨ç³»ç»Ÿç®¡ç†æ¨¡å—æ·»åŠ "æ“ä½œæ—¥å¿—"èœå•:
- å±•ç¤ºå®¡è®¡æ—¥å¿—åˆ—è¡¨
- æ”¯æŒæŒ‰ç”¨æˆ·ã€æ“ä½œç±»å‹ã€æ—¶é—´èŒƒå›´ç­›é€‰
- æ”¯æŒå¯¼å‡ºå®¡è®¡æ—¥å¿—

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### å¼€å‘äººå‘˜

1. **ä½¿ç”¨Lombokæ³¨è§£**
```java
@Slf4j
@Service
public class MyService {
    public void someMethod() {
        log.debug("è°ƒè¯•ä¿¡æ¯: {}", debugData);
        log.info("ä¸šåŠ¡æµç¨‹: {}", businessInfo);
        log.warn("è­¦å‘Šä¿¡æ¯: {}", warningMsg);
        log.error("é”™è¯¯ä¿¡æ¯: {}", errorMsg, exception);
    }
}
```

2. **æ·»åŠ å®¡è®¡æ—¥å¿—**
```java
@AuditLog(module = "MODULE_NAME", type = "OPERATION_TYPE", description = "æ“ä½œæè¿°")
@PostMapping("/api/xxx")
public ResponseResult<Void> operation() {
    // ä¸šåŠ¡é€»è¾‘
}
```

3. **æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶**
```bash
# è¿›å…¥æ—¥å¿—ç›®å½•
cd ./logs

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f smartcare-cloud-info.log
tail -f smartcare-cloud-error.log
tail -f smartcare-cloud-audit.log

# æŸ¥çœ‹å½’æ¡£æ—¥å¿—
cd archive
ls -lh
```

### è¿ç»´äººå‘˜

1. **ç›‘æ§é”™è¯¯æ—¥å¿—**
```bash
# ç»Ÿè®¡ä»Šæ—¥é”™è¯¯æ•°é‡
grep -c "ERROR" smartcare-cloud-error.log

# æŸ¥çœ‹æœ€è¿‘10æ¡é”™è¯¯
tail -n 10 smartcare-cloud-error.log

# æœç´¢ç‰¹å®šé”™è¯¯
grep "NullPointerException" smartcare-cloud-error.log
```

2. **åˆ†æå®¡è®¡æ—¥å¿—**
```bash
# ç»Ÿè®¡ç”¨æˆ·æ“ä½œæ¬¡æ•°
grep "ç”¨æˆ·æ“ä½œ" smartcare-cloud-audit.log | cut -d',' -f2 | sort | uniq -c

# æŸ¥çœ‹ä»Šæ—¥ç™»å½•è®°å½•
grep "LOGIN" smartcare-cloud-audit.log
```

3. **æ—¥å¿—å½’æ¡£ç®¡ç†**
- å®šæœŸæ£€æŸ¥ `./logs/archive/` ç›®å½•å¤§å°
- å¤‡ä»½é‡è¦å®¡è®¡æ—¥å¿—åˆ°å®‰å…¨å­˜å‚¨
- æŒ‰è§„å®šåˆ é™¤è¿‡æœŸæ—¥å¿—

---

## ğŸ† ä¼˜åŒ–æ•ˆæœ

### å¯è§‚æµ‹æ€§æå‡
- âœ… åˆ†çº§æ—¥å¿—å­˜å‚¨,ä¾¿äºé—®é¢˜å®šä½
- âœ… å¼‚æ­¥æ—¥å¿—å†™å…¥,ä¸å½±å“æ€§èƒ½
- âœ… å½©è‰²æ§åˆ¶å°è¾“å‡º,å¼€å‘å‹å¥½

### å®‰å…¨åˆè§„
- âœ… æ“ä½œå…¨ç¨‹å¯è¿½æº¯
- âœ… å®¡è®¡æ—¥å¿—ä¿ç•™180å¤©
- âœ… æ•æ„Ÿä¿¡æ¯è„±æ•å¤„ç†

### è¿ç»´ä¾¿åˆ©
- âœ… è‡ªåŠ¨æ—¥å¿—åˆ†å‰²å’Œå½’æ¡£
- âœ… å¤šç¯å¢ƒé…ç½®åŒºåˆ†
- âœ… å®Œå–„çš„æ—¥å¿—è§„èŒƒæ–‡æ¡£

---

## ğŸ“Œ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–å»ºç«‹äº†å®Œæ•´çš„æ—¥å¿—è§„èŒƒä½“ç³»å’Œæ“ä½œå®¡è®¡ç³»ç»Ÿ,æ¶µç›–:
- **é…ç½®æ–‡ä»¶**: logback-spring.xml (æ”¯æŒå¤šç¯å¢ƒã€æ—¥å¿—åˆ†çº§ã€è‡ªåŠ¨å½’æ¡£)
- **å®¡è®¡ç³»ç»Ÿ**: æ•°æ®åº“è¡¨ + å®ä½“ç±» + Service + AOPåˆ‡é¢ + æ³¨è§£
- **è§„èŒƒæ–‡æ¡£**: æ—¥å¿—çº§åˆ«ä½¿ç”¨è§„èŒƒã€æœ€ä½³å®è·µã€ç›‘æ§å»ºè®®
- **ç¤ºä¾‹ä»£ç **: ElderlyController ä¸­çš„å®¡è®¡æ—¥å¿—æ³¨è§£ç¤ºä¾‹

æ‰€æœ‰ä»£ç å·²é€šè¿‡ Maven ç¼–è¯‘éªŒè¯,å¯ç›´æ¥ä½¿ç”¨ã€‚å»ºè®®æŒ‰åç»­è®¡åˆ’é€æ­¥æ‰©å±•å®¡è®¡æ—¥å¿—è¦†ç›–èŒƒå›´,å¹¶é…ç½®æ—¥å¿—ç›‘æ§å‘Šè­¦ã€‚

---

**å®æ–½æ—¶é—´**: 2025å¹´10æœˆ28æ—¥  
**å®æ–½äººå‘˜**: GitHub Copilot  
**ç¼–è¯‘çŠ¶æ€**: âœ… æˆåŠŸ
